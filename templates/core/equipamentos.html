{% extends "base.html" %}

{% block title %}Equipamentos | ERP TI{% endblock %}

{% block content %}
<style data-equipamentos-responsive>
    .equipments-table-wrap {
        overflow: auto;
        border: 1px solid #1f2a44;
        border-radius: 10px;
        background: #0c1527;
        max-height: 62vh;
    }
    .equipments-table-wrap .data-table {
        border: 0;
        min-width: 1500px;
        margin: 0;
        border-collapse: separate;
        border-spacing: 0;
        overflow: visible;
        border-radius: 0;
    }
    .equipments-table-wrap thead {
        position: sticky;
        top: 0;
        z-index: 4;
    }
    .equipments-table-wrap thead th {
        position: sticky;
        top: 0;
        z-index: 5;
        background: #14304f;
        box-shadow: inset 0 -1px 0 rgba(255,255,255,0.06);
        background-clip: padding-box;
    }
    .equipments-table-wrap.is-compact .data-table th,
    .equipments-table-wrap.is-compact .data-table td {
        padding: 8px 9px;
        font-size: 0.82rem;
    }
    .equipments-table-wrap.is-wide .data-table th,
    .equipments-table-wrap.is-wide .data-table td {
        padding: 11px 12px;
    }
    .equipments-table-wrap .data-table tbody tr[data-row-edit-equipment] {
        cursor: pointer;
    }
    .equipments-table-wrap .data-table tbody tr[data-row-edit-equipment]:hover {
        outline: 1px solid rgba(59, 130, 246, 0.35);
        outline-offset: -1px;
    }
    .equipments-table-wrap .col-serial,
    .equipments-table-wrap .col-memory {
        width: 110px;
        max-width: 110px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .equipments-table-wrap .col-serial {
        width: 140px;
        max-width: 140px;
    }
    .equipments-table-wrap.is-compact .col-serial {
        width: 120px;
        max-width: 120px;
    }
    .equipments-table-wrap.is-compact .col-memory {
        width: 90px;
        max-width: 90px;
    }
</style>
<div class="card">
    <div class="topbar">
        <div>
            <h2>Equipamentos</h2>
            {% if is_ti_group %}
            <p class="muted">Cadastro e inventário de equipamentos.</p>
            {% else %}
            <p class="muted">Seu usuário não está no departamento TI.</p>
            {% endif %}
        </div>
        <form method="post" action="{% url 'logout' %}" class="inline-form">
            {% csrf_token %}
            <button type="submit">Sair</button>
        </form>
    </div>

    {% if is_ti_group %}
        {% include "core/_tabs.html" %}
        <div class="topbar" style="margin-top: 16px;">
            <div>
                <h3 style="margin-bottom: 4px;">Lista de equipamentos</h3>
                <div class="muted" style="font-size: 0.86rem;">
                    Quantidade: <strong data-equipment-count-visible>{{ equipment_total_count }}</strong>
                    de <strong data-equipment-count-total>{{ equipment_total_count }}</strong>
                </div>
            </div>
            <button type="button" data-open-equipment>Adicionar novo</button>
        </div>
        <div class="topbar" style="margin-bottom: 10px;">
            <input
                type="text"
                class="table-search"
                placeholder="Pesquisar por host, usuário, setor ou modelo..."
                data-table-search="equipamentos"
            />
        </div>

        <div class="card" style="padding: 14px; margin-bottom: 12px; border: 1px solid #43331a; background: #121826;">
            <div class="topbar" style="margin-bottom: 8px; align-items: flex-start;">
                <div>
                    <h3 style="margin: 0 0 4px; font-size: 1rem;">Conciliacao de inventario (pendentes)</h3>
                    <div class="muted" style="font-size: 0.85rem;">Vincule maquinas da GPO a etiqueta correta sem perder historico e softwares.</div>
                </div>
                <div class="muted" style="font-size: 0.86rem;">Pendentes: <strong>{{ equipment_reconciliation_pending|length }}</strong></div>
            </div>
            {% if equipment_reconciliation_pending %}
                <div style="overflow:auto; border:1px solid #2a364f; border-radius:8px;">
                    <table class="data-table" style="min-width: 980px; margin:0; border:0; border-radius:0; overflow:visible;">
                        <thead>
                            <tr>
                                <th>Etiqueta</th>
                                <th>Host (GPO)</th>
                                <th>Serie/BIOS</th>
                                <th>UUID</th>
                                <th>MAC</th>
                                <th>Ult. inventario</th>
                                <th>Vincular a etiqueta</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in equipment_reconciliation_pending %}
                                <tr>
                                    <td>{{ p.tag_code|default:"-" }}</td>
                                    <td>{{ p.hostname|default:"-" }}</td>
                                    <td>{{ p.bios_serial|default:p.serial|default:"-" }}</td>
                                    <td title="{{ p.bios_uuid }}">{{ p.bios_uuid|default:"-" }}</td>
                                    <td title="{{ p.mac_addresses }}">{% if p.mac_addresses %}{{ p.mac_addresses|linebreaksbr }}{% else %}-{% endif %}</td>
                                    <td>{% if p.last_inventory_at %}{{ p.last_inventory_at|date:"d/m/Y H:i" }}{% else %}-{% endif %}</td>
                                    <td>
                                        <form method="post" class="inline-form" data-preserve-equipment-scroll style="display:flex; gap:8px; align-items:center;">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="reconcile_inventory" />
                                            <input type="hidden" name="pending_equipment_id" value="{{ p.id }}" />
                                            <input type="text" name="target_tag_code" value="{{ p.tag_code }}" placeholder="Etiqueta correta" style="width: 120px; margin:0;" />
                                            <button type="submit">Vincular</button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="muted" style="font-size:0.9rem;">Nenhum inventario pendente de conciliacao.</div>
            {% endif %}
        </div>

        <div class="equipments-table-wrap" data-equipment-table-wrap>
            <table class="data-table" data-table-name="equipamentos">
                <thead>
                    <tr>
                        <th>Etiqueta</th>
                        <th>Host</th>
                        <th>Setor</th>
                        <th>Usuário</th>
                        <th>Equipamento</th>
                        <th>Modelo</th>
                        <th>Marca</th>
                        <th>Série</th>
                        <th>Memória</th>
                        <th>Processador</th>
                        <th>Geração</th>
                        <th>HD</th>
                        <th>MOD HD</th>
                        <th>Windows</th>
                        <th>Alimentacao</th>
                        <th>Observacao</th>
                        <th>Últ. inventário</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in equipments %}
                        <tr data-row-edit-equipment
                            data-id="{{ item.id }}"
                            data-tag-code="{{ item.tag_code|default:''|escape }}"
                            data-hostname="{{ item.hostname|default:''|escape }}"
                            data-sector="{{ item.sector|default:''|escape }}"
                            data-user="{{ item.user|default:''|escape }}"
                            data-equipment="{{ item.equipment|default:''|escape }}"
                            data-model="{{ item.model|default:''|escape }}"
                            data-brand="{{ item.brand|default:''|escape }}"
                            data-serial="{{ item.serial|default:''|escape }}"
                            data-memory="{{ item.memory|default:''|escape }}"
                            data-processor="{{ item.processor|default:''|escape }}"
                            data-generation="{{ item.generation|default:''|escape }}"
                            data-hd="{{ item.hd|default:''|escape }}"
                            data-mod-hd="{{ item.mod_hd|default:''|escape }}"
                            data-windows="{{ item.windows|default:''|escape }}"
                            data-alimentacao="{{ item.alimentacao|default:''|escape }}"
                            data-observacao="{{ item.observacao|default:''|escape }}">
                            <td data-sort-value="{{ item.tag_code|default:'' }}">{{ item.tag_code|default:"-" }}</td>
                            <td>{{ item.hostname|default:"-" }}</td>
                            <td>{{ item.sector }}</td>
                            <td>{{ item.user }}</td>
                            <td>{{ item.equipment }}</td>
                            <td>{{ item.model }}</td>
                            <td>{{ item.brand }}</td>
                            <td class="col-serial" title="{{ item.serial }}">{{ item.serial }}</td>
                            <td class="col-memory" title="{{ item.memory }}">{{ item.memory }}</td>
                            <td>{{ item.processor }}</td>
                            <td>{{ item.generation }}</td>
                            <td>{{ item.hd }}</td>
                            <td>{{ item.mod_hd }}</td>
                            <td>{{ item.windows }}</td>
                            <td>{{ item.alimentacao|default:"-" }}</td>
                            <td title="{{ item.observacao }}">{{ item.observacao|default:"-" }}</td>
                            <td>{% if item.last_inventory_at %}{{ item.last_inventory_at|date:"d/m/Y H:i" }}{% else %}-{% endif %}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="17" class="muted">Nenhum equipamento cadastrado.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>Solicite ao administrador a inclusão no departamento <strong>TI</strong>.</p>
    {% endif %}
</div>

{% if is_ti_group %}
    <div class="modal" data-equipment-modal hidden>
        <div class="modal-backdrop" data-close-equipment></div>
        <div class="modal-content">
            <div class="topbar" style="margin-bottom: 8px;">
                <h3 data-equipment-modal-title>Novo equipamento</h3>
                <button type="button" data-close-equipment>Fechar</button>
            </div>
            <form method="post" data-equipment-form data-preserve-equipment-scroll data-next-tag="{{ next_equipment_tag_preview|default:'' }}">
                <input type="hidden" name="action" value="create" data-equipment-action />
                <input type="hidden" name="equipment_id" value="" data-equipment-id />
                {% csrf_token %}
                <div class="form-row">
                    <div>
                        <label>Etiqueta (sequencial)</label>
                        <input id="id_tag_code" name="tag_code" type="hidden" />
                        <div class="muted" data-equipment-tag-display style="margin-top: 6px; padding: 10px 12px; border: 1px solid #334155; border-radius: 8px; background: #0b1324; font-weight: 700; color: #cbd5f5;">{{ next_equipment_tag_preview|default:"-" }}</div>
                    </div>
                    <div>
                        <label for="id_hostname">Host</label>
                        <input id="id_hostname" name="hostname" type="text" />
                    </div>
                    <div>
                        <label for="id_sector">Setor</label>
                        <input id="id_sector" name="sector" type="text" />
                    </div>
                    <div>
                        <label for="id_user">Usuário</label>
                        <input id="id_user" name="user" type="text" />
                    </div>
                    <div>
                        <label for="id_equipment">Equipamento</label>
                        <input id="id_equipment" name="equipment" type="text" />
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="id_model">Modelo</label>
                        <input id="id_model" name="model" type="text" />
                    </div>
                    <div>
                        <label for="id_brand">Marca</label>
                        <input id="id_brand" name="brand" type="text" />
                    </div>
                    <div>
                        <label for="id_serial">Série</label>
                        <input id="id_serial" name="serial" type="text" />
                    </div>
                    <div>
                        <label for="id_memory">Memória</label>
                        <input id="id_memory" name="memory" type="text" />
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="id_processor">Processador</label>
                        <input id="id_processor" name="processor" type="text" />
                    </div>
                    <div>
                        <label for="id_generation">Geração</label>
                        <input id="id_generation" name="generation" type="text" />
                    </div>
                    <div>
                        <label for="id_hd">HD</label>
                        <input id="id_hd" name="hd" type="text" />
                    </div>
                    <div>
                        <label for="id_mod_hd">MOD HD</label>
                        <input id="id_mod_hd" name="mod_hd" type="text" />
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="id_windows">Windows</label>
                        <input id="id_windows" name="windows" type="text" />
                    </div>
                    <div>
                        <label for="id_alimentacao">Alimentacao</label>
                        <input id="id_alimentacao" name="alimentacao" type="text" placeholder="Ex.: Fonte 500W / Carregador 65W" />
                    </div>
                </div>
                <div class="form-row">
                    <div style="grid-column: 1 / -1;">
                        <label for="id_observacao">Observacao</label>
                        <textarea id="id_observacao" name="observacao" rows="3" placeholder="Observacoes do equipamento"></textarea>
                    </div>
                </div>
                <div style="display:flex; justify-content:flex-end; gap:10px; align-items:center; margin-top:8px;">
                    <button type="submit">Salvar</button>
                </div>
            </form>
        </div>
    </div>
{% endif %}

<script>
    (function () {
        const modal = document.querySelector('[data-equipment-modal]');
        const openBtn = document.querySelector('[data-open-equipment]');
        const closeEls = document.querySelectorAll('[data-close-equipment]');
        const forms = Array.from(document.querySelectorAll('form[data-preserve-equipment-scroll]'));
        const modalTitle = document.querySelector('[data-equipment-modal-title]');
        const actionInput = document.querySelector('[data-equipment-action]');
        const equipmentIdInput = document.querySelector('[data-equipment-id]');
        if (!modal || !openBtn || !form) return;

        const fieldMap = {
            tagCode: form.querySelector('[name="tag_code"]'),
            hostname: form.querySelector('[name="hostname"]'),
            sector: form.querySelector('[name="sector"]'),
            user: form.querySelector('[name="user"]'),
            equipment: form.querySelector('[name="equipment"]'),
            model: form.querySelector('[name="model"]'),
            brand: form.querySelector('[name="brand"]'),
            serial: form.querySelector('[name="serial"]'),
            memory: form.querySelector('[name="memory"]'),
            processor: form.querySelector('[name="processor"]'),
            generation: form.querySelector('[name="generation"]'),
            hd: form.querySelector('[name="hd"]'),
            modHd: form.querySelector('[name="mod_hd"]'),
            windows: form.querySelector('[name="windows"]'),
            alimentacao: form.querySelector('[name="alimentacao"]'),
            observacao: form.querySelector('[name="observacao"]'),
        };
        const submitBtn = form.querySelector('button[type="submit"]');
        const tagDisplay = form.querySelector('[data-equipment-tag-display]');
        const nextTagPreview = (form.getAttribute('data-next-tag') || '').trim();

        const open = () => { modal.hidden = false; };
        const close = () => { modal.hidden = true; };
        const resetCreate = () => {
            form.reset();
            if (actionInput) actionInput.value = 'create';
            if (equipmentIdInput) equipmentIdInput.value = '';
            if (modalTitle) modalTitle.textContent = 'Novo equipamento';
            if (submitBtn) submitBtn.textContent = 'Salvar alteracoes';
            if (fieldMap.tagCode) fieldMap.tagCode.value = '';
            if (tagDisplay) tagDisplay.textContent = nextTagPreview || '-';
        };
        const openCreate = () => {
            if (typeof window.__saveEquipamentosScrollState === 'function') window.__saveEquipamentosScrollState();
            resetCreate();
            open();
        };
        const openEdit = (btn) => {
            if (typeof window.__saveEquipamentosScrollState === 'function') window.__saveEquipamentosScrollState();
            resetCreate();
            if (actionInput) actionInput.value = 'update';
            if (equipmentIdInput) equipmentIdInput.value = btn.dataset.id || '';
            if (modalTitle) modalTitle.textContent = 'Editar equipamento';
            if (submitBtn) submitBtn.textContent = 'Salvar alteracoes';
            if (fieldMap.tagCode) fieldMap.tagCode.value = btn.dataset.tagCode || '';
            if (tagDisplay) tagDisplay.textContent = (btn.dataset.tagCode || '-');
            if (fieldMap.hostname) fieldMap.hostname.value = btn.dataset.hostname || '';
            if (fieldMap.sector) fieldMap.sector.value = btn.dataset.sector || '';
            if (fieldMap.user) fieldMap.user.value = btn.dataset.user || '';
            if (fieldMap.equipment) fieldMap.equipment.value = btn.dataset.equipment || '';
            if (fieldMap.model) fieldMap.model.value = btn.dataset.model || '';
            if (fieldMap.brand) fieldMap.brand.value = btn.dataset.brand || '';
            if (fieldMap.serial) fieldMap.serial.value = btn.dataset.serial || '';
            if (fieldMap.memory) fieldMap.memory.value = btn.dataset.memory || '';
            if (fieldMap.processor) fieldMap.processor.value = btn.dataset.processor || '';
            if (fieldMap.generation) fieldMap.generation.value = btn.dataset.generation || '';
            if (fieldMap.hd) fieldMap.hd.value = btn.dataset.hd || '';
            if (fieldMap.modHd) fieldMap.modHd.value = btn.dataset.modHd || '';
            if (fieldMap.windows) fieldMap.windows.value = btn.dataset.windows || '';
            if (fieldMap.alimentacao) fieldMap.alimentacao.value = btn.dataset.alimentacao || '';
            if (fieldMap.observacao) fieldMap.observacao.value = btn.dataset.observacao || '';
            open();
        };

        openBtn.addEventListener('click', openCreate);
        closeEls.forEach((el) => el.addEventListener('click', close));
        document.querySelectorAll('tr[data-row-edit-equipment]').forEach((row) => {
            row.addEventListener('click', (event) => {
                if (event.target.closest('button, a, input, select, textarea, label')) return;
                openEdit(row);
            });
        });
    })();
</script>
<script>
    (function () {
        const form = document.querySelector('[data-equipment-form]');
        const wrap = document.querySelector('[data-equipment-table-wrap]');
        const storageKey = `equipamentos-scroll:${window.location.pathname}`;

        const saveScrollState = () => {
            try {
                const state = {
                    pageX: window.scrollX || 0,
                    pageY: window.scrollY || 0,
                    wrapLeft: wrap ? wrap.scrollLeft : 0,
                    wrapTop: wrap ? wrap.scrollTop : 0,
                    ts: Date.now(),
                };
                sessionStorage.setItem(storageKey, JSON.stringify(state));
            } catch (err) {
                // ignore storage errors
            }
        };

        const restoreScrollState = () => {
            try {
                const raw = sessionStorage.getItem(storageKey);
                if (!raw) return;
                const state = JSON.parse(raw);
                if (!state || typeof state !== 'object') return;
                const apply = () => {
                    if (wrap) {
                        wrap.scrollLeft = Number(state.wrapLeft || 0);
                        wrap.scrollTop = Number(state.wrapTop || 0);
                    }
                    window.scrollTo(Number(state.pageX || 0), Number(state.pageY || 0));
                };
                window.requestAnimationFrame(() => {
                    apply();
                    window.setTimeout(apply, 120);
                });
                sessionStorage.removeItem(storageKey);
            } catch (err) {
                // ignore storage errors
            }
        };

        forms.forEach((form) => form.addEventListener('submit', saveScrollState));
        window.__saveEquipamentosScrollState = saveScrollState;
        window.addEventListener('beforeunload', saveScrollState);
        restoreScrollState();
    })();
</script>
<script>
    (function () {
        const wrap = document.querySelector('[data-equipment-table-wrap]');
        const table = document.querySelector('.data-table[data-table-name="equipamentos"]');
        if (!wrap || !table) return;

        const applyEquipmentViewportLayout = () => {
            const vh = window.innerHeight || 900;
            const vw = window.innerWidth || 1400;
            const rect = wrap.getBoundingClientRect();
            const availableHeight = Math.max(280, vh - rect.top - 22);
            wrap.style.maxHeight = `${availableHeight}px`;

            wrap.classList.toggle('is-compact', vw < 1600);
            wrap.classList.toggle('is-wide', vw >= 1900);

            if (vw < 1280) {
                table.style.minWidth = '1420px';
            } else if (vw < 1680) {
                table.style.minWidth = '1540px';
            } else {
                table.style.minWidth = '1640px';
            }
        };

        applyEquipmentViewportLayout();
        window.addEventListener('resize', applyEquipmentViewportLayout);
        document.addEventListener('tickets-updated', applyEquipmentViewportLayout);
    })();
</script>
<script>
    (function () {
        const visibleEl = document.querySelector('[data-equipment-count-visible]');
        const totalEl = document.querySelector('[data-equipment-count-total]');
        const table = document.querySelector('.data-table[data-table-name="equipamentos"]');
        if (!visibleEl || !totalEl || !table) return;
        const tbody = table.querySelector('tbody');
        if (!tbody) return;

        const countVisible = () => {
            const rows = Array.from(tbody.querySelectorAll('tr')).filter((row) => !row.querySelector('td[colspan]'));
            const visible = rows.filter((row) => row.style.display !== 'none').length;
            visibleEl.textContent = String(visible);
            totalEl.textContent = String(rows.length);
        };

        countVisible();
        document.addEventListener('input', (event) => {
            const target = event.target;
            if (!(target instanceof HTMLInputElement)) return;
            if ((target.getAttribute('data-table-search') || '') !== 'equipamentos') return;
            window.setTimeout(countVisible, 0);
        });
    })();
</script>
{% endblock %}

