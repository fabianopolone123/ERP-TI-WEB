{% extends "base.html" %}

{% block title %}Equipamentos | ERP TI{% endblock %}

{% block content %}
<div class="card">
    <div class="topbar">
        <div>
            <h2>Equipamentos</h2>
            {% if is_ti_group %}
            <p class="muted">Cadastro e inventário de equipamentos.</p>
            {% else %}
            <p class="muted">Seu usuário não está no departamento TI.</p>
            {% endif %}
        </div>
        <form method="post" action="{% url 'logout' %}" class="inline-form">
            {% csrf_token %}
            <button type="submit">Sair</button>
        </form>
    </div>

    {% if is_ti_group %}
        {% include "core/_tabs.html" %}
        <div class="topbar" style="margin-top: 16px;">
            <div>
                <h3 style="margin-bottom: 4px;">Lista de equipamentos</h3>
                <div class="muted" style="font-size: 0.86rem;">
                    Quantidade: <strong data-equipment-count-visible>{{ equipment_total_count }}</strong>
                    de <strong data-equipment-count-total>{{ equipment_total_count }}</strong>
                </div>
            </div>
            <button type="button" data-open-equipment>Adicionar novo</button>
        </div>
        <div class="topbar" style="margin-bottom: 10px;">
            <input
                type="text"
                class="table-search"
                placeholder="Pesquisar por host, usuário, setor ou modelo..."
                data-table-search="equipamentos"
            />
        </div>

        <div style="overflow-x: auto;">
            <table class="data-table" data-table-name="equipamentos">
                <thead>
                    <tr>
                        <th>Etiqueta</th>
                        <th>Host</th>
                        <th>Setor</th>
                        <th>Usuário</th>
                        <th>Equipamento</th>
                        <th>Modelo</th>
                        <th>Marca</th>
                        <th>Série</th>
                        <th>Memória</th>
                        <th>Processador</th>
                        <th>Geração</th>
                        <th>HD</th>
                        <th>MOD HD</th>
                        <th>Windows</th>
                        <th>Últ. inventário</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in equipments %}
                        <tr>
                            <td data-sort-value="{{ item.tag_code|default:'' }}">{{ item.tag_code|default:"-" }}</td>
                            <td>{{ item.hostname|default:"-" }}</td>
                            <td>{{ item.sector }}</td>
                            <td>{{ item.user }}</td>
                            <td>{{ item.equipment }}</td>
                            <td>{{ item.model }}</td>
                            <td>{{ item.brand }}</td>
                            <td>{{ item.serial }}</td>
                            <td>{{ item.memory }}</td>
                            <td>{{ item.processor }}</td>
                            <td>{{ item.generation }}</td>
                            <td>{{ item.hd }}</td>
                            <td>{{ item.mod_hd }}</td>
                            <td>{{ item.windows }}</td>
                            <td>{% if item.last_inventory_at %}{{ item.last_inventory_at|date:"d/m/Y H:i" }}{% else %}-{% endif %}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="15" class="muted">Nenhum equipamento cadastrado.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>Solicite ao administrador a inclusão no departamento <strong>TI</strong>.</p>
    {% endif %}
</div>

{% if is_ti_group %}
    <div class="modal" data-equipment-modal hidden>
        <div class="modal-backdrop" data-close-equipment></div>
        <div class="modal-content">
            <div class="topbar" style="margin-bottom: 8px;">
                <h3>Novo equipamento</h3>
                <button type="button" data-close-equipment>Fechar</button>
            </div>
            <form method="post">
                {% csrf_token %}
                <div class="form-row">
                    <div>
                        <label for="id_tag_code">Etiqueta</label>
                        <input id="id_tag_code" name="tag_code" type="text" placeholder="Ex.: TI-000123" />
                    </div>
                    <div>
                        <label for="id_hostname">Host</label>
                        <input id="id_hostname" name="hostname" type="text" />
                    </div>
                    <div>
                        <label for="id_sector">Setor</label>
                        <input id="id_sector" name="sector" type="text" />
                    </div>
                    <div>
                        <label for="id_user">Usuário</label>
                        <input id="id_user" name="user" type="text" />
                    </div>
                    <div>
                        <label for="id_equipment">Equipamento</label>
                        <input id="id_equipment" name="equipment" type="text" />
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="id_model">Modelo</label>
                        <input id="id_model" name="model" type="text" />
                    </div>
                    <div>
                        <label for="id_brand">Marca</label>
                        <input id="id_brand" name="brand" type="text" />
                    </div>
                    <div>
                        <label for="id_serial">Série</label>
                        <input id="id_serial" name="serial" type="text" />
                    </div>
                    <div>
                        <label for="id_memory">Memória</label>
                        <input id="id_memory" name="memory" type="text" />
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="id_processor">Processador</label>
                        <input id="id_processor" name="processor" type="text" />
                    </div>
                    <div>
                        <label for="id_generation">Geração</label>
                        <input id="id_generation" name="generation" type="text" />
                    </div>
                    <div>
                        <label for="id_hd">HD</label>
                        <input id="id_hd" name="hd" type="text" />
                    </div>
                    <div>
                        <label for="id_mod_hd">MOD HD</label>
                        <input id="id_mod_hd" name="mod_hd" type="text" />
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="id_windows">Windows</label>
                        <input id="id_windows" name="windows" type="text" />
                    </div>
                </div>
                <button type="submit">Salvar</button>
            </form>
        </div>
    </div>
{% endif %}

<script>
    (function () {
        const modal = document.querySelector('[data-equipment-modal]');
        const openBtn = document.querySelector('[data-open-equipment]');
        const closeEls = document.querySelectorAll('[data-close-equipment]');
        if (!modal || !openBtn) return;

        const open = () => { modal.hidden = false; };
        const close = () => { modal.hidden = true; };

        openBtn.addEventListener('click', open);
        closeEls.forEach((el) => el.addEventListener('click', close));
    })();
</script>
<script>
    (function () {
        const visibleEl = document.querySelector('[data-equipment-count-visible]');
        const totalEl = document.querySelector('[data-equipment-count-total]');
        const table = document.querySelector('.data-table[data-table-name="equipamentos"]');
        if (!visibleEl || !totalEl || !table) return;
        const tbody = table.querySelector('tbody');
        if (!tbody) return;

        const countVisible = () => {
            const rows = Array.from(tbody.querySelectorAll('tr')).filter((row) => !row.querySelector('td[colspan]'));
            const visible = rows.filter((row) => row.style.display !== 'none').length;
            visibleEl.textContent = String(visible);
            totalEl.textContent = String(rows.length);
        };

        countVisible();
        document.addEventListener('input', (event) => {
            const target = event.target;
            if (!(target instanceof HTMLInputElement)) return;
            if ((target.getAttribute('data-table-search') || '') !== 'equipamentos') return;
            window.setTimeout(countVisible, 0);
        });
    })();
</script>
{% endblock %}

