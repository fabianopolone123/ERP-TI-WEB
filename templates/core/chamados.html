{% extends "base.html" %}
{% load core_extras %}

{% block title %}Chamados | ERP TI{% endblock %}

{% block content %}
<div class="card">
    <div class="topbar">
        <div>
            <h2>Chamados</h2>
            <p class="muted">Gerencie pendências e atendimentos da equipe de TI.</p>
        </div>
        <form method="post" action="{% url 'logout' %}" class="inline-form">
            {% csrf_token %}
            <button type="submit">Sair</button>
        </form>
    </div>

    {% if is_ti_group %}
        {% include "core/_tabs.html" %}

        <div class="topbar" style="margin-top: 16px;">
            <h3>Chamados</h3>
            <div style="display: flex; gap: 8px; align-items: center;">
                {% if is_ti_group and whatsapp_group %}
                    <button type="button" data-open-whatsapp>
                        WhatsApp
                    </button>
                {% endif %}
                {% if is_ti_group %}
                    <button type="button" data-open-email>
                        E-mail
                    </button>
                {% endif %}
                <button type="button" data-open-modal>Abrir chamado</button>
            </div>
        </div>
        <div class="ticket-legend" style="margin-top: 8px;">
            <strong>Legenda</strong>
            <div style="margin-top: 6px; display: flex; flex-wrap: wrap; gap: 12px;">
                <span><span class="urgency-dot urgency-programada"></span> Programada</span>
                <span><span class="urgency-dot urgency-baixa"></span> Baixa</span>
                <span><span class="urgency-dot urgency-media"></span> Média</span>
                <span><span class="urgency-dot urgency-alta"></span> Alta</span>
                <span><span class="urgency-dot urgency-nao_classificado"></span> Não classificado</span>
            </div>
        </div>

        <div class="kanban" data-board>
            <div class="kanban-column" data-target="pendente">
                <div class="kanban-header">Pendentes</div>
                <div class="kanban-body">
                    {% for ticket in pending_tickets %}
                        <div class="ticket-card" draggable="true" data-ticket-id="{{ ticket.id }}">
                            <div class="ticket-title">
                                <span class="urgency-dot urgency-{{ ticket.urgency }}"></span>
                                #{{ ticket.id }} - {{ ticket.title }}
                            </div>
                            {% if is_ti_group %}
                                <div class="ticket-meta">
                                    {{ ticket_meta|get_item:ticket.id|default:""|get_item:'requester' }}
                                    {% if ticket_meta|get_item:ticket.id|default:""|get_item:'department' %}
                                        - {{ ticket_meta|get_item:ticket.id|default:""|get_item:'department' }}
                                    {% endif %}
                                    {% if ticket_meta|get_item:ticket.id|default:""|get_item:'description' %}
                                        - {{ ticket_meta|get_item:ticket.id|default:""|get_item:'description' }}
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>

            {% for user in ti_users %}
                <div class="kanban-column" data-target="user_{{ user.id }}">
                    <div class="kanban-header">{{ user.full_name }}</div>
                    <div class="kanban-body">
                        {% for ticket in user_tickets|get_item:user.id %}
                            <div class="ticket-card" draggable="true" data-ticket-id="{{ ticket.id }}">
                                <div class="ticket-title">
                                    <span class="urgency-dot urgency-{{ ticket.urgency }}"></span>
                                    #{{ ticket.id }} - {{ ticket.title }}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}

            <div class="kanban-column" data-target="fechado">
                <div class="kanban-header">Fechados</div>
                <div class="kanban-body">
                    {% for ticket in closed_tickets %}
                        <div class="ticket-card" draggable="true" data-ticket-id="{{ ticket.id }}">
                            <div class="ticket-title">
                                <span class="urgency-dot urgency-{{ ticket.urgency }}"></span>
                                #{{ ticket.id }} - {{ ticket.title }}
                            </div>
                            <div class="ticket-meta">
                                {{ ticket_meta|get_item:ticket.id|default:""|get_item:'requester' }}
                                {% if ticket_meta|get_item:ticket.id|default:""|get_item:'department' %}
                                    - {{ ticket_meta|get_item:ticket.id|default:""|get_item:'department' }}
                                {% endif %}
                                {% if ticket_meta|get_item:ticket.id|default:""|get_item:'description' %}
                                    - {{ ticket_meta|get_item:ticket.id|default:""|get_item:'description' }}
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% else %}
        <div class="topbar" style="margin-top: 16px;">
            <h3>Meus chamados</h3>
            <button type="button" data-open-modal>Abrir chamado</button>
        </div>

        <div class="kanban" data-ticket-list>
            <div class="kanban-column">
                <div class="kanban-header">Solicitações</div>
                <div class="kanban-body">
                    {% for ticket in own_tickets %}
                        <div class="ticket-card" data-ticket-id="{{ ticket.id }}">
                            <div class="ticket-title">
                                <span class="urgency-dot urgency-{{ ticket.urgency }}"></span>
                                #{{ ticket.id }} - {{ ticket.title }}
                            </div>
                            <div class="ticket-meta">
                                {{ ticket_meta|get_item:ticket.id|default:""|get_item:'requester' }}
                                {% if ticket_meta|get_item:ticket.id|default:""|get_item:'department' %}
                                    - {{ ticket_meta|get_item:ticket.id|default:""|get_item:'department' }}
                                {% endif %}
                                {% if ticket_meta|get_item:ticket.id|default:""|get_item:'description' %}
                                    - {{ ticket_meta|get_item:ticket.id|default:""|get_item:'description' }}
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}
</div>

<div class="modal" data-modal hidden>
    <div class="modal-backdrop" data-close-modal></div>
    <div class="modal-content">
        <div class="topbar" style="margin-bottom: 8px;">
            <h3>Abrir chamado</h3>
            <button type="button" data-close-modal>Fechar</button>
        </div>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-row">
                <div>
                    <label for="id_title">Título</label>
                    <input id="id_title" name="title" type="text" required />
                </div>
                {% if is_ti_group %}
                    <div>
                        <label for="id_type">Tipo</label>
                        <select id="id_type" name="ticket_type" required>
                            <option value="requisicao">Requisição</option>
                            <option value="melhoria">Melhoria</option>
                            <option value="incidente">Incidente</option>
                            <option value="programado">Programado</option>
                        </select>
                    </div>
                    <div>
                        <label for="id_urgency">Urgência</label>
                        <select id="id_urgency" name="urgency" required>
                            <option value="programada">Programada</option>
                            <option value="baixa">Baixa</option>
                            <option value="media">Média</option>
                            <option value="alta">Alta</option>
                        </select>
                    </div>
                {% else %}
                    <div>
                        <label for="id_type">Tipo</label>
                        <select id="id_type" name="ticket_type" required>
                            <option value="requisicao">Requisição</option>
                            <option value="melhoria">Melhoria</option>
                            <option value="incidente">Incidente</option>
                            <option value="programado">Programado</option>
                        </select>
                    </div>
                    <div>
                        <label for="id_urgency">Urgência</label>
                        <select id="id_urgency" name="urgency" required>
                            <option value="programada">Programada</option>
                            <option value="baixa">Baixa</option>
                            <option value="media">Média</option>
                            <option value="alta">Alta</option>
                        </select>
                    </div>
                {% endif %}
            </div>
            {% if not is_ti_group %}
                <div class="ticket-legend">
                    <strong>Legenda de urgência</strong>
                    <ul>
                        <li><span class="urgency-dot urgency-programada"></span> <strong>Programada:</strong> menor prioridade, pode ser agendada.</li>
                        <li><span class="urgency-dot urgency-baixa"></span> <strong>Baixa:</strong> impacto pequeno e localizado.</li>
                        <li><span class="urgency-dot urgency-media"></span> <strong>Média:</strong> impacto no time/área, precisa atenção.</li>
                        <li><span class="urgency-dot urgency-alta"></span> <strong>Alta:</strong> várias pessoas ou setor parado.</li>
                    </ul>
                </div>
            {% endif %}
            <div class="form-row">
                <div style="flex: 2;">
                    <label for="id_desc">Descrição</label>
                    <textarea id="id_desc" name="description" rows="3" required></textarea>
                </div>
                <div>
                    <label for="id_attach">Anexo</label>
                    <input id="id_attach" name="attachment" type="file" />
                </div>
            </div>
            <button type="submit">Abrir chamado</button>
        </form>
    </div>
</div>

<div class="modal" data-details-modal hidden>
    <div class="modal-backdrop" data-close-details></div>
    <div class="modal-content">
        <div class="topbar" style="margin-bottom: 8px;">
            <h3>Chamado #<span data-detail-id></span></h3>
            <button type="button" data-close-details>Fechar</button>
        </div>
        <div class="ticket-details">
            <div><strong>Título:</strong> <span data-detail-title></span></div>
            <div><strong>Descrição:</strong> <span data-detail-description></span></div>
            <div><strong>Tipo:</strong> <span data-detail-type></span></div>
            <div><strong>Urgência:</strong> <span data-detail-urgency></span></div>
            <div><strong>Status:</strong> <span data-detail-status></span></div>
            <div><strong>Solicitante:</strong> <span data-detail-created-by></span></div>
            <div><strong>Responsáveis:</strong> <span data-detail-assignees></span></div>
            <div><strong>Resolução:</strong> <span data-detail-resolution></span></div>
            <div>
                <strong>Anexo:</strong>
                <a href="#" data-detail-attachment target="_blank" rel="noreferrer">abrir</a>
                <span data-detail-no-attachment>-</span>
            </div>
        </div>
        {% if is_ti_group %}
            <form class="ticket-reclassify" data-reclassify-form>
                <div class="form-row">
                    <div>
                        <label for="id_reclass_type">Tipo</label>
                        <select id="id_reclass_type" name="ticket_type" required>
                            <option value="nao_classificado">Não classificado</option>
                            <option value="requisicao">Requisição</option>
                            <option value="melhoria">Melhoria</option>
                            <option value="incidente">Incidente</option>
                            <option value="programado">Programado</option>
                        </select>
                    </div>
                    <div>
                        <label for="id_reclass_urgency">Urgência</label>
                        <select id="id_reclass_urgency" name="urgency" required>
                            <option value="nao_classificado">Não classificado</option>
                            <option value="programada">Programada</option>
                            <option value="baixa">Baixa</option>
                            <option value="media">Média</option>
                            <option value="alta">Alta</option>
                        </select>
                    </div>
                    <div style="align-self: flex-end;">
                        <button type="submit">Reclassificar</button>
                    </div>
                </div>
            </form>
        {% endif %}

        <div class="chat-section">
            <h4>{% if is_ti_group %}Chat público{% else %}Chat{% endif %}</h4>
            <div class="chat-messages" data-chat-public></div>
            <form class="chat-form" data-chat-form data-internal="0">
                <input type="text" name="message" placeholder="Escreva uma mensagem..." />
                <div class="chat-actions">
                    <input type="file" name="attachment" />
                    <button type="submit">Enviar</button>
                </div>
            </form>
        </div>

        {% if is_ti_group %}
            <div class="chat-section" data-chat-internal-section>
                <h4>Chat interno TI</h4>
                <div class="chat-messages" data-chat-internal></div>
                <form class="chat-form" data-chat-form data-internal="1">
                    <input type="text" name="message" placeholder="Mensagem interna..." />
                    <div class="chat-actions">
                        <input type="file" name="attachment" />
                        <button type="submit">Enviar</button>
                    </div>
                </form>
            </div>
        {% endif %}
    </div>
</div>

{% if is_ti_group and whatsapp_group %}
    <div class="modal" data-whatsapp-modal hidden>
        <div class="modal-backdrop" data-close-whatsapp></div>
        <div class="modal-content">
            <div class="topbar" style="margin-bottom: 8px;">
                <h3>WhatsApp (notificações)</h3>
                <button type="button" data-close-whatsapp>Fechar</button>
            </div>
            <div class="ticket-legend">
                <strong>Grupo atual:</strong> {{ whatsapp_group }}
                <div class="muted" style="margin-top: 6px;">
                    Placeholders disponíveis: {id}, {title}, {description}, {status}, {responsavel}, {message}
                </div>
            </div>
            <form method="post" action="{% url 'chamados_whatsapp_settings' %}">
                {% csrf_token %}
                <div class="form-row">
                    <div>
                        <label>Enviar para grupo</label>
                        <div class="ticket-legend">
                            <label><input type="checkbox" name="send_group_on_new_ticket" {% if wa_settings.send_group_on_new_ticket %}checked{% endif %} /> Novo chamado</label><br />
                            <label><input type="checkbox" name="send_group_on_assignment" {% if wa_settings.send_group_on_assignment %}checked{% endif %} /> Atribuição / Em atendimento</label><br />
                            <label><input type="checkbox" name="send_group_on_status" {% if wa_settings.send_group_on_status %}checked{% endif %} /> Atualização de status</label><br />
                            <label><input type="checkbox" name="send_group_on_message" {% if wa_settings.send_group_on_message %}checked{% endif %} /> Nova mensagem</label>
                        </div>
                    </div>
                    <div>
                        <label>Enviar para atendentes</label>
                        <div class="ticket-legend">
                            <label><input type="checkbox" name="send_individual_on_new_ticket" {% if wa_settings.send_individual_on_new_ticket %}checked{% endif %} /> Novo chamado</label><br />
                            <label><input type="checkbox" name="send_individual_on_assignment" {% if wa_settings.send_individual_on_assignment %}checked{% endif %} /> Atribuição / Em atendimento</label><br />
                            <label><input type="checkbox" name="send_individual_on_status" {% if wa_settings.send_individual_on_status %}checked{% endif %} /> Atualização de status</label><br />
                            <label><input type="checkbox" name="send_individual_on_message" {% if wa_settings.send_individual_on_message %}checked{% endif %} /> Nova mensagem</label>
                        </div>
                    </div>
                </div>
                <button type="submit">Salvar regras</button>
            </form>
            <form method="post" action="{% url 'chamados_whatsapp_templates' %}">
                {% csrf_token %}
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_wa_new">Novo chamado</label>
                        <textarea id="id_wa_new" name="template_new_ticket" rows="2" placeholder="Novo chamado #{id}: {title} | {description}">{{ wa_templates.new_ticket }}</textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_wa_status">Status atualizado</label>
                        <textarea id="id_wa_status" name="template_status_update" rows="2" placeholder="Chamado #{id} atualizado: {status} | {responsavel}">{{ wa_templates.status_update }}</textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_wa_msg">Nova mensagem</label>
                        <textarea id="id_wa_msg" name="template_new_message" rows="2" placeholder="Nova mensagem no chamado #{id}: {message}">{{ wa_templates.new_message }}</textarea>
                    </div>
                </div>
                <button type="submit">Salvar templates</button>
            </form>
            <div class="ticket-legend" style="margin-top: 12px;">
                <strong>Atendentes TI (WhatsApp)</strong>
                <div class="muted" style="margin-top: 6px;">Somente visualização para validar nome e telefone.</div>
            </div>
            <div class="form-row">
                <div style="flex: 1; min-width: 260px;">
                    {% for contact in wa_contacts %}
                        <div style="margin-bottom:6px;">
                            {{ contact.name }}{% if contact.phone %} - {{ contact.phone }}{% endif %}
                        </div>
                    {% empty %}
                        <div class="muted">Nenhum atendente TI encontrado.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{% endif %}

{% if is_ti_group %}
    <div class="modal" data-email-modal hidden>
        <div class="modal-backdrop" data-close-email></div>
        <div class="modal-content">
            <div class="topbar" style="margin-bottom: 8px;">
                <h3>E-mail (notificações)</h3>
                <button type="button" data-close-email>Fechar</button>
            </div>
            <div class="ticket-legend">
                <strong>Placeholders disponíveis:</strong> {id}, {title}, {description}, {status}, {responsavel}, {message}
            </div>
            <form method="post" action="{% url 'chamados_email_templates' %}">
                {% csrf_token %}
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_email_new_subject">Assunto - Novo chamado</label>
                        <input id="id_email_new_subject" name="email_new_ticket_subject" type="text" placeholder="[Chamado #{id}] Novo chamado" value="{{ email_templates.new_ticket_subject }}" />
                    </div>
                    <div style="flex: 3;">
                        <label for="id_email_new_body">Corpo - Novo chamado</label>
                        <textarea id="id_email_new_body" name="email_new_ticket_body" rows="2" placeholder="Novo chamado #{id}: {title}\n{description}">{{ email_templates.new_ticket_body }}</textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_email_status_subject">Assunto - Status atualizado</label>
                        <input id="id_email_status_subject" name="email_status_update_subject" type="text" placeholder="[Chamado #{id}] Status atualizado" value="{{ email_templates.status_update_subject }}" />
                    </div>
                    <div style="flex: 3;">
                        <label for="id_email_status_body">Corpo - Status atualizado</label>
                        <textarea id="id_email_status_body" name="email_status_update_body" rows="2" placeholder="Status atual: {status}\nResponsável: {responsavel}">{{ email_templates.status_update_body }}</textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_email_msg_subject">Assunto - Nova mensagem</label>
                        <input id="id_email_msg_subject" name="email_new_message_subject" type="text" placeholder="[Chamado #{id}] Nova mensagem" value="{{ email_templates.new_message_subject }}" />
                    </div>
                    <div style="flex: 3;">
                        <label for="id_email_msg_body">Corpo - Nova mensagem</label>
                        <textarea id="id_email_msg_body" name="email_new_message_body" rows="2" placeholder="Nova mensagem: {message}">{{ email_templates.new_message_body }}</textarea>
                    </div>
                </div>
                <button type="submit">Salvar templates</button>
            </form>
        </div>
    </div>
{% endif %}


<div class="modal" data-resolution-modal hidden>
    <div class="modal-backdrop" data-close-resolution></div>
    <div class="modal-content">
        <div class="topbar" style="margin-bottom: 8px;">
            <h3>Finalizar chamado</h3>
            <button type="button" data-close-resolution>Fechar</button>
        </div>
        <form data-resolution-form>
            <label for="id_resolution_text">Resolução</label>
            <textarea id="id_resolution_text" name="resolution" rows="4" placeholder="Descreva a resolução..." required></textarea>
            <button type="submit">Salvar resolução e finalizar</button>
        </form>
    </div>
</div>

<script>
    (function () {
        const board = document.querySelector('[data-board]');
        if (!board) return;

        const getCookie = (name) => {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return '';
        };

        let draggingId = null;
        let draggingCard = null;
        let sourceColumn = null;
        let draggingMulti = false;
        let pendingClose = null;

        const resolutionModal = document.querySelector('[data-resolution-modal]');
        const resolutionForm = document.querySelector('[data-resolution-form]');
        const resolutionInput = document.querySelector('#id_resolution_text');
        const closeResolutionEls = document.querySelectorAll('[data-close-resolution]');
        const closedBody = document.querySelector('[data-target="fechado"] .kanban-body');

        const closeResolutionModal = () => {
            if (!resolutionModal) return;
            resolutionModal.hidden = true;
            if (resolutionInput) resolutionInput.value = '';
            pendingClose = null;
        };

        closeResolutionEls.forEach((el) => el.addEventListener('click', closeResolutionModal));


        board.addEventListener('dragstart', (event) => {
            const card = event.target.closest('.ticket-card');
            if (!card) return;
            draggingId = card.dataset.ticketId;
            draggingCard = card;
            sourceColumn = card.closest('.kanban-column');
            draggingMulti = !!(event.ctrlKey || event.metaKey);
            card.classList.add('dragging');
        });

        board.addEventListener('dragend', (event) => {
            const card = event.target.closest('.ticket-card');
            if (card) card.classList.remove('dragging');
            draggingCard = null;
            sourceColumn = null;
            draggingMulti = false;
        });

        board.querySelectorAll('.kanban-column').forEach((column) => {
            column.addEventListener('dragover', (event) => {
                event.preventDefault();
                column.classList.add('drag-over');
            });

            column.addEventListener('dragleave', () => {
                column.classList.remove('drag-over');
            });

            column.addEventListener('drop', async () => {
                column.classList.remove('drag-over');
                if (!draggingId || !draggingCard) return;
                const target = column.dataset.target;
                const targetBody = column.querySelector('.kanban-body');
                if (!targetBody) return;

                if (sourceColumn && sourceColumn === column) {
                    draggingId = null;
                    return;
                }

                const isUserTarget = target.startsWith('user_');
                const isUserSource = sourceColumn && sourceColumn.dataset.target.startsWith('user_');
                const isClosing = target === 'fechado';
                const shouldClone = !isClosing && draggingMulti && isUserTarget && isUserSource;

                if (targetBody.querySelector(`.ticket-card[data-ticket-id="${draggingId}"]`)) {
                    draggingId = null;
                    return;
                }

                const previousParent = draggingCard.parentElement;
                let movedCard = draggingCard;
                let resolutionText = '';

                if (isClosing) {
                    resolutionText = prompt('Informe a resolução do chamado:');
                    if (!resolutionText || !resolutionText.trim()) {
                        draggingId = null;
                        return;
                    }
                    resolutionText = resolutionText.trim();
                }

                if (shouldClone) {
                    movedCard = draggingCard.cloneNode(true);
                }

                targetBody.appendChild(movedCard);

                const response = await fetch('{% url "chamados_mover" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: new URLSearchParams({
                        ticket_id: draggingId,
                        target: target,
                        multi: draggingMulti ? '1' : '0',
                        resolution: resolutionText,
                    }),
                });

                if (!response.ok) {
                    if (shouldClone) {
                        movedCard.remove();
                    } else if (previousParent) {
                        previousParent.appendChild(draggingCard);
                    }
                    draggingId = null;
                    return;
                }

                if (!shouldClone) {
                    board.querySelectorAll(`.ticket-card[data-ticket-id="${draggingId}"]`).forEach((card) => {
                        if (card !== movedCard) {
                            card.remove();
                        }
                    });
                }
                draggingId = null;
            });
        });

        if (resolutionForm) {
            resolutionForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!pendingClose) return;
                const resolutionText = (resolutionInput?.value || '').trim();
                if (!resolutionText) return;

                const response = await fetch('{% url "chamados_mover" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: new URLSearchParams({
                        ticket_id: pendingClose.ticketId,
                        target: 'fechado',
                        multi: '0',
                        resolution: resolutionText,
                    }),
                });

                if (!response.ok) {
                    closeResolutionModal();
                    return;
                }

                pendingClose.targetBody.appendChild(pendingClose.card);
                board.querySelectorAll(`.ticket-card[data-ticket-id="${pendingClose.ticketId}"]`).forEach((card) => {
                    if (card !== pendingClose.card) {
                        card.remove();
                    }
                });
                closeResolutionModal();
            });
        }
    })();
</script>

<script>
    (function () {
        const modal = document.querySelector('[data-modal]');
        const openBtn = document.querySelector('[data-open-modal]');
        const closeEls = document.querySelectorAll('[data-close-modal]');
        if (!modal || !openBtn) return;

        const open = () => {
            modal.hidden = false;
        };
        const close = () => {
            modal.hidden = true;
        };

        openBtn.addEventListener('click', open);
        closeEls.forEach((el) => el.addEventListener('click', close));
    })();
</script>

<script>
    (function () {
        const modal = document.querySelector('[data-whatsapp-modal]');
        const openBtn = document.querySelector('[data-open-whatsapp]');
        const closeEls = document.querySelectorAll('[data-close-whatsapp]');
        if (!modal || !openBtn) return;

        const open = () => {
            modal.hidden = false;
        };
        const close = () => {
            modal.hidden = true;
        };

        openBtn.addEventListener('click', open);
        closeEls.forEach((el) => el.addEventListener('click', close));
    })();
</script>

<script>
    (function () {
        const detailsModal = document.querySelector('[data-details-modal]');
        const closeButtons = document.querySelectorAll('[data-close-details]');
        const board = document.querySelector('[data-board]');
        const list = document.querySelector('[data-ticket-list]');
        const clickRoot = board || list;
        if (!detailsModal || !clickRoot) return;

        const getCookie = (name) => {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return '';
        };

        let currentTicketId = null;
        let dragging = false;

        if (board) {
            board.addEventListener('dragstart', () => {
                dragging = true;
            });
            board.addEventListener('dragend', () => {
                setTimeout(() => {
                    dragging = false;
                }, 0);
            });
        }

        const setText = (selector, value) => {
            const el = detailsModal.querySelector(selector);
            if (el) el.textContent = value || '-';
        };

        const renderMessages = (container, messages) => {
            if (!container) return;
            container.innerHTML = '';
            if (!messages.length) {
                const empty = document.createElement('div');
                empty.className = 'ticket-empty';
                empty.textContent = 'Sem mensagens.';
                container.appendChild(empty);
                return;
            }
            messages.forEach((msg) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'chat-message';

                const author = document.createElement('div');
                author.className = 'chat-author';
                author.textContent = msg.author;

                const text = document.createElement('div');
                text.className = 'chat-text';
                text.textContent = msg.message || '';

                wrapper.appendChild(author);
                if (msg.message) wrapper.appendChild(text);

                if (msg.attachment_url) {
                    const attach = document.createElement('div');
                    const link = document.createElement('a');
                    link.href = msg.attachment_url;
                    link.target = '_blank';
                    link.rel = 'noreferrer';
                    link.textContent = 'Anexo';
                    attach.appendChild(link);
                    wrapper.appendChild(attach);
                }

                const time = document.createElement('div');
                time.className = 'chat-time';
                time.textContent = msg.created_at;
                wrapper.appendChild(time);

                container.appendChild(wrapper);
            });
        };

        const loadDetails = async (ticketId) => {
            const response = await fetch(`/chamados/detalhe/${ticketId}/`);
            if (!response.ok) return;
            const data = await response.json();
            if (!data.ok) return;

            setText('[data-detail-id]', data.ticket.id);
            setText('[data-detail-title]', data.ticket.title);
            setText('[data-detail-description]', data.ticket.description);
            setText('[data-detail-type]', data.ticket.ticket_type);
            setText('[data-detail-urgency]', data.ticket.urgency);
            setText('[data-detail-status]', data.ticket.status);
            setText('[data-detail-created-by]', data.ticket.created_by);
            setText('[data-detail-assignees]', data.ticket.assignees);
            setText('[data-detail-resolution]', data.ticket.resolution);

            const attachLink = detailsModal.querySelector('[data-detail-attachment]');
            const noAttach = detailsModal.querySelector('[data-detail-no-attachment]');
            if (data.ticket.attachment_url) {
                attachLink.href = data.ticket.attachment_url;
                attachLink.style.display = 'inline';
                noAttach.style.display = 'none';
            } else {
                attachLink.style.display = 'none';
                noAttach.style.display = 'inline';
            }

            renderMessages(detailsModal.querySelector('[data-chat-public]'), data.messages.public || []);
            renderMessages(detailsModal.querySelector('[data-chat-internal]'), data.messages.internal || []);

            const internalSection = detailsModal.querySelector('[data-chat-internal-section]');
            if (internalSection) {
                internalSection.style.display = data.internal_allowed ? 'block' : 'none';
            }

            const reclassForm = detailsModal.querySelector('[data-reclassify-form]');
            if (reclassForm) {
                const typeSelect = reclassForm.querySelector('select[name="ticket_type"]');
                const urgencySelect = reclassForm.querySelector('select[name="urgency"]');
                if (typeSelect) typeSelect.value = data.ticket.ticket_type_value || 'nao_classificado';
                if (urgencySelect) urgencySelect.value = data.ticket.urgency_value || 'nao_classificado';
            }
        };

        const openDetails = async (ticketId) => {
            currentTicketId = ticketId;
            detailsModal.hidden = false;
            await loadDetails(ticketId);
        };

        const closeDetails = () => {
            detailsModal.hidden = true;
            currentTicketId = null;
        };

        clickRoot.addEventListener('click', (event) => {
            if (dragging) return;
                        const card = event.target.closest('.ticket-card');
            if (!card) return;
            openDetails(card.dataset.ticketId);
        });

        closeButtons.forEach((btn) => btn.addEventListener('click', closeDetails));

        detailsModal.querySelectorAll('[data-chat-form]').forEach((form) => {
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!currentTicketId) return;
                const formData = new FormData(form);
                formData.append('ticket_id', currentTicketId);
                formData.append('internal', form.dataset.internal || '0');

                const response = await fetch('{% url "chamados_mensagem" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: formData,
                });

                if (response.ok) {
                    form.reset();
                    await loadDetails(currentTicketId);
                }
            });
        });

        const reclassForm = detailsModal.querySelector('[data-reclassify-form]');
        if (reclassForm) {
            reclassForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!currentTicketId) return;
                const formData = new FormData(reclassForm);
                formData.append('ticket_id', currentTicketId);

                const response = await fetch('{% url "chamados_reclassificar" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: formData,
                });

                if (response.ok) {
                    await loadDetails(currentTicketId);
                }
            });
        }
    })();
</script>
<script>
    (function () {
        const modal = document.querySelector('[data-email-modal]');
        const openBtn = document.querySelector('[data-open-email]');
        const closeEls = document.querySelectorAll('[data-close-email]');
        if (!modal || !openBtn) return;

        const open = () => {
            modal.hidden = false;
        };
        const close = () => {
            modal.hidden = true;
        };

        openBtn.addEventListener('click', open);
        closeEls.forEach((el) => el.addEventListener('click', close));
    })();
</script>
{% endblock %}
