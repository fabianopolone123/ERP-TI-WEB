{% extends "base.html" %}
{% load core_extras %}

{% block title %}Chamados | ERP TI{% endblock %}

{% block content %}
<style>
    .ticket-meta-rich {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 0.8rem;
        text-transform: none;
    }
    .ticket-requester {
        font-weight: 800;
        color: #e2e8f0;
        background: rgba(56, 189, 248, 0.14);
        border: 1px solid rgba(56, 189, 248, 0.4);
        border-radius: 8px;
        padding: 2px 8px;
        display: inline-flex;
        width: fit-content;
    }
    .ticket-extra {
        color: #93a4bf;
        line-height: 1.25;
    }
    .detail-description-block {
        margin-top: 6px;
        margin-bottom: 8px;
        padding: 12px 14px;
        border-radius: 10px;
        border: 1px solid #60a5fa;
        border-left: 6px solid #3b82f6;
        background: rgba(30, 64, 175, 0.24);
    }
    .detail-description-label {
        font-size: 0.78rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: #93c5fd;
        margin-bottom: 6px;
    }
    .detail-description-text {
        color: #f8fafc;
        font-weight: 700;
        font-size: 0.98rem;
        line-height: 1.5;
        white-space: pre-wrap;
    }
</style>
<div class="card">
    <div class="topbar">
        <div>
            <h2>Chamados</h2>
            <p class="muted">Gerencie pendências e atendimentos da equipe de TI.</p>
        </div>
        <form method="post" action="{% url 'logout' %}" class="inline-form">
            {% csrf_token %}
            <button type="submit">Sair</button>
        </form>
    </div>

    {% if is_ti_group %}
        {% include "core/_tabs.html" %}

        <div class="topbar" style="margin-top: 16px;">
            <h3>Chamados</h3>
            <div style="display: flex; gap: 8px; align-items: center;">
                {% if is_ti_group %}
                    <button type="button" data-open-whatsapp>
                        WhatsApp
                    </button>
                {% endif %}
                {% if is_ti_group %}
                    <button type="button" data-open-email>
                        E-mail
                    </button>
                {% endif %}
                <button type="button" data-open-modal>Abrir chamado</button>
            </div>
        </div>
        <div class="ticket-legend" style="margin-top: 8px;">
            <strong>Legenda</strong>
            <div style="margin-top: 6px; display: flex; flex-wrap: wrap; gap: 12px;">
                <span><span class="urgency-dot urgency-programada"></span> Programada</span>
                <span><span class="urgency-dot urgency-baixa"></span> Baixa</span>
                <span><span class="urgency-dot urgency-media"></span> Média</span>
                <span><span class="urgency-dot urgency-alta"></span> Alta</span>
                <span><span class="urgency-dot urgency-nao_classificado"></span> Não classificado</span>
            </div>
        </div>

        <div class="kanban" data-board>
            <div class="kanban-column" data-target="novo">
                <div class="kanban-header">Novo</div>
                <div class="kanban-body">
                    {% for ticket in new_tickets %}
                        <div class="ticket-card{% if ticket_meta|get_item:ticket.id|default:''|get_item:'is_multi_attendant' %} shared-ticket{% endif %}" draggable="true" data-ticket-id="{{ ticket.id }}">
                            <div class="ticket-title">
                                <span class="urgency-dot urgency-{{ ticket.urgency }}"></span>
                                #{{ ticket.id }} - {{ ticket.title }}
                                {% if ticket_meta|get_item:ticket.id|default:''|get_item:'is_multi_attendant' %}
                                    <span class="status-pill status-shared">Compartilhado</span>
                                {% endif %}
                            </div>
                            {% if is_ti_group %}
                                <div class="ticket-meta ticket-meta-rich">
                                    <span class="ticket-requester">{{ ticket_meta|get_item:ticket.id|default:""|get_item:'requester' }}</span>
                                    <span class="ticket-extra">
                                        {% if ticket_meta|get_item:ticket.id|default:""|get_item:'department' %}
                                            {{ ticket_meta|get_item:ticket.id|default:""|get_item:'department' }}
                                        {% else %}
                                            -
                                        {% endif %}
                                        {% if ticket_meta|get_item:ticket.id|default:""|get_item:'description' %}
                                            | {{ ticket_meta|get_item:ticket.id|default:""|get_item:'description' }}
                                        {% endif %}
                                    </span>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>

            {% for user in ti_users %}
                <div class="kanban-column" data-target="user_{{ user.id }}">
                    <div class="kanban-header">{{ user.full_name }}</div>
                    <div class="kanban-body">
                        {% for ticket in user_tickets|get_item:user.id %}
                            <div class="ticket-card{% if ticket_meta|get_item:ticket.id|default:''|get_item:'is_multi_attendant' %} shared-ticket{% endif %}" draggable="true" data-ticket-id="{{ ticket.id }}">
                                <div class="ticket-title">
                                    <span class="urgency-dot urgency-{{ ticket.urgency }}"></span>
                                    #{{ ticket.id }} - {{ ticket.title }}
                                    {% if ticket_meta|get_item:ticket.id|default:''|get_item:'is_multi_attendant' %}
                                        <span class="status-pill status-shared">Compartilhado</span>
                                    {% endif %}
                                </div>
                                <div class="ticket-meta ticket-meta-rich">
                                    <span class="ticket-requester">{{ ticket_meta|get_item:ticket.id|default:""|get_item:'requester' }}</span>
                                    <span class="ticket-extra">
                                        {% if ticket_meta|get_item:ticket.id|default:""|get_item:'department' %}
                                            {{ ticket_meta|get_item:ticket.id|default:""|get_item:'department' }}
                                        {% else %}
                                            -
                                        {% endif %}
                                        {% if ticket_meta|get_item:ticket.id|default:""|get_item:'description' %}
                                            | {{ ticket_meta|get_item:ticket.id|default:""|get_item:'description' }}
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}

            <div class="kanban-column" data-target="fechado">
                <div class="kanban-header">Fechados</div>
                <div class="kanban-body">
                    {% for ticket in closed_tickets %}
                        <div class="ticket-card{% if ticket_meta|get_item:ticket.id|default:''|get_item:'is_multi_attendant' %} shared-ticket{% endif %}" draggable="true" data-ticket-id="{{ ticket.id }}">
                            <div class="ticket-title">
                                <span class="urgency-dot urgency-{{ ticket.urgency }}"></span>
                                #{{ ticket.id }} - {{ ticket.title }}
                                {% if ticket_meta|get_item:ticket.id|default:''|get_item:'is_multi_attendant' %}
                                    <span class="status-pill status-shared">Compartilhado</span>
                                {% endif %}
                            </div>
                            <div class="ticket-meta ticket-meta-rich">
                                <span class="ticket-requester">{{ ticket_meta|get_item:ticket.id|default:""|get_item:'requester' }}</span>
                                <span class="ticket-extra">
                                    {% if ticket_meta|get_item:ticket.id|default:""|get_item:'department' %}
                                        {{ ticket_meta|get_item:ticket.id|default:""|get_item:'department' }}
                                    {% else %}
                                        -
                                    {% endif %}
                                    {% if ticket_meta|get_item:ticket.id|default:""|get_item:'description' %}
                                        | {{ ticket_meta|get_item:ticket.id|default:""|get_item:'description' }}
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="kanban-column" data-target="pendente">
                <div class="kanban-header">Pendente</div>
                <div class="kanban-body">
                    {% for ticket in pending_tickets %}
                        <div class="ticket-card{% if ticket_meta|get_item:ticket.id|default:''|get_item:'is_multi_attendant' %} shared-ticket{% endif %}" draggable="true" data-ticket-id="{{ ticket.id }}">
                            <div class="ticket-title">
                                <span class="urgency-dot urgency-{{ ticket.urgency }}"></span>
                                #{{ ticket.id }} - {{ ticket.title }}
                                {% if ticket_meta|get_item:ticket.id|default:''|get_item:'is_multi_attendant' %}
                                    <span class="status-pill status-shared">Compartilhado</span>
                                {% endif %}
                            </div>
                            {% if is_ti_group %}
                                <div class="ticket-meta ticket-meta-rich">
                                    <span class="ticket-requester">{{ ticket_meta|get_item:ticket.id|default:""|get_item:'requester' }}</span>
                                    <span class="ticket-extra">
                                        {% if ticket_meta|get_item:ticket.id|default:""|get_item:'department' %}
                                            {{ ticket_meta|get_item:ticket.id|default:""|get_item:'department' }}
                                        {% else %}
                                            -
                                        {% endif %}
                                        {% if ticket_meta|get_item:ticket.id|default:""|get_item:'description' %}
                                            | {{ ticket_meta|get_item:ticket.id|default:""|get_item:'description' }}
                                        {% endif %}
                                    </span>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="kanban-column" data-target="programado">
                <div class="kanban-header">Programado</div>
                <div class="kanban-body">
                    {% for ticket in scheduled_tickets %}
                        <div class="ticket-card{% if ticket_meta|get_item:ticket.id|default:''|get_item:'is_multi_attendant' %} shared-ticket{% endif %}" draggable="true" data-ticket-id="{{ ticket.id }}">
                            <div class="ticket-title">
                                <span class="urgency-dot urgency-{{ ticket.urgency }}"></span>
                                #{{ ticket.id }} - {{ ticket.title }}
                                {% if ticket_meta|get_item:ticket.id|default:''|get_item:'is_multi_attendant' %}
                                    <span class="status-pill status-shared">Compartilhado</span>
                                {% endif %}
                            </div>
                            {% if is_ti_group %}
                                <div class="ticket-meta ticket-meta-rich">
                                    <span class="ticket-requester">{{ ticket_meta|get_item:ticket.id|default:""|get_item:'requester' }}</span>
                                    <span class="ticket-extra">
                                        {% if ticket_meta|get_item:ticket.id|default:""|get_item:'department' %}
                                            {{ ticket_meta|get_item:ticket.id|default:""|get_item:'department' }}
                                        {% else %}
                                            -
                                        {% endif %}
                                        {% if ticket_meta|get_item:ticket.id|default:""|get_item:'description' %}
                                            | {{ ticket_meta|get_item:ticket.id|default:""|get_item:'description' }}
                                        {% endif %}
                                    </span>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% else %}
        <div class="topbar" style="margin-top: 16px;">
            <h3>Meus chamados</h3>
            <button type="button" data-open-modal>Abrir chamado</button>
        </div>

        <div class="kanban" data-ticket-list>
            <div class="kanban-column">
                <div class="kanban-header">Solicitações</div>
                <div class="kanban-body">
                    {% for ticket in own_tickets %}
                        <div class="ticket-card" data-ticket-id="{{ ticket.id }}">
                            <div class="ticket-title">
                                <span class="urgency-dot urgency-{{ ticket.urgency }}"></span>
                                #{{ ticket.id }} - {{ ticket.title }}
                                <span class="status-pill status-{{ ticket.status }}">{{ ticket.get_status_display }}</span>
                            </div>
                            <div class="ticket-meta ticket-meta-rich">
                                <span class="ticket-requester">{{ ticket_meta|get_item:ticket.id|default:""|get_item:'requester' }}</span>
                                <span class="ticket-extra">
                                    {% if ticket_meta|get_item:ticket.id|default:""|get_item:'department' %}
                                        {{ ticket_meta|get_item:ticket.id|default:""|get_item:'department' }}
                                    {% else %}
                                        -
                                    {% endif %}
                                    {% if ticket_meta|get_item:ticket.id|default:""|get_item:'description' %}
                                        | {{ ticket_meta|get_item:ticket.id|default:""|get_item:'description' }}
                                    {% endif %}
                                </span>
                            </div>
                            {% if ticket.status == 'fechado' %}
                                <div class="ticket-meta" style="margin-top: 6px;">
                                    <button type="button" data-reopen-ticket data-ticket-id="{{ ticket.id }}">Reabrir chamado</button>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}
</div>

<div class="modal" data-modal hidden>
    <div class="modal-backdrop" data-close-modal></div>
    <div class="modal-content">
        <div class="topbar" style="margin-bottom: 8px;">
            <h3>Abrir chamado</h3>
            <button type="button" data-close-modal>Fechar</button>
        </div>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-row">
                <div>
                    <label for="id_title">Título</label>
                    <input id="id_title" name="title" type="text" required />
                </div>
                {% if is_ti_group %}
                    <div>
                        <label for="id_type">Tipo</label>
                        <select id="id_type" name="ticket_type" required>
                            <option value="requisicao">Requisição</option>
                            <option value="melhoria">Melhoria</option>
                            <option value="incidente">Incidente</option>
                            <option value="programado">Programado</option>
                        </select>
                    </div>
                    <div>
                        <label for="id_urgency">Urgência</label>
                        <select id="id_urgency" name="urgency" required>
                            <option value="programada">Programada</option>
                            <option value="baixa">Baixa</option>
                            <option value="media">Média</option>
                            <option value="alta">Alta</option>
                        </select>
                    </div>
                {% else %}
                    <div>
                        <label for="id_type">Tipo</label>
                        <select id="id_type" name="ticket_type" required>
                            <option value="requisicao">Requisição</option>
                            <option value="melhoria">Melhoria</option>
                            <option value="incidente">Incidente</option>
                            <option value="programado">Programado</option>
                        </select>
                    </div>
                    <div>
                        <label for="id_urgency">Urgência</label>
                        <select id="id_urgency" name="urgency" required>
                            <option value="programada">Programada</option>
                            <option value="baixa">Baixa</option>
                            <option value="media">Média</option>
                            <option value="alta">Alta</option>
                        </select>
                    </div>
                {% endif %}
            </div>
            {% if not is_ti_group %}
                <div class="ticket-legend">
                    <strong>Legenda de urgência</strong>
                    <ul>
                        <li><span class="urgency-dot urgency-programada"></span> <strong>Programada:</strong> menor prioridade, pode ser agendada.</li>
                        <li><span class="urgency-dot urgency-baixa"></span> <strong>Baixa:</strong> impacto pequeno e localizado.</li>
                        <li><span class="urgency-dot urgency-media"></span> <strong>Média:</strong> impacto no time/área, precisa atenção.</li>
                        <li><span class="urgency-dot urgency-alta"></span> <strong>Alta:</strong> várias pessoas ou setor parado.</li>
                    </ul>
                </div>
            {% endif %}
            <div class="form-row">
                <div style="flex: 2;">
                    <label for="id_desc">Descrição</label>
                    <textarea id="id_desc" name="description" rows="3" required></textarea>
                </div>
                <div>
                    <label for="id_attach">Anexo</label>
                    <input id="id_attach" name="attachment" type="file" />
                </div>
            </div>
            <button type="submit">Abrir chamado</button>
        </form>
    </div>
</div>

<div class="modal" data-details-modal hidden>
    <div class="modal-backdrop" data-close-details></div>
    <div class="modal-content">
        <div class="topbar" style="margin-bottom: 8px;">
            <h3>Chamado #<span data-detail-id></span></h3>
            <button type="button" data-close-details>Fechar</button>
        </div>
        <div class="ticket-details">
            <div><strong>Título:</strong> <span data-detail-title></span></div>
            <div class="detail-description-block">
                <div class="detail-description-label">Descrição do problema</div>
                <div class="detail-description-text" data-detail-description></div>
            </div>
            <div><strong>Tipo:</strong> <span data-detail-type></span></div>
            <div><strong>Urgência:</strong> <span data-detail-urgency></span></div>
            <div><strong>Status:</strong> <span data-detail-status></span></div>
            <div><strong>Solicitante:</strong> <span data-detail-created-by></span></div>
            <div><strong>Responsáveis:</strong> <span data-detail-assignees></span></div>
            <div><strong>Resolução:</strong> <span data-detail-resolution></span></div>
            <div>
                <strong>Anexo:</strong>
                <a href="#" data-detail-attachment target="_blank" rel="noreferrer">abrir</a>
                <span data-detail-no-attachment>-</span>
            </div>
        </div>
        <div style="margin-top: 12px;">
            <strong>Timeline</strong>
            <div class="chat-list" data-ticket-timeline></div>
        </div>
        {% if is_ti_group %}
            <form class="ticket-edit" data-edit-form hidden>
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_edit_title">Título</label>
                        <input id="id_edit_title" name="title" type="text" required />
                    </div>
                </div>
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_edit_desc">Descrição</label>
                        <textarea id="id_edit_desc" name="description" rows="3" required></textarea>
                    </div>
                    <div style="align-self: flex-end;">
                        <button type="submit">Salvar</button>
                    </div>
                </div>
                <div class="muted" style="margin-top: 6px;">
                    Somente o TI que abriu o chamado pode editar.
                </div>
            </form>
            <div style="margin-top: 12px;">
                <button type="button" data-edit-toggle hidden>Editar título/descrição</button>
            </div>
        {% endif %}
        {% if not is_ti_group %}
            <div style="margin-top: 12px;">
                <button type="button" data-detail-reopen hidden>Reabrir chamado</button>
            </div>
        {% endif %}
        {% if is_ti_group %}
            <form class="ticket-reclassify" data-reclassify-form>
                <div class="form-row">
                    <div>
                        <label for="id_reclass_type">Tipo</label>
                        <select id="id_reclass_type" name="ticket_type" required>
                            <option value="nao_classificado">Não classificado</option>
                            <option value="requisicao">Requisição</option>
                            <option value="melhoria">Melhoria</option>
                            <option value="incidente">Incidente</option>
                            <option value="programado">Programado</option>
                        </select>
                    </div>
                    <div>
                        <label for="id_reclass_urgency">Urgência</label>
                        <select id="id_reclass_urgency" name="urgency" required>
                            <option value="nao_classificado">Não classificado</option>
                            <option value="programada">Programada</option>
                            <option value="baixa">Baixa</option>
                            <option value="media">Média</option>
                            <option value="alta">Alta</option>
                        </select>
                    </div>
                    <div style="align-self: flex-end; display: flex; gap: 8px;">
                        <button type="submit">Reclassificar</button>
                    </div>
                </div>
            </form>
        {% endif %}

        <div class="chat-section">
            <h4>{% if is_ti_group %}Chat público{% else %}Chat{% endif %}</h4>
            <div class="chat-messages" data-chat-public></div>
            <form class="chat-form" data-chat-form data-internal="0">
                <input type="text" name="message" placeholder="Escreva uma mensagem..." />
                <div class="chat-actions">
                    <input type="file" name="attachment" />
                    <button type="submit">Enviar</button>
                </div>
            </form>
        </div>

        {% if is_ti_group %}
            <div class="chat-section" data-chat-internal-section>
                <h4>Chat interno TI</h4>
                <div class="chat-messages" data-chat-internal></div>
                <form class="chat-form" data-chat-form data-internal="1">
                    <input type="text" name="message" placeholder="Mensagem interna..." />
                    <div class="chat-actions">
                        <input type="file" name="attachment" />
                        <button type="submit">Enviar</button>
                    </div>
                </form>
            </div>
        {% endif %}
    </div>
</div>

{% if is_ti_group %}
    <div class="modal" data-whatsapp-modal hidden>
        <div class="modal-backdrop" data-close-whatsapp></div>
        <div class="modal-content">
            <div class="topbar" style="margin-bottom: 8px;">
                <h3>WhatsApp (notificações)</h3>
                <button type="button" data-close-whatsapp>Fechar</button>
            </div>
            <div class="ticket-legend">
                <strong>Grupo atual:</strong> {{ whatsapp_group|default:"(nao configurado)" }}
                <div class="muted" style="margin-top: 6px;">
                    Placeholders disponíveis: veja a lista completa abaixo dos templates.
                </div>
            </div>
            <form method="post" action="{% url 'chamados_whatsapp_settings' %}">
                {% csrf_token %}
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_wa_group_name">Nome do grupo (buscar ID)</label>
                        <div style="display:flex; gap:8px; align-items:flex-end;">
                            <input id="id_wa_group_name" type="text" placeholder="Ex.: TI-chamados" style="flex:1;" />
                            <button type="button" data-wa-group-lookup>Buscar grupo</button>
                        </div>
                        <div class="muted" style="margin-top: 6px;" data-wa-group-result></div>
                    </div>
                    <div style="flex: 2;">
                        <label for="id_wa_group_jid">ID do grupo (JID)</label>
                        <input
                            id="id_wa_group_jid"
                            name="group_jid"
                            type="text"
                            placeholder="1203XXXXXXXXXXXX@g.us"
                            value="{{ wa_settings.group_jid|default:whatsapp_group }}"
                        />
                    </div>
                </div>
                <div class="form-row">
                    <div style="flex: 1;">
                        <label>Notificações</label>
                        <div class="ticket-legend" style="margin-top: 8px;">
                            <div style="display:grid; grid-template-columns: 1fr 140px 140px; gap: 6px 12px; align-items: center;">
                                <div></div>
                                <div style="text-align:center; font-weight:600;">Grupo</div>
                                <div style="text-align:center; font-weight:600;">Atendentes</div>

                                <div>Novo chamado</div>
                                <div style="text-align:center;"><input type="checkbox" name="send_group_on_new_ticket" {% if wa_settings.send_group_on_new_ticket %}checked{% endif %} /></div>
                                <div style="text-align:center;"><input type="checkbox" name="send_individual_on_new_ticket" {% if wa_settings.send_individual_on_new_ticket %}checked{% endif %} /></div>

                                <div>Status pendente</div>
                                <div style="text-align:center;"><input type="checkbox" name="send_group_on_status_pending" {% if wa_settings.send_group_on_status_pending %}checked{% endif %} /></div>
                                <div style="text-align:center;"><input type="checkbox" name="send_individual_on_status_pending" {% if wa_settings.send_individual_on_status_pending %}checked{% endif %} /></div>

                                <div>Transferido para outro atendente</div>
                                <div style="text-align:center;"><input type="checkbox" name="send_group_on_assignment_changed" {% if wa_settings.send_group_on_assignment_changed %}checked{% endif %} /></div>
                                <div style="text-align:center;"><input type="checkbox" name="send_individual_on_assignment_changed" {% if wa_settings.send_individual_on_assignment_changed %}checked{% endif %} /></div>

                                <div>Responsável definido (em atendimento)</div>
                                <div style="text-align:center;"><input type="checkbox" name="send_group_on_assignment_new" {% if wa_settings.send_group_on_assignment_new %}checked{% endif %} /></div>
                                <div style="text-align:center;"><input type="checkbox" name="send_individual_on_assignment_new" {% if wa_settings.send_individual_on_assignment_new %}checked{% endif %} /></div>

                                <div>Status em atendimento</div>
                                <div style="text-align:center;"><input type="checkbox" name="send_group_on_status_in_progress" {% if wa_settings.send_group_on_status_in_progress %}checked{% endif %} /></div>
                                <div style="text-align:center;"><input type="checkbox" name="send_individual_on_status_in_progress" {% if wa_settings.send_individual_on_status_in_progress %}checked{% endif %} /></div>

                                <div>Status fechado</div>
                                <div style="text-align:center;"><input type="checkbox" name="send_group_on_status_closed" {% if wa_settings.send_group_on_status_closed %}checked{% endif %} /></div>
                                <div style="text-align:center;"><input type="checkbox" name="send_individual_on_status_closed" {% if wa_settings.send_individual_on_status_closed %}checked{% endif %} /></div>

                                <div>Nova mensagem interna TI</div>
                                <div style="text-align:center;"><input type="checkbox" name="send_group_on_message_internal" {% if wa_settings.send_group_on_message_internal %}checked{% endif %} /></div>
                                <div style="text-align:center;"><input type="checkbox" name="send_individual_on_message_internal" {% if wa_settings.send_individual_on_message_internal %}checked{% endif %} /></div>

                                <div>Nova mensagem do usuário</div>
                                <div style="text-align:center;"><input type="checkbox" name="send_group_on_message_user" {% if wa_settings.send_group_on_message_user %}checked{% endif %} /></div>
                                <div style="text-align:center;"><input type="checkbox" name="send_individual_on_message_user" {% if wa_settings.send_individual_on_message_user %}checked{% endif %} /></div>
                            </div>
                        </div>
                    </div>
                </div>
                <button type="submit">Salvar regras</button>
            </form>
            <form method="post" action="{% url 'chamados_whatsapp_templates' %}">
                {% csrf_token %}
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_wa_new">Novo chamado</label>
                        <textarea id="id_wa_new" name="template_new_ticket" rows="2" placeholder="Novo chamado #{id}: {title} | Solicitante: {solicitante} | Tipo: {tipo} | Urgência: {urgencia} | {description}">{{ wa_templates.new_ticket }}</textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_wa_status">Status atualizado</label>
                        <textarea id="id_wa_status" name="template_status_update" rows="2" placeholder="Chamado #{id} atualizado: {status} | Responsável: {responsavel} | Solicitante: {solicitante}">{{ wa_templates.status_update }}</textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_wa_msg">Nova mensagem</label>
                        <textarea id="id_wa_msg" name="template_new_message" rows="2" placeholder="Nova mensagem no chamado #{id}: {message} | Solicitante: {solicitante}">{{ wa_templates.new_message }}</textarea>
                    </div>
                </div>
                <div class="ticket-legend" style="margin-bottom: 10px;">
                    <strong>Placeholders disponíveis</strong>
                    <div class="muted" style="margin-top:6px;">
                        <code>{id}</code>, <code>{ticket_id}</code>, <code>{title}</code>, <code>{titulo}</code>, <code>{description}</code>, <code>{descricao}</code>, <code>{status}</code>, <code>{tipo}</code>, <code>{urgencia}</code>, <code>{responsavel}</code>, <code>{responsavel_usuario}</code>, <code>{solicitante}</code>, <code>{solicitante_usuario}</code>, <code>{solicitante_email}</code>, <code>{colaboradores}</code>, <code>{message}</code>, <code>{mensagem}</code>, <code>{criado_em}</code>, <code>{atualizado_em}</code>, <code>{resolucao}</code>, <code>{link}</code>
                    </div>
                </div>
                <button type="submit">Salvar templates</button>
            </form>
            <div class="ticket-legend" style="margin-top: 12px;">
                <strong>Atendentes TI (WhatsApp)</strong>
                <div class="muted" style="margin-top: 6px;">Somente visualização para validar nome e telefone.</div>
            </div>
            <div class="form-row">
                <div style="flex: 1; min-width: 260px;">
                    {% for contact in wa_contacts %}
                        <div style="margin-bottom:6px;">
                            {{ contact.name }}{% if contact.phone %} - {{ contact.phone }}{% endif %}
                        </div>
                    {% empty %}
                        <div class="muted">Nenhum atendente TI encontrado.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{% endif %}

{% if is_ti_group %}
    <div class="modal" data-email-modal hidden>
        <div class="modal-backdrop" data-close-email></div>
        <div class="modal-content">
            <div class="topbar" style="margin-bottom: 8px;">
                <h3>E-mail (notificações)</h3>
                <button type="button" data-close-email>Fechar</button>
            </div>
            <div class="ticket-legend">
                <strong>Placeholders disponíveis:</strong> {id}, {title}, {description}, {status}, {responsavel}, {message}
            </div>
            <form method="post" action="{% url 'chamados_email_templates' %}">
                {% csrf_token %}
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_email_new_subject">Assunto - Novo chamado</label>
                        <input id="id_email_new_subject" name="email_new_ticket_subject" type="text" placeholder="[Chamado #{id}] Novo chamado" value="{{ email_templates.new_ticket_subject }}" />
                    </div>
                    <div style="flex: 3;">
                        <label for="id_email_new_body">Corpo - Novo chamado</label>
                        <textarea id="id_email_new_body" name="email_new_ticket_body" rows="2" placeholder="Novo chamado #{id}: {title}\n{description}">{{ email_templates.new_ticket_body }}</textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_email_status_subject">Assunto - Status atualizado</label>
                        <input id="id_email_status_subject" name="email_status_update_subject" type="text" placeholder="[Chamado #{id}] Status atualizado" value="{{ email_templates.status_update_subject }}" />
                    </div>
                    <div style="flex: 3;">
                        <label for="id_email_status_body">Corpo - Status atualizado</label>
                        <textarea id="id_email_status_body" name="email_status_update_body" rows="2" placeholder="Status atual: {status}\nResponsável: {responsavel}">{{ email_templates.status_update_body }}</textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_email_msg_subject">Assunto - Nova mensagem</label>
                        <input id="id_email_msg_subject" name="email_new_message_subject" type="text" placeholder="[Chamado #{id}] Nova mensagem" value="{{ email_templates.new_message_subject }}" />
                    </div>
                    <div style="flex: 3;">
                        <label for="id_email_msg_body">Corpo - Nova mensagem</label>
                        <textarea id="id_email_msg_body" name="email_new_message_body" rows="2" placeholder="Nova mensagem: {message}">{{ email_templates.new_message_body }}</textarea>
                    </div>
                </div>
                <button type="submit">Salvar templates</button>
            </form>
        </div>
    </div>
{% endif %}

<script>
    (function () {
        const board = document.querySelector('[data-board]');
        if (!board) return;

        const getCookie = (name) => {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return '';
        };

        let draggingId = null;
        let draggingCard = null;
        let sourceColumn = null;
        let draggingMulti = false;


        board.addEventListener('dragstart', (event) => {
            const card = event.target.closest('.ticket-card');
            if (!card) return;
            draggingId = card.dataset.ticketId;
            draggingCard = card;
            sourceColumn = card.closest('.kanban-column');
            draggingMulti = !!(event.ctrlKey || event.metaKey);
            card.classList.add('dragging');
        });

        board.addEventListener('dragend', (event) => {
            const card = event.target.closest('.ticket-card');
            if (card) card.classList.remove('dragging');
            draggingCard = null;
            sourceColumn = null;
            draggingMulti = false;
        });

        board.querySelectorAll('.kanban-column').forEach((column) => {
            column.addEventListener('dragover', (event) => {
                event.preventDefault();
                column.classList.add('drag-over');
            });

            column.addEventListener('dragleave', () => {
                column.classList.remove('drag-over');
            });

            column.addEventListener('drop', async () => {
                column.classList.remove('drag-over');
                if (!draggingId || !draggingCard) return;
                const target = column.dataset.target;
                const targetBody = column.querySelector('.kanban-body');
                if (!targetBody) return;

                if (sourceColumn && sourceColumn === column) {
                    draggingId = null;
                    return;
                }

                const isUserTarget = target.startsWith('user_');
                const isUserSource = sourceColumn && sourceColumn.dataset.target.startsWith('user_');
                const isClosing = target === 'fechado';
                const isPending = target === 'pendente';
                const shouldClone = !isClosing && draggingMulti && isUserTarget && isUserSource;

                if (targetBody.querySelector(`.ticket-card[data-ticket-id="${draggingId}"]`)) {
                    draggingId = null;
                    return;
                }

                const previousParent = draggingCard.parentElement;
                let movedCard = draggingCard;
                let resolutionText = '';
                let progressNote = '';

                if (isClosing) {
                    resolutionText = prompt('Informe a resolução do chamado:');
                    if (!resolutionText || !resolutionText.trim()) {
                        draggingId = null;
                        return;
                    }
                    resolutionText = resolutionText.trim();
                }
                if (isPending && isUserSource) {
                    progressNote = prompt('O que foi feito neste atendimento antes de voltar para Pendente?');
                    if (!progressNote || !progressNote.trim()) {
                        draggingId = null;
                        return;
                    }
                    progressNote = progressNote.trim();
                }

                if (shouldClone) {
                    movedCard = draggingCard.cloneNode(true);
                }

                targetBody.appendChild(movedCard);

                const response = await fetch('{% url "chamados_mover" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: new URLSearchParams({
                        ticket_id: draggingId,
                        target: target,
                        source_target: sourceColumn ? sourceColumn.dataset.target : '',
                        multi: draggingMulti ? '1' : '0',
                        resolution: resolutionText,
                        progress_note: progressNote,
                    }),
                });

                let responseData = {};
                try {
                    responseData = await response.json();
                } catch (err) {
                    responseData = {};
                }

                if (!response.ok) {
                    if (responseData.error === 'progress_note_required') {
                        alert('Informe o que foi feito antes de mover para Pendente.');
                    } else if (responseData.error === 'resolution_required') {
                        alert('Informe a resolução para finalizar o chamado.');
                    }
                    if (shouldClone) {
                        movedCard.remove();
                    } else if (previousParent) {
                        previousParent.appendChild(draggingCard);
                    }
                    draggingId = null;
                    return;
                }

                if (responseData.partial_unassign) {
                    movedCard.remove();
                    draggingId = null;
                    return;
                }

                if (!shouldClone) {
                    board.querySelectorAll(`.ticket-card[data-ticket-id="${draggingId}"]`).forEach((card) => {
                        if (card !== movedCard) {
                            card.remove();
                        }
                    });
                }
                draggingId = null;
            });
        });
    })();
</script>

<script>
    (function () {
        const modal = document.querySelector('[data-modal]');
        const openBtn = document.querySelector('[data-open-modal]');
        const closeEls = document.querySelectorAll('[data-close-modal]');
        if (!modal || !openBtn) return;

        const open = () => {
            modal.hidden = false;
        };
        const close = () => {
            modal.hidden = true;
        };

        openBtn.addEventListener('click', open);
        closeEls.forEach((el) => el.addEventListener('click', close));
    })();
</script>

<script>
    (function () {
        const modal = document.querySelector('[data-whatsapp-modal]');
        const openBtn = document.querySelector('[data-open-whatsapp]');
        const closeEls = document.querySelectorAll('[data-close-whatsapp]');
        if (!modal || !openBtn) return;

        const open = () => {
            modal.hidden = false;
        };
        const close = () => {
            modal.hidden = true;
        };

        openBtn.addEventListener('click', open);
        closeEls.forEach((el) => el.addEventListener('click', close));
    })();
</script>

<script>
    (function () {
        const detailsModal = document.querySelector('[data-details-modal]');
        const closeButtons = document.querySelectorAll('[data-close-details]');
        const board = document.querySelector('[data-board]');
        const list = document.querySelector('[data-ticket-list]');
        const clickRoot = board || list;
        if (!detailsModal || !clickRoot) return;

        const getCookie = (name) => {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return '';
        };

        let currentTicketId = null;
        let dragging = false;

        if (board) {
            board.addEventListener('dragstart', () => {
                dragging = true;
            });
            board.addEventListener('dragend', () => {
                setTimeout(() => {
                    dragging = false;
                }, 0);
            });
        }

        const setText = (selector, value) => {
            const el = detailsModal.querySelector(selector);
            if (el) el.textContent = value || '-';
        };

        const renderMessages = (container, messages) => {
            if (!container) return;
            container.innerHTML = '';
            if (!messages.length) {
                const empty = document.createElement('div');
                empty.className = 'ticket-empty';
                empty.textContent = 'Sem mensagens.';
                container.appendChild(empty);
                return;
            }
            messages.forEach((msg) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'chat-message';

                const author = document.createElement('div');
                author.className = 'chat-author';
                author.textContent = msg.author;

                const text = document.createElement('div');
                text.className = 'chat-text';
                text.textContent = msg.message || '';

                wrapper.appendChild(author);
                if (msg.message) wrapper.appendChild(text);

                if (msg.attachment_url) {
                    const attach = document.createElement('div');
                    const link = document.createElement('a');
                    link.href = msg.attachment_url;
                    link.target = '_blank';
                    link.rel = 'noreferrer';
                    link.textContent = 'Anexo';
                    attach.appendChild(link);
                    wrapper.appendChild(attach);
                }

                const time = document.createElement('div');
                time.className = 'chat-time';
                time.textContent = msg.created_at;
                wrapper.appendChild(time);

                container.appendChild(wrapper);
            });
        };

        const renderTimeline = (container, timeline) => {
            if (!container) return;
            container.innerHTML = '';
            if (!timeline.length) {
                const empty = document.createElement('div');
                empty.className = 'ticket-empty';
                empty.textContent = 'Sem histórico registrado.';
                container.appendChild(empty);
                return;
            }
            timeline.forEach((row) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'chat-message';

                const header = document.createElement('div');
                header.className = 'chat-author';
                header.textContent = `${row.event_type} • ${row.actor || '-'}`;
                wrapper.appendChild(header);

                const transition = document.createElement('div');
                transition.className = 'chat-text';
                transition.textContent = `${row.from_status || '-'} -> ${row.to_status || '-'}`;
                wrapper.appendChild(transition);

                if (row.note) {
                    const note = document.createElement('div');
                    note.className = 'chat-text';
                    note.textContent = row.note;
                    wrapper.appendChild(note);
                }

                const time = document.createElement('div');
                time.className = 'chat-time';
                time.textContent = row.created_at;
                wrapper.appendChild(time);

                container.appendChild(wrapper);
            });
        };

        const loadDetails = async (ticketId) => {
            const response = await fetch(`/chamados/detalhe/${ticketId}/`);
            if (!response.ok) return;
            const data = await response.json();
            if (!data.ok) return;

            setText('[data-detail-id]', data.ticket.id);
            setText('[data-detail-title]', data.ticket.title);
            setText('[data-detail-description]', data.ticket.description);
            setText('[data-detail-type]', data.ticket.ticket_type);
            setText('[data-detail-urgency]', data.ticket.urgency);
            setText('[data-detail-status]', data.ticket.status);
            setText('[data-detail-created-by]', data.ticket.created_by);
            setText('[data-detail-assignees]', data.ticket.assignees);
            setText('[data-detail-resolution]', data.ticket.resolution);

            const attachLink = detailsModal.querySelector('[data-detail-attachment]');
            const noAttach = detailsModal.querySelector('[data-detail-no-attachment]');
            if (data.ticket.attachment_url) {
                attachLink.href = data.ticket.attachment_url;
                attachLink.style.display = 'inline';
                noAttach.style.display = 'none';
            } else {
                attachLink.style.display = 'none';
                noAttach.style.display = 'inline';
            }

            renderMessages(detailsModal.querySelector('[data-chat-public]'), data.messages.public || []);
            renderMessages(detailsModal.querySelector('[data-chat-internal]'), data.messages.internal || []);
            renderTimeline(detailsModal.querySelector('[data-ticket-timeline]'), data.timeline || []);

            const internalSection = detailsModal.querySelector('[data-chat-internal-section]');
            if (internalSection) {
                internalSection.style.display = data.internal_allowed ? 'block' : 'none';
            }

            const reclassForm = detailsModal.querySelector('[data-reclassify-form]');
            if (reclassForm) {
                const typeSelect = reclassForm.querySelector('select[name="ticket_type"]');
                const urgencySelect = reclassForm.querySelector('select[name="urgency"]');
                if (typeSelect) typeSelect.value = data.ticket.ticket_type_value || 'nao_classificado';
                if (urgencySelect) urgencySelect.value = data.ticket.urgency_value || 'nao_classificado';
            }

            const editForm = detailsModal.querySelector('[data-edit-form]');
            const editToggle = detailsModal.querySelector('[data-edit-toggle]');
            if (editForm && editToggle) {
                const canEdit = !!data.ticket.can_edit;
                editForm.hidden = true;
                editToggle.hidden = !canEdit;
                const titleInput = editForm.querySelector('input[name="title"]');
                const descInput = editForm.querySelector('textarea[name="description"]');
                if (titleInput) titleInput.value = data.ticket.title || '';
                if (descInput) descInput.value = data.ticket.description || '';
                editToggle.onclick = () => {
                    if (!canEdit) return;
                    editForm.hidden = !editForm.hidden;
                };
            }

            const detailReopen = detailsModal.querySelector('[data-detail-reopen]');
            if (detailReopen) {
                const canReopen = data.ticket.status_code === 'fechado';
                detailReopen.hidden = !canReopen;
                detailReopen.onclick = async () => {
                    if (!currentTicketId) return;
                    const response = await fetch('{% url "chamados_reabrir" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                        body: new URLSearchParams({ ticket_id: currentTicketId }),
                    });
                    if (response.ok) {
                        await loadDetails(currentTicketId);
                        window.location.reload();
                    }
                };
            }
        };

        const openDetails = async (ticketId) => {
            currentTicketId = ticketId;
            detailsModal.hidden = false;
            await loadDetails(ticketId);
        };

        const closeDetails = () => {
            detailsModal.hidden = true;
            currentTicketId = null;
        };

        clickRoot.addEventListener('click', (event) => {
            if (dragging) return;
            const card = event.target.closest('.ticket-card');
            if (!card) return;
            openDetails(card.dataset.ticketId);
        });

        closeButtons.forEach((btn) => btn.addEventListener('click', closeDetails));


        const reopenButtons = document.querySelectorAll('[data-reopen-ticket]');
        reopenButtons.forEach((btn) => {
            btn.addEventListener('click', async (event) => {
                event.preventDefault();
                const ticketId = btn.dataset.ticketId;
                if (!ticketId) return;
                const response = await fetch('{% url "chamados_reabrir" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: new URLSearchParams({ ticket_id: ticketId }),
                });
                if (response.ok) {
                    window.location.reload();
                }
            });
        });

        detailsModal.querySelectorAll('[data-chat-form]').forEach((form) => {
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!currentTicketId) return;
                const formData = new FormData(form);
                formData.append('ticket_id', currentTicketId);
                formData.append('internal', form.dataset.internal || '0');

                const response = await fetch('{% url "chamados_mensagem" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: formData,
                });

                if (response.ok) {
                    form.reset();
                    await loadDetails(currentTicketId);
                }
            });
        });

        const reclassForm = detailsModal.querySelector('[data-reclassify-form]');
        if (reclassForm) {
            reclassForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!currentTicketId) return;
                const formData = new FormData(reclassForm);
                formData.append('ticket_id', currentTicketId);

                const response = await fetch('{% url "chamados_reclassificar" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: formData,
                });

                if (response.ok) {
                    await loadDetails(currentTicketId);
                    return;
                }
                let errorMsg = 'Não foi possível reclassificar.';
                try {
                    const data = await response.json();
                    if (data && data.error) {
                        errorMsg += ` (${data.error})`;
                    }
                } catch (err) {
                    // ignore parse errors
                }
                alert(errorMsg);
            });
        }

        const editForm = detailsModal.querySelector('[data-edit-form]');
        if (editForm) {
            editForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!currentTicketId) return;
                const formData = new FormData(editForm);
                formData.append('ticket_id', currentTicketId);
                const response = await fetch('{% url "chamados_atualizar" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: formData,
                });
                if (response.ok) {
                    const newTitle = (formData.get('title') || '').toString();
                    const newDesc = (formData.get('description') || '').toString();
                    setText('[data-detail-title]', newTitle);
                    setText('[data-detail-description]', newDesc);
                    document.querySelectorAll(`.ticket-card[data-ticket-id="${currentTicketId}"] .ticket-title`).forEach((el) => {
                        const prefix = `#${currentTicketId} - ${newTitle}`;
                        const textNodes = Array.from(el.childNodes).filter((node) => node.nodeType === Node.TEXT_NODE);
                        if (textNodes.length) {
                            textNodes[textNodes.length - 1].textContent = ` ${prefix}`;
                        } else {
                            el.appendChild(document.createTextNode(` ${prefix}`));
                        }
                    });
                    await loadDetails(currentTicketId);
                }
            });
        }
    })();
</script>
<script>
    (function () {
        const modal = document.querySelector('[data-email-modal]');
        const openBtn = document.querySelector('[data-open-email]');
        const closeEls = document.querySelectorAll('[data-close-email]');
        if (!modal || !openBtn) return;

        const open = () => {
            modal.hidden = false;
        };
        const close = () => {
            modal.hidden = true;
        };

        openBtn.addEventListener('click', open);
        closeEls.forEach((el) => el.addEventListener('click', close));
    })();
</script>
<script>
    (function () {
        const lookupBtn = document.querySelector('[data-wa-group-lookup]');
        const nameInput = document.querySelector('#id_wa_group_name');
        const jidInput = document.querySelector('#id_wa_group_jid');
        const resultEl = document.querySelector('[data-wa-group-result]');
        if (!lookupBtn || !nameInput || !jidInput || !resultEl) return;

        const getCookie = (name) => {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return '';
        };

        lookupBtn.addEventListener('click', async () => {
            const groupName = (nameInput.value || '').trim();
            if (!groupName) {
                resultEl.textContent = 'Informe o nome do grupo para buscar.';
                return;
            }

            resultEl.textContent = 'Buscando grupo...';
            try {
                const response = await fetch('{% url "chamados_whatsapp_group_lookup" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: new URLSearchParams({ group_name: groupName }),
                });
                const data = await response.json();
                if (!response.ok || !data.ok) {
                    resultEl.textContent = `Falha ao buscar grupo: ${data.detail || data.error || 'erro desconhecido'}`;
                    return;
                }
                if (!data.found) {
                    resultEl.textContent = 'Nenhum grupo encontrado com esse nome.';
                    return;
                }
                jidInput.value = data.jid || '';
                const total = Array.isArray(data.matches) ? data.matches.length : 0;
                resultEl.textContent = `Grupo selecionado: ${data.name} (${data.jid})` + (total > 1 ? ` | ${total} correspondencias` : '');
            } catch (error) {
                resultEl.textContent = `Erro de rede ao buscar grupo: ${error}`;
            }
        });
    })();
</script>
{% if is_ti_group %}
    <script>
        (function () {
            const REFRESH_MS = 3000;
            const isTyping = () => {
                const active = document.activeElement;
                if (!active) return false;
                const tag = (active.tagName || '').toLowerCase();
                return tag === 'input' || tag === 'textarea' || active.isContentEditable;
            };
            const hasOpenModal = () =>
                Array.from(document.querySelectorAll('.modal')).some((modal) => !modal.hidden);

            setInterval(() => {
                if (document.hidden) return;
                if (isTyping()) return;
                if (hasOpenModal()) return;
                window.location.reload();
            }, REFRESH_MS);
        })();
    </script>
{% endif %}
{% endblock %}
