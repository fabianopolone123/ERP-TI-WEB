{% extends "base.html" %}
{% load core_extras %}

{% block title %}Chamados | ERP TI{% endblock %}

{% block content %}
<style>
    [data-board].kanban {
        width: 100%;
        grid-template-columns: repeat(var(--regular-cols, 1), minmax(0, 1fr)) !important;
    }
    [data-board] .kanban-column {
        min-width: 0;
        height: var(--board-col-height, 560px);
    }
    [data-board] .ticket-card,
    [data-ticket-list] .ticket-card {
        padding: 8px 9px;
    }
    [data-board] .ticket-card.playing {
        box-shadow: 0 6px 16px rgba(2, 6, 23, 0.35);
    }
    [data-board] .ticket-card.playing [data-ticket-pause] {
        background: #dc2626 !important;
        border-color: #ef4444 !important;
        color: #fff !important;
    }
    [data-board] .ticket-card.playing [data-ticket-pause]:hover {
        background: #b91c1c !important;
        border-color: #f87171 !important;
    }
    [data-board] .ticket-card.urgency-bg-programada,
    [data-ticket-list] .ticket-card.urgency-bg-programada {
        background: linear-gradient(135deg, rgba(14, 116, 144, 0.34) 0%, rgba(15, 23, 42, 0.94) 100%) !important;
        border-color: rgba(34, 211, 238, 0.55) !important;
    }
    [data-board] .ticket-card.urgency-bg-baixa,
    [data-ticket-list] .ticket-card.urgency-bg-baixa {
        background: linear-gradient(135deg, rgba(21, 128, 61, 0.32) 0%, rgba(15, 23, 42, 0.94) 100%) !important;
        border-color: rgba(74, 222, 128, 0.52) !important;
    }
    [data-board] .ticket-card.urgency-bg-media,
    [data-ticket-list] .ticket-card.urgency-bg-media {
        background: linear-gradient(135deg, rgba(180, 83, 9, 0.34) 0%, rgba(15, 23, 42, 0.94) 100%) !important;
        border-color: rgba(251, 191, 36, 0.55) !important;
    }
    [data-board] .ticket-card.urgency-bg-alta,
    [data-ticket-list] .ticket-card.urgency-bg-alta {
        background: linear-gradient(135deg, rgba(153, 27, 27, 0.38) 0%, rgba(15, 23, 42, 0.94) 100%) !important;
        border-color: rgba(248, 113, 113, 0.58) !important;
    }
    [data-board] .ticket-card.urgency-bg-nao_classificado,
    [data-ticket-list] .ticket-card.urgency-bg-nao_classificado {
        background: linear-gradient(135deg, rgba(51, 65, 85, 0.38) 0%, rgba(15, 23, 42, 0.94) 100%) !important;
        border-color: rgba(148, 163, 184, 0.52) !important;
    }
    [data-board] .ticket-title,
    [data-ticket-list] .ticket-title {
        margin-bottom: 4px;
        font-size: 0.92rem;
        line-height: 1.2;
    }
    .ticket-meta-rich {
        display: flex;
        align-items: center;
        gap: 6px;
        min-width: 0;
        font-size: 0.78rem;
        text-transform: none;
    }
    .ticket-requester {
        font-weight: 800;
        color: #e2e8f0;
        background: rgba(56, 189, 248, 0.14);
        border: 1px solid rgba(56, 189, 248, 0.4);
        border-radius: 8px;
        padding: 1px 6px;
        display: inline-flex;
        max-width: 56%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .ticket-extra {
        color: #93a4bf;
        line-height: 1.1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 44%;
    }
    .detail-description-block {
        margin-top: 6px;
        margin-bottom: 8px;
        padding: 12px 14px;
        border-radius: 10px;
        border: 1px solid #60a5fa;
        border-left: 6px solid #3b82f6;
        background: rgba(30, 64, 175, 0.24);
    }
    .detail-description-label {
        font-size: 0.78rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: #93c5fd;
        margin-bottom: 6px;
    }
    .detail-description-text {
        color: #f8fafc;
        font-weight: 700;
        font-size: 0.98rem;
        line-height: 1.5;
        white-space: pre-wrap;
    }
    .ticket-open-counter {
        margin-left: 0;
        font-size: 0.64rem;
        font-weight: 700;
        color: #99f6e4;
        background: rgba(20, 184, 166, 0.18);
        border: 1px solid rgba(20, 184, 166, 0.5);
        border-radius: 999px;
        padding: 2px 6px;
        white-space: nowrap;
    }
    .ticket-timing-row {
        display: flex;
        align-items: center;
        margin-top: 4px;
        min-height: 20px;
    }
    .ticket-main-row {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(128px, 52%);
        gap: 6px;
        align-items: start;
    }
    .ticket-main-left {
        min-width: 0;
    }
    .ticket-main-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 3px;
        min-width: 128px;
        max-width: 52%;
    }
    .ticket-main-right .ticket-requester {
        max-width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: right;
        line-height: 1.05;
        font-size: 0.8rem;
    }
    .ticket-main-right .ticket-extra {
        max-width: 100%;
        text-align: right;
    }
    .ticket-main-right .ticket-timing-row {
        justify-content: flex-end;
        width: 100%;
        margin-top: 2px;
    }
    .ticket-timer-controls {
        margin-top: 4px !important;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: nowrap;
        width: 100%;
    }
    .ticket-last-action {
        flex: 1 1 auto;
        min-width: 0;
        font-size: 0.72rem;
        color: #cbd5e1;
        text-transform: none;
        white-space: normal;
        line-height: 1.2;
        max-height: 2.4em;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        opacity: 0.95;
    }
    .ticket-shared-note {
        margin-top: 4px;
        font-size: 0.68rem;
        font-weight: 700;
        color: #f59e0b;
        letter-spacing: 0.01em;
        text-transform: uppercase;
        line-height: 1.2;
    }
    .ticket-legend-inline {
        margin-left: auto;
        margin-right: 10px;
        padding: 8px 10px;
        font-size: 0.78rem;
    }
    .ticket-legend-inline .legend-items {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    .ticket-legend-inline .legend-row {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 4px;
    }
    .ticket-create-modal .modal-content {
        width: min(720px, 92vw);
        padding: 16px 18px 14px;
    }
    .ticket-create-header {
        margin-bottom: 10px !important;
        align-items: flex-start;
    }
    .ticket-create-header h3 {
        margin: 0;
    }
    .ticket-create-inline {
        display: grid;
        grid-template-columns: 170px minmax(220px, 1fr);
        gap: 8px;
        width: min(430px, 100%);
    }
    .ticket-create-inline input,
    .ticket-create-inline select {
        margin: 0;
    }
    .ticket-create-form .ticket-create-field {
        margin-bottom: 8px;
    }
    .ticket-create-form .ticket-create-field > label {
        display: block;
        margin-bottom: 4px;
    }
    .ticket-create-form .ticket-create-field input,
    .ticket-create-form .ticket-create-field select,
    .ticket-create-form .ticket-create-field textarea {
        margin: 0;
    }
    .ticket-create-form textarea {
        min-height: 104px;
        resize: vertical;
    }
    .ticket-create-actions {
        margin-top: 10px;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 10px;
    }
    @media (max-width: 760px) {
        .ticket-create-inline {
            grid-template-columns: 1fr;
        }
    }
</style>
<div class="card">
    <div class="topbar">
        <div>
            <h2>Chamados</h2>
        </div>
        <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
            {% if is_ti_group %}
                <div class="ticket-legend ticket-legend-inline">
                    <strong>Legenda</strong>
                    <div class="legend-row">
                        <div class="legend-items">
                            <span><span class="urgency-dot urgency-programada"></span> Programada</span>
                            <span><span class="urgency-dot urgency-baixa"></span> Baixa</span>
                            <span><span class="urgency-dot urgency-media"></span> Média</span>
                            <span><span class="urgency-dot urgency-alta"></span> Alta</span>
                            <span><span class="urgency-dot urgency-nao_classificado"></span> Não classificado</span>
                        </div>
                        <label for="id_refresh_seconds" style="display:flex; align-items:center; gap:6px; font-size:0.82rem; color:#93a4bf;">
                            Atualizar a cada
                            <input
                                id="id_refresh_seconds"
                                type="number"
                                min="3"
                                max="300"
                                step="1"
                                value="10"
                                style="width:70px; padding:6px 8px; margin: 0;"
                            />
                            s
                        </label>
                    </div>
                </div>
                <div style="display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
                    <button type="button" data-open-whatsapp>WhatsApp</button>
                    <button type="button" data-open-email>E-mail</button>
                    <button type="button" data-open-planilha>Planilha</button>
                    <button type="button" data-open-modal>Abrir chamado</button>
                </div>
            {% endif %}
            <form method="post" action="{% url 'logout' %}" class="inline-form">
                {% csrf_token %}
                <button type="submit">Sair</button>
            </form>
        </div>
    </div>

    {% if is_ti_group %}
        {% include "core/_tabs.html" %}

        <div class="kanban" data-board>
            <div class="kanban-column" data-target="novo">
                <div class="kanban-header">Pendente</div>
                <div class="kanban-body">
                    {% for ticket in new_tickets %}
                        <div class="ticket-card urgency-bg-{{ ticket.urgency }}{% if ticket_meta|get_item:ticket.id|default:''|get_item:'is_multi_attendant' %} shared-ticket{% endif %}" draggable="true" data-ticket-id="{{ ticket.id }}" data-ticket-status="{{ ticket.status }}" data-opened-at="{{ ticket.created_at|date:'c' }}" data-failure-type="{{ ticket_meta|get_item:ticket.id|default:''|get_item:'failure_type' }}">
                            <div class="ticket-title">
                                <span class="urgency-dot urgency-{{ ticket.urgency }}"></span>
                                #{{ ticket.id }} - {{ ticket.title }}
                                {% if ticket_meta|get_item:ticket.id|default:''|get_item:'is_multi_attendant' %}
                                    <span class="status-pill status-shared">Compartilhado</span>
                                {% endif %}
                            </div>
                            {% if is_ti_group %}
                                <div class="ticket-meta ticket-meta-rich">
                                    <span class="ticket-requester">{{ ticket_meta|get_item:ticket.id|default:""|get_item:'requester' }}</span>
                                    <span class="ticket-extra">
                                        {% if ticket_meta|get_item:ticket.id|default:""|get_item:'department' %}
                                            {{ ticket_meta|get_item:ticket.id|default:""|get_item:'department' }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </span>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>

            {% for user in ti_users %}
                <div class="kanban-column" data-target="user_{{ user.id }}">
                    <div class="kanban-header">{{ user.full_name }}</div>
                    <div class="kanban-body">
                        {% for ticket in user_tickets|get_item:user.id %}
                            <div class="ticket-card urgency-bg-{{ ticket.urgency }}{% if ticket_meta|get_item:ticket.id|default:''|get_item:'is_multi_attendant' %} shared-ticket{% endif %}{% if ticket_cycle_map|get_item:ticket.id|default:''|get_item:user.id %} playing{% endif %}" draggable="true" data-ticket-id="{{ ticket.id }}" data-ticket-status="{{ ticket.status }}" data-opened-at="{{ ticket.created_at|date:'c' }}" data-failure-type="{{ ticket_meta|get_item:ticket.id|default:''|get_item:'failure_type' }}" data-last-action="{{ ticket_meta|get_item:ticket.id|default:''|get_item:'last_action_text'|default:''|escape }}" data-cycle-running="{% if ticket_cycle_map|get_item:ticket.id|default:''|get_item:user.id %}1{% else %}0{% endif %}">
                                <div class="ticket-main-row">
                                    <div class="ticket-main-left">
                                        <div class="ticket-title">
                                            <span class="urgency-dot urgency-{{ ticket.urgency }}"></span>
                                            #{{ ticket.id }} - {{ ticket.title }}
                                        </div>
                                    </div>
                                    <div class="ticket-main-right">
                                        <span class="ticket-requester">{{ ticket_meta|get_item:ticket.id|default:""|get_item:'requester' }}</span>
                                        <span class="ticket-extra">
                                            {% if ticket_meta|get_item:ticket.id|default:""|get_item:'department' %}
                                                {{ ticket_meta|get_item:ticket.id|default:""|get_item:'department' }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </span>
                                        <div class="ticket-timing-row">
                                            <span class="ticket-open-counter"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="ticket-meta ticket-timer-controls" style="margin-top: 6px;">
                                    <button type="button" data-ticket-play data-ticket-id="{{ ticket.id }}" {% if ticket_cycle_map|get_item:ticket.id|default:''|get_item:user.id %}style="display:none;"{% endif %}>Play</button>
                                    <button type="button" data-ticket-pause data-ticket-id="{{ ticket.id }}" {% if not ticket_cycle_map|get_item:ticket.id|default:''|get_item:user.id %}style="display:none;"{% endif %}>Pause</button>
                                    <span class="ticket-last-action" title="{{ ticket_meta|get_item:ticket.id|default:''|get_item:'last_action_text'|default:'' }}">{{ ticket_meta|get_item:ticket.id|default:''|get_item:'last_action_text'|default:'' }}</span>
                                </div>
                                {% if ticket_meta|get_item:ticket.id|default:''|get_item:'is_multi_attendant' %}
                                    <div class="ticket-shared-note">Outro atendente também está trabalhando</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}

            <div class="kanban-column" data-target="fechado">
                <div class="kanban-header">Fechados</div>
                <div style="padding: 8px 10px 0;">
                    <input
                        type="text"
                        class="table-search"
                        placeholder="Pesquisar em finalizados..."
                        data-closed-search
                        style="max-width: 100%; width: 100%; margin: 0;"
                    />
                </div>
                <div class="kanban-body">
                    {% for ticket in closed_tickets %}
                        <div class="ticket-card urgency-bg-{{ ticket.urgency }}{% if ticket_meta|get_item:ticket.id|default:''|get_item:'is_multi_attendant' %} shared-ticket{% endif %}" draggable="true" data-ticket-id="{{ ticket.id }}" data-ticket-status="{{ ticket.status }}" data-opened-at="{{ ticket.created_at|date:'c' }}" data-failure-type="{{ ticket_meta|get_item:ticket.id|default:''|get_item:'failure_type' }}" data-ticket-description="{{ ticket_meta|get_item:ticket.id|default:''|get_item:'description'|default:''|escape }}">
                            <div class="ticket-title">
                                <span class="urgency-dot urgency-{{ ticket.urgency }}"></span>
                                #{{ ticket.id }} - {{ ticket.title }}
                                {% if ticket_meta|get_item:ticket.id|default:''|get_item:'is_multi_attendant' %}
                                    <span class="status-pill status-shared">Compartilhado</span>
                                {% endif %}
                            </div>
                            <div class="ticket-meta ticket-meta-rich">
                                <span class="ticket-requester">{{ ticket_meta|get_item:ticket.id|default:""|get_item:'requester' }}</span>
                                <span class="ticket-extra">
                                    {% if ticket_meta|get_item:ticket.id|default:""|get_item:'department' %}
                                        {{ ticket_meta|get_item:ticket.id|default:""|get_item:'department' }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

        </div>
    {% else %}
        <div class="topbar" style="margin-top: 16px;">
            <h3>Meus chamados</h3>
            <button type="button" data-open-modal>Abrir chamado</button>
        </div>

        <div class="kanban" data-ticket-list>
            <div class="kanban-column">
                <div class="kanban-header">Solicitações</div>
                <div class="kanban-body">
                    {% for ticket in own_tickets %}
                        <div class="ticket-card urgency-bg-{{ ticket.urgency }}" data-ticket-id="{{ ticket.id }}" data-ticket-status="{{ ticket.status }}" data-opened-at="{{ ticket.created_at|date:'c' }}">
                            <div class="ticket-title">
                                <span class="urgency-dot urgency-{{ ticket.urgency }}"></span>
                                #{{ ticket.id }} - {{ ticket.title }}
                                <span class="status-pill status-{{ ticket.status }}">{{ ticket.get_status_display }}</span>
                            </div>
                            <div class="ticket-meta ticket-meta-rich">
                                <span class="ticket-requester">{{ ticket_meta|get_item:ticket.id|default:""|get_item:'requester' }}</span>
                                <span class="ticket-extra">
                                    {% if ticket_meta|get_item:ticket.id|default:""|get_item:'department' %}
                                        {{ ticket_meta|get_item:ticket.id|default:""|get_item:'department' }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </span>
                            </div>
                            {% if ticket.status == 'fechado' %}
                                <div class="ticket-meta" style="margin-top: 6px;">
                                    <button type="button" data-reopen-ticket data-ticket-id="{{ ticket.id }}">Reabrir chamado</button>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}
</div>

<div class="modal ticket-create-modal" data-modal hidden>
    <div class="modal-backdrop" data-close-modal></div>
    <div class="modal-content">
        <div class="topbar ticket-create-header">
            <h3>Abrir chamado</h3>
            {% if is_ti_group %}
                <div class="ticket-create-inline">
                    <input id="id_opened_at" name="opened_at" type="datetime-local" value="{{ ti_opened_at_default }}" form="ticket-create-form" />
                    <select id="id_requester_user_id" name="requester_user_id" form="ticket-create-form">
                        {% for req_user in ti_requesters %}
                            <option value="{{ req_user.id }}" {% if req_user.username|default:''|lower == request.user.username|default:''|lower %}selected{% endif %}>
                                {{ req_user.full_name|default:req_user.username }}{% if req_user.username %} ({{ req_user.username }}){% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}
        </div>
        <form id="ticket-create-form" class="ticket-create-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="ticket-create-field">
                <label for="id_title">Título</label>
                <input id="id_title" name="title" type="text" required />
            </div>
            <div class="ticket-create-field">
                <label for="id_type">Tipo</label>
                <select id="id_type" name="ticket_type" required>
                    <option value="requisicao">Requisição</option>
                    <option value="melhoria">Melhoria</option>
                    <option value="incidente">Incidente</option>
                    <option value="programado">Programado</option>
                </select>
            </div>
            <div class="ticket-create-field">
                <label for="id_urgency">Urgência</label>
                <select id="id_urgency" name="urgency" required>
                    <option value="programada">Programada</option>
                    <option value="baixa">Baixa</option>
                    <option value="media">Média</option>
                    <option value="alta">Alta</option>
                </select>
            </div>
            {% if not is_ti_group %}
                <div class="ticket-legend">
                    <strong>Legenda de urgência</strong>
                    <ul>
                        <li><span class="urgency-dot urgency-programada"></span> <strong>Programada:</strong> menor prioridade, pode ser agendada.</li>
                        <li><span class="urgency-dot urgency-baixa"></span> <strong>Baixa:</strong> impacto pequeno e localizado.</li>
                        <li><span class="urgency-dot urgency-media"></span> <strong>Média:</strong> impacto no time/área, precisa atenção.</li>
                        <li><span class="urgency-dot urgency-alta"></span> <strong>Alta:</strong> várias pessoas ou setor parado.</li>
                    </ul>
                </div>
            {% endif %}
            <div class="ticket-create-field">
                <label for="id_desc">Descrição</label>
                <textarea id="id_desc" name="description" rows="4" required></textarea>
            </div>
            <div class="ticket-create-field">
                <label for="id_attach">Anexo</label>
                <input id="id_attach" name="attachment" type="file" />
            </div>
            <div class="ticket-create-actions">
                <button type="submit">Abrir chamado</button>
                <button type="button" data-close-modal>Fechar</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" data-details-modal hidden>
    <div class="modal-backdrop" data-close-details></div>
    <div class="modal-content">
        <div class="topbar" style="margin-bottom: 8px;">
            <h3>Chamado #<span data-detail-id></span></h3>
            <button type="button" data-close-details>Fechar</button>
        </div>
        <div class="ticket-details">
            <div><strong>Título:</strong> <span data-detail-title></span></div>
            <div class="detail-description-block">
                <div class="detail-description-label">Descrição do problema</div>
                <div class="detail-description-text" data-detail-description></div>
            </div>
            <div><strong>Tipo:</strong> <span data-detail-type></span></div>
            <div><strong>Urgência:</strong> <span data-detail-urgency></span></div>
            <div><strong>Status:</strong> <span data-detail-status></span></div>
            <div><strong>Solicitante:</strong> <span data-detail-created-by></span></div>
            <div><strong>Responsáveis:</strong> <span data-detail-assignees></span></div>
            <div><strong>Resolução:</strong> <span data-detail-resolution></span></div>
            <div>
                <strong>Anexo:</strong>
                <a href="#" data-detail-attachment target="_blank" rel="noreferrer">abrir</a>
                <span data-detail-no-attachment>-</span>
            </div>
        </div>
        <div style="margin-top: 12px;">
            <strong>Timeline</strong>
            <div class="chat-list" data-ticket-timeline></div>
        </div>
        <form class="ticket-edit" data-edit-form hidden>
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_edit_title">Título</label>
                        <input id="id_edit_title" name="title" type="text" required />
                    </div>
                </div>
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_edit_desc">Descrição</label>
                        <textarea id="id_edit_desc" name="description" rows="3" required></textarea>
                    </div>
                    <div style="align-self: flex-end;">
                        <button type="submit">Salvar</button>
                    </div>
                </div>
                <div class="muted" style="margin-top: 6px;">
                    Somente quem abriu o chamado pode editar.
                </div>
            </form>
            <div style="margin-top: 12px;">
                <button type="button" data-edit-toggle hidden>Editar título/descrição</button>
            </div>
        {% if not is_ti_group %}
            <div style="margin-top: 12px;">
                <button type="button" data-detail-reopen hidden>Reabrir chamado</button>
            </div>
        {% endif %}
        {% if is_ti_group %}
            <form class="ticket-reclassify" data-reclassify-form>
                <div class="form-row">
                    <div>
                        <label for="id_reclass_type">Tipo</label>
                        <select id="id_reclass_type" name="ticket_type" required>
                            <option value="nao_classificado">Não classificado</option>
                            <option value="requisicao">Requisição</option>
                            <option value="melhoria">Melhoria</option>
                            <option value="incidente">Incidente</option>
                            <option value="programado">Programado</option>
                        </select>
                    </div>
                    <div>
                        <label for="id_reclass_urgency">Urgência</label>
                        <select id="id_reclass_urgency" name="urgency" required>
                            <option value="nao_classificado">Não classificado</option>
                            <option value="programada">Programada</option>
                            <option value="baixa">Baixa</option>
                            <option value="media">Média</option>
                            <option value="alta">Alta</option>
                        </select>
                    </div>
                    <div style="align-self: flex-end; display: flex; gap: 8px;">
                        <button type="submit">Reclassificar</button>
                    </div>
                </div>
            </form>
        {% endif %}

        <div class="chat-section">
            <h4>{% if is_ti_group %}Chat público{% else %}Chat{% endif %}</h4>
            <div class="chat-messages" data-chat-public></div>
            <form class="chat-form" data-chat-form data-internal="0">
                <input type="text" name="message" placeholder="Escreva uma mensagem..." />
                <div class="chat-actions">
                    <input type="file" name="attachment" />
                    <button type="submit">Enviar</button>
                </div>
            </form>
        </div>

        {% if is_ti_group %}
            <div class="chat-section" data-chat-internal-section>
                <h4>Chat interno TI</h4>
                <div class="chat-messages" data-chat-internal></div>
                <form class="chat-form" data-chat-form data-internal="1">
                    <input type="text" name="message" placeholder="Mensagem interna..." />
                    <div class="chat-actions">
                        <input type="file" name="attachment" />
                        <button type="submit">Enviar</button>
                    </div>
                </form>
            </div>
        {% endif %}
    </div>
</div>

{% if is_ti_group %}
    <div class="modal" data-whatsapp-modal hidden>
        <div class="modal-backdrop" data-close-whatsapp></div>
        <div class="modal-content">
            <div class="topbar" style="margin-bottom: 8px;">
                <h3>WhatsApp (notificações)</h3>
                <button type="button" data-close-whatsapp>Fechar</button>
            </div>
            <div class="ticket-legend">
                <strong>Grupo atual:</strong> {{ whatsapp_group|default:"(nao configurado)" }}
                <div class="muted" style="margin-top: 6px;">
                    Placeholders disponíveis: veja a lista completa abaixo dos templates.
                </div>
            </div>
            <form method="post" action="{% url 'chamados_whatsapp_settings' %}">
                {% csrf_token %}
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_wa_group_name">Nome do grupo (buscar ID)</label>
                        <div style="display:flex; gap:8px; align-items:flex-end;">
                            <input id="id_wa_group_name" type="text" placeholder="Ex.: TI-chamados" style="flex:1;" />
                            <button type="button" data-wa-group-lookup>Buscar grupo</button>
                        </div>
                        <div class="muted" style="margin-top: 6px;" data-wa-group-result></div>
                    </div>
                    <div style="flex: 2;">
                        <label for="id_wa_group_jid">ID do grupo (JID)</label>
                        <input
                            id="id_wa_group_jid"
                            name="group_jid"
                            type="text"
                            placeholder="1203XXXXXXXXXXXX@g.us"
                            value="{{ wa_settings.group_jid|default:whatsapp_group }}"
                        />
                    </div>
                </div>
                <div class="form-row">
                    <div style="flex: 1;">
                        <label>Notificações</label>
                        <div class="ticket-legend" style="margin-top: 8px;">
                            <div style="display:grid; grid-template-columns: 1fr 140px 140px; gap: 6px 12px; align-items: center;">
                                <div></div>
                                <div style="text-align:center; font-weight:600;">Grupo</div>
                                <div style="text-align:center; font-weight:600;">Atendentes</div>

                                <div>Novo chamado</div>
                                <div style="text-align:center;"><input type="checkbox" name="send_group_on_new_ticket" {% if wa_settings.send_group_on_new_ticket %}checked{% endif %} /></div>
                                <div style="text-align:center;"><input type="checkbox" name="send_individual_on_new_ticket" {% if wa_settings.send_individual_on_new_ticket %}checked{% endif %} /></div>

                                <div>Status pendente</div>
                                <div style="text-align:center;"><input type="checkbox" name="send_group_on_status_pending" {% if wa_settings.send_group_on_status_pending %}checked{% endif %} /></div>
                                <div style="text-align:center;"><input type="checkbox" name="send_individual_on_status_pending" {% if wa_settings.send_individual_on_status_pending %}checked{% endif %} /></div>

                                <div>Transferido para outro atendente</div>
                                <div style="text-align:center;"><input type="checkbox" name="send_group_on_assignment_changed" {% if wa_settings.send_group_on_assignment_changed %}checked{% endif %} /></div>
                                <div style="text-align:center;"><input type="checkbox" name="send_individual_on_assignment_changed" {% if wa_settings.send_individual_on_assignment_changed %}checked{% endif %} /></div>

                                <div>Responsável definido (em atendimento)</div>
                                <div style="text-align:center;"><input type="checkbox" name="send_group_on_assignment_new" {% if wa_settings.send_group_on_assignment_new %}checked{% endif %} /></div>
                                <div style="text-align:center;"><input type="checkbox" name="send_individual_on_assignment_new" {% if wa_settings.send_individual_on_assignment_new %}checked{% endif %} /></div>

                                <div>Status em atendimento</div>
                                <div style="text-align:center;"><input type="checkbox" name="send_group_on_status_in_progress" {% if wa_settings.send_group_on_status_in_progress %}checked{% endif %} /></div>
                                <div style="text-align:center;"><input type="checkbox" name="send_individual_on_status_in_progress" {% if wa_settings.send_individual_on_status_in_progress %}checked{% endif %} /></div>

                                <div>Status fechado</div>
                                <div style="text-align:center;"><input type="checkbox" name="send_group_on_status_closed" {% if wa_settings.send_group_on_status_closed %}checked{% endif %} /></div>
                                <div style="text-align:center;"><input type="checkbox" name="send_individual_on_status_closed" {% if wa_settings.send_individual_on_status_closed %}checked{% endif %} /></div>

                                <div>Nova mensagem interna TI</div>
                                <div style="text-align:center;"><input type="checkbox" name="send_group_on_message_internal" {% if wa_settings.send_group_on_message_internal %}checked{% endif %} /></div>
                                <div style="text-align:center;"><input type="checkbox" name="send_individual_on_message_internal" {% if wa_settings.send_individual_on_message_internal %}checked{% endif %} /></div>

                                <div>Nova mensagem do usuário</div>
                                <div style="text-align:center;"><input type="checkbox" name="send_group_on_message_user" {% if wa_settings.send_group_on_message_user %}checked{% endif %} /></div>
                                <div style="text-align:center;"><input type="checkbox" name="send_individual_on_message_user" {% if wa_settings.send_individual_on_message_user %}checked{% endif %} /></div>
                            </div>
                        </div>
                    </div>
                </div>
                <button type="submit">Salvar regras</button>
            </form>
            <form method="post" action="{% url 'chamados_whatsapp_templates' %}">
                {% csrf_token %}
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_wa_new">Novo chamado</label>
                        <textarea id="id_wa_new" name="template_new_ticket" rows="2" placeholder="Novo chamado #{id}: {title} | Solicitante: {solicitante} | Tipo: {tipo} | Urgência: {urgencia} | {description}">{{ wa_templates.new_ticket }}</textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_wa_status">Status atualizado</label>
                        <textarea id="id_wa_status" name="template_status_update" rows="2" placeholder="Chamado #{id} atualizado: {status} | Responsável: {responsavel} | Solicitante: {solicitante}">{{ wa_templates.status_update }}</textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_wa_msg">Nova mensagem</label>
                        <textarea id="id_wa_msg" name="template_new_message" rows="2" placeholder="Nova mensagem no chamado #{id}: {message} | Solicitante: {solicitante}">{{ wa_templates.new_message }}</textarea>
                    </div>
                </div>
                <div class="ticket-legend" style="margin-bottom: 10px;">
                    <strong>Placeholders disponíveis</strong>
                    <div class="muted" style="margin-top:6px;">
                        <code>{id}</code>, <code>{ticket_id}</code>, <code>{title}</code>, <code>{titulo}</code>, <code>{description}</code>, <code>{descricao}</code>, <code>{status}</code>, <code>{tipo}</code>, <code>{urgencia}</code>, <code>{responsavel}</code>, <code>{responsavel_usuario}</code>, <code>{solicitante}</code>, <code>{solicitante_usuario}</code>, <code>{solicitante_email}</code>, <code>{colaboradores}</code>, <code>{message}</code>, <code>{mensagem}</code>, <code>{criado_em}</code>, <code>{atualizado_em}</code>, <code>{resolucao}</code>, <code>{link}</code>
                    </div>
                </div>
                <button type="submit">Salvar templates</button>
            </form>
            <div class="ticket-legend" style="margin-top: 12px;">
                <strong>Atendentes TI (WhatsApp)</strong>
                <div class="muted" style="margin-top: 6px;">Somente visualização para validar nome e telefone.</div>
            </div>
            <div class="form-row">
                <div style="flex: 1; min-width: 260px;">
                    {% for contact in wa_contacts %}
                        <div style="margin-bottom:6px;">
                            {{ contact.name }}{% if contact.phone %} - {{ contact.phone }}{% endif %}
                        </div>
                    {% empty %}
                        <div class="muted">Nenhum atendente TI encontrado.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{% endif %}

{% if is_ti_group %}
    <div class="modal" data-email-modal hidden>
        <div class="modal-backdrop" data-close-email></div>
        <div class="modal-content">
            <div class="topbar" style="margin-bottom: 8px;">
                <h3>E-mail (notificações)</h3>
                <button type="button" data-close-email>Fechar</button>
            </div>
            <div class="ticket-legend">
                <strong>Placeholders disponíveis:</strong> {id}, {title}, {description}, {status}, {responsavel}, {message}
            </div>
            <form method="post" action="{% url 'chamados_email_templates' %}">
                {% csrf_token %}
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_email_new_subject">Assunto - Novo chamado</label>
                        <input id="id_email_new_subject" name="email_new_ticket_subject" type="text" placeholder="[Chamado #{id}] Novo chamado" value="{{ email_templates.new_ticket_subject }}" />
                    </div>
                    <div style="flex: 3;">
                        <label for="id_email_new_body">Corpo - Novo chamado</label>
                        <textarea id="id_email_new_body" name="email_new_ticket_body" rows="2" placeholder="Novo chamado #{id}: {title}\n{description}">{{ email_templates.new_ticket_body }}</textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_email_status_subject">Assunto - Status atualizado</label>
                        <input id="id_email_status_subject" name="email_status_update_subject" type="text" placeholder="[Chamado #{id}] Status atualizado" value="{{ email_templates.status_update_subject }}" />
                    </div>
                    <div style="flex: 3;">
                        <label for="id_email_status_body">Corpo - Status atualizado</label>
                        <textarea id="id_email_status_body" name="email_status_update_body" rows="2" placeholder="Status atual: {status}\nResponsável: {responsavel}">{{ email_templates.status_update_body }}</textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_email_msg_subject">Assunto - Nova mensagem</label>
                        <input id="id_email_msg_subject" name="email_new_message_subject" type="text" placeholder="[Chamado #{id}] Nova mensagem" value="{{ email_templates.new_message_subject }}" />
                    </div>
                    <div style="flex: 3;">
                        <label for="id_email_msg_body">Corpo - Nova mensagem</label>
                        <textarea id="id_email_msg_body" name="email_new_message_body" rows="2" placeholder="Nova mensagem: {message}">{{ email_templates.new_message_body }}</textarea>
                    </div>
                </div>
                <button type="submit">Salvar templates</button>
            </form>
        </div>
    </div>
{% endif %}
{% if is_ti_group %}
    <div class="modal" data-planilha-modal hidden>
        <div class="modal-backdrop" data-close-planilha></div>
        <div class="modal-content">
            <div class="topbar" style="margin-bottom: 8px;">
                <h3>Preencher planilha</h3>
                <button type="button" data-close-planilha>Fechar</button>
            </div>
            <form method="post" action="{% url 'chamados_preencher_planilha' %}">
                {% csrf_token %}
                <div class="form-row">
                    <div>
                        <label for="id_planilha_atendente">Atendente</label>
                        <select id="id_planilha_atendente" name="attendant_id" required>
                            <option value="">Selecione...</option>
                            {% for user in ti_users %}
                                <option value="{{ user.id }}" data-last-path="{{ attendant_last_workbook_paths|get_item:user.id|default:'' }}">{{ user.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="flex: 2;">
                        <label for="id_planilha_caminho">Caminho da planilha</label>
                        <input
                            id="id_planilha_caminho"
                            name="workbook_path"
                            type="text"
                            value="{{ chamados_xlsx_default_path }}"
                            placeholder="S:\TI\Documentos\Chamados\Chamados 2026 - Fabiano.xlsx"
                        />
                    </div>
                </div>
                <button type="submit">Preencher planilha</button>
            </form>
        </div>
    </div>
{% endif %}
{% if is_ti_group %}
    <div class="modal" data-close-ticket-modal hidden>
        <div class="modal-backdrop" data-close-ticket-cancel></div>
        <div class="modal-content">
            <div class="topbar" style="margin-bottom: 8px;">
                <h3 data-close-ticket-title>Finalizar chamado</h3>
                <button type="button" data-close-ticket-cancel>Fechar</button>
            </div>
            <form data-close-ticket-form>
                <div class="form-row">
                    <div>
                        <label for="id_close_failure_type">Tipo de falha</label>
                        <select id="id_close_failure_type" name="failure_type" required>
                            <option value="">Selecione...</option>
                            <option value="na">N/A</option>
                            <option value="software">Software</option>
                            <option value="equipamento">Equipamento</option>
                            <option value="humana">Falha humana</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div style="flex: 1;">
                        <label for="id_close_resolution_text" data-close-ticket-text-label>Resolução</label>
                        <textarea id="id_close_resolution_text" name="resolution" rows="4" placeholder="Descreva a resolução..." required></textarea>
                    </div>
                </div>
                <div style="display:flex; justify-content:flex-end; gap:8px;">
                    <button type="button" data-close-ticket-cancel>Cancelar</button>
                    <button type="submit" data-close-ticket-submit>Finalizar</button>
                </div>
            </form>
        </div>
    </div>
{% endif %}

<script>
    (function () {
        const board = document.querySelector('[data-board]');
        if (!board) return;

        const refreshUniformColumns = () => {
            const totalColumns = board.querySelectorAll('.kanban-column').length || 1;
            board.style.setProperty('--regular-cols', String(totalColumns));
            const boardTop = board.getBoundingClientRect().top || 0;
            const available = Math.floor((window.innerHeight || 900) - boardTop - 12);
            const colHeight = Math.max(360, available);
            board.style.setProperty('--board-col-height', `${colHeight}px`);
        };

        refreshUniformColumns();
        window.addEventListener('resize', refreshUniformColumns);
        document.addEventListener('tickets-updated', refreshUniformColumns);
    })();
</script>

<script>
    (function () {
        const board = document.querySelector('[data-board]');
        if (!board) return;

        const getCookie = (name) => {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return '';
        };

        let draggingId = null;
        let draggingCard = null;
        let sourceColumn = null;
        let draggingMulti = false;
        let moveInFlight = false;
        const closeModal = document.querySelector('[data-close-ticket-modal]');
        const closeForm = document.querySelector('[data-close-ticket-form]');
        const closeTitle = document.querySelector('[data-close-ticket-title]');
        const closeTextLabel = document.querySelector('[data-close-ticket-text-label]');
        const closeSubmitBtn = document.querySelector('[data-close-ticket-submit]');
        const closeFailureInput = document.querySelector('#id_close_failure_type');
        const closeResolutionInput = document.querySelector('#id_close_resolution_text');
        const closeCancelEls = document.querySelectorAll('[data-close-ticket-cancel]');
        let closeResolver = null;

        const askClosePayload = (initialFailure, mode = 'close') => new Promise((resolve) => {
            if (!closeModal || !closeForm || !closeFailureInput || !closeResolutionInput) {
                resolve({ confirmed: false, failureType: '', text: '' });
                return;
            }
            const isCloseMode = mode === 'close';
            if (closeTitle) closeTitle.textContent = isCloseMode ? 'Finalizar chamado' : 'Registrar ação';
            if (closeTextLabel) closeTextLabel.textContent = isCloseMode ? 'Resolução' : 'Ação / Correção';
            if (closeSubmitBtn) closeSubmitBtn.textContent = isCloseMode ? 'Finalizar' : 'Salvar ação';
            closeResolutionInput.placeholder = isCloseMode
                ? 'Descreva a resolução...'
                : 'Descreva a ação/correção realizada...';
            closeResolver = resolve;
            closeFailureInput.value = initialFailure || '';
            closeResolutionInput.value = '';
            closeModal.hidden = false;
            closeResolutionInput.focus();
        });

        const closeCloseModal = (payload) => {
            if (closeModal) closeModal.hidden = true;
            if (closeForm) closeForm.reset();
            const resolver = closeResolver;
            closeResolver = null;
            if (resolver) resolver(payload);
        };

        if (closeForm) {
            closeForm.addEventListener('submit', (event) => {
                event.preventDefault();
                const failureType = (closeFailureInput?.value || '').trim();
                const text = (closeResolutionInput?.value || '').trim();
                if (!failureType || !text) return;
                closeCloseModal({ confirmed: true, failureType, text });
            });
        }
        closeCancelEls.forEach((el) => {
            el.addEventListener('click', () => closeCloseModal({ confirmed: false, failureType: '', text: '' }));
        });

        const ensureTimerControls = (card) => {
            if (!card) return;
            if (card.querySelector('[data-ticket-play]') || card.querySelector('[data-ticket-pause]')) return;
            const controls = document.createElement('div');
            controls.className = 'ticket-meta ticket-timer-controls';
            controls.style.marginTop = '6px';
            controls.innerHTML = `
                <button type="button" data-ticket-play data-ticket-id="${card.dataset.ticketId || ''}">Play</button>
                <button type="button" data-ticket-pause data-ticket-id="${card.dataset.ticketId || ''}" style="display:none;">Pause</button>
                <span class="ticket-last-action" title="${card.dataset.lastAction || ''}">${card.dataset.lastAction || ''}</span>
            `;
            const mainRow = card.querySelector('.ticket-main-row');
            if (mainRow) {
                mainRow.insertAdjacentElement('afterend', controls);
            } else {
                const left = card.querySelector('.ticket-main-left');
                const title = left ? left.querySelector('.ticket-title') : card.querySelector('.ticket-title');
                if (title) {
                    title.insertAdjacentElement('afterend', controls);
                    return;
                }
                const metaRich = left ? left.querySelector('.ticket-meta-rich') : card.querySelector('.ticket-meta-rich');
                if (metaRich) {
                    metaRich.insertAdjacentElement('beforebegin', controls);
                } else {
                    (left || card).appendChild(controls);
                }
            }
        };


        board.addEventListener('dragstart', (event) => {
            const card = event.target.closest('.ticket-card');
            if (!card) return;
            if (event.dataTransfer) {
                event.dataTransfer.effectAllowed = 'move';
                event.dataTransfer.setData('text/plain', card.dataset.ticketId || '');
            }
            window.__ticketDragInProgress = true;
            draggingId = card.dataset.ticketId;
            draggingCard = card;
            sourceColumn = card.closest('.kanban-column');
            draggingMulti = !!(event.ctrlKey || event.metaKey);
            card.classList.add('dragging');
        });

        board.addEventListener('dragend', (event) => {
            const card = event.target.closest('.ticket-card');
            if (card) card.classList.remove('dragging');
            window.__ticketDragInProgress = false;
            draggingId = null;
            draggingCard = null;
            sourceColumn = null;
            draggingMulti = false;
        });

        board.querySelectorAll('.kanban-column').forEach((column) => {
            column.addEventListener('dragover', (event) => {
                event.preventDefault();
                column.classList.add('drag-over');
            });

            column.addEventListener('dragleave', () => {
                column.classList.remove('drag-over');
            });

            column.addEventListener('drop', async (event) => {
                event.preventDefault();
                column.classList.remove('drag-over');
                if (!draggingId || !draggingCard) return;
                if (moveInFlight) return;
                const dragTicketId = draggingId;
                const dragCard = draggingCard;
                const dragSourceColumn = sourceColumn;
                const dragSourceTarget = dragSourceColumn ? (dragSourceColumn.dataset.target || '') : '';
                const target = column.dataset.target;
                const targetBody = column.querySelector('.kanban-body');
                if (!targetBody) return;

                if (dragSourceColumn && dragSourceColumn === column) {
                    draggingId = null;
                    return;
                }

                const isUserTarget = target.startsWith('user_');
                const isUserSource = dragSourceTarget.startsWith('user_');
                const isClosing = target === 'fechado';
                const isQueue = target === 'novo';
                const shouldClone = !isClosing && draggingMulti && isUserTarget && isUserSource;

                const duplicateInTarget = !!targetBody.querySelector(`.ticket-card[data-ticket-id="${dragTicketId}"]`);
                if (duplicateInTarget) {
                    if (!(isUserSource && isUserTarget && dragSourceTarget !== target)) {
                        draggingId = null;
                        return;
                    }
                }

                const previousParent = dragCard.parentElement;
                let movedCard = dragCard;
                let resolutionText = '';
                let progressNote = '';
                let failureType = '';
                let actionCapturedByModal = false;
                const normalizeFailureType = (rawValue) => {
                    const raw = (rawValue || '').trim().toLowerCase();
                    if (!raw) return '';
                    if (raw === 'n/s' || raw === 'ns' || raw === 'n-s' || raw === 'n/a' || raw === 'na' || raw === 'n-a') return 'na';
                    if (raw === 'equipamento' || raw === 'hardware') return 'equipamento';
                    if (raw === 'software') return 'software';
                    if (raw === 'humana' || raw === 'falha humana' || raw === 'falha_humana') return 'humana';
                    return '';
                };
                const currentSavedFailure = normalizeFailureType(draggingCard.dataset.failureType || '');

                const askFailureType = () => {
                    const raw = (prompt('Tipo de falha (N/A, Equipamento, Software ou Falha humana):') || '').trim().toLowerCase();
                    if (!raw) return '';
                    if (raw === 'n/s' || raw === 'ns' || raw === 'n-s' || raw === 'n/a' || raw === 'na' || raw === 'n-a') return 'na';
                    if (raw === 'equipamento' || raw === 'hardware') return 'equipamento';
                    if (raw === 'software') return 'software';
                    if (raw === 'humana' || raw === 'falha humana' || raw === 'falha_humana') return 'humana';
                    return '';
                };

                if (isClosing) {
                    if (!isUserSource) {
                        alert('Só é permitido finalizar chamado quando ele sai da coluna de um atendente.');
                        draggingId = null;
                        return;
                    }
                    const closePayload = await askClosePayload(currentSavedFailure, 'close');
                    if (!closePayload.confirmed) {
                        draggingId = null;
                        return;
                    }
                    resolutionText = (closePayload.text || '').trim();
                    failureType = normalizeFailureType(closePayload.failureType || currentSavedFailure);
                }
                if (!isClosing && isUserSource && isQueue) {
                    const actionPayload = await askClosePayload(currentSavedFailure, 'action');
                    if (!actionPayload.confirmed) {
                        draggingId = null;
                        return;
                    }
                    progressNote = (actionPayload.text || '').trim();
                    failureType = normalizeFailureType(actionPayload.failureType || currentSavedFailure);
                    actionCapturedByModal = true;
                }
                if (isUserSource && (isQueue || (isUserTarget && !shouldClone))) {
                    if (!actionCapturedByModal) {
                        const actionPayload = await askClosePayload(currentSavedFailure, 'action');
                        if (!actionPayload.confirmed) {
                            draggingId = null;
                            return;
                        }
                        progressNote = (actionPayload.text || '').trim();
                        failureType = normalizeFailureType(actionPayload.failureType || currentSavedFailure);
                        actionCapturedByModal = true;
                    }
                }
                if (!isClosing && isUserSource && (isQueue || (isUserTarget && !shouldClone))) {
                    if (!actionCapturedByModal) {
                        failureType = currentSavedFailure || askFailureType();
                    }
                    if (!failureType) {
                        alert('Informe um tipo de falha válido: N/A, Equipamento, Software ou Falha humana.');
                        draggingId = null;
                        return;
                    }
                }

                if (duplicateInTarget && isUserSource && isUserTarget && dragSourceTarget !== target) {
                    const actionPayload = await askClosePayload(currentSavedFailure, 'action');
                    if (!actionPayload.confirmed) {
                        draggingId = null;
                        return;
                    }
                    progressNote = (actionPayload.text || '').trim();
                    failureType = normalizeFailureType(actionPayload.failureType || currentSavedFailure);
                    if (!failureType) {
                        alert('Informe um tipo de falha válido: N/A, Equipamento, Software ou Falha humana.');
                        draggingId = null;
                        return;
                    }

                    moveInFlight = true;
                    window.__ticketDragInProgress = true;
                    try {
                        const response = await fetch('{% url "chamados_mover" %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'X-CSRFToken': getCookie('csrftoken'),
                            },
                            body: new URLSearchParams({
                                ticket_id: dragTicketId,
                                target: target,
                                source_target: dragSourceTarget,
                                unassign_only: '1',
                                progress_note: progressNote,
                                failure_type: failureType,
                            }),
                        });
                        const responseData = await response.json().catch(() => ({}));
                        if (!response.ok) {
                            if (responseData.error === 'failure_required') {
                                alert('Informe o tipo de falha: N/A, Equipamento, Software ou Falha humana.');
                            } else if (responseData.error === 'action_required') {
                                alert('Informe a ação/correção ao sair do atendimento.');
                            } else {
                                alert('Não foi possível atualizar o compartilhamento deste chamado.');
                            }
                            draggingId = null;
                            return;
                        }

                        dragCard.remove();
                        if (failureType) {
                            board.querySelectorAll(`.ticket-card[data-ticket-id="${dragTicketId}"]`).forEach((card) => {
                                card.dataset.failureType = failureType;
                            });
                        }
                        document.dispatchEvent(new Event('tickets-updated'));
                        draggingId = null;
                        return;
                    } finally {
                        moveInFlight = false;
                        window.__ticketDragInProgress = false;
                    }
                }

                if (shouldClone) {
                    movedCard = dragCard.cloneNode(true);
                }

                targetBody.appendChild(movedCard);

                moveInFlight = true;
                window.__ticketDragInProgress = true;
                try {
                    const response = await fetch('{% url "chamados_mover" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                        body: new URLSearchParams({
                            ticket_id: dragTicketId,
                            target: target,
                            source_target: dragSourceTarget,
                            multi: draggingMulti ? '1' : '0',
                            resolution: resolutionText,
                            progress_note: progressNote,
                            failure_type: failureType,
                        }),
                    });

                    let responseData = {};
                    try {
                        responseData = await response.json();
                    } catch (err) {
                        responseData = {};
                    }

                    if (!response.ok) {
                        if (responseData.error === 'progress_note_required') {
                            alert('Informe o que foi feito antes de mover para Pendente.');
                        } else if (responseData.error === 'resolution_required') {
                            alert('Informe a resolução para finalizar o chamado.');
                        } else if (responseData.error === 'close_only_from_attendant') {
                            alert('Só é permitido finalizar chamado quando ele sai da coluna de um atendente.');
                        } else if (responseData.error === 'play_required') {
                            alert('Para finalizar, inicie o atendimento com Play e depois finalize.');
                        } else if (responseData.error === 'failure_required') {
                            alert('Informe o tipo de falha: N/A, Equipamento, Software ou Falha humana.');
                        } else if (responseData.error === 'action_required') {
                            alert('Informe a ação/correção ao mover o chamado.');
                        }
                        if (shouldClone) {
                            movedCard.remove();
                        } else if (previousParent) {
                            previousParent.appendChild(draggingCard);
                        }
                        draggingId = null;
                        return;
                    }

                    if (responseData.partial_unassign) {
                        movedCard.remove();
                        draggingId = null;
                        return;
                    }

                    if (!shouldClone) {
                        board.querySelectorAll(`.ticket-card[data-ticket-id="${dragTicketId}"]`).forEach((card) => {
                            if (card !== movedCard) {
                                card.remove();
                            }
                        });
                    }
                    if (target.startsWith('user_')) {
                        ensureTimerControls(movedCard);
                        movedCard.dataset.cycleRunning = '0';
                        const playBtn = movedCard.querySelector('[data-ticket-play]');
                        const pauseBtn = movedCard.querySelector('[data-ticket-pause]');
                        if (playBtn) playBtn.style.display = '';
                        if (pauseBtn) pauseBtn.style.display = 'none';
                    }
                    if (failureType) {
                        board.querySelectorAll(`.ticket-card[data-ticket-id="${dragTicketId}"]`).forEach((card) => {
                            card.dataset.failureType = failureType;
                        });
                    }
                    if (target === 'novo') {
                        movedCard.dataset.cycleRunning = '0';
                        const playBtn = movedCard.querySelector('[data-ticket-play]');
                        const pauseBtn = movedCard.querySelector('[data-ticket-pause]');
                        if (playBtn) playBtn.style.display = 'none';
                        if (pauseBtn) pauseBtn.style.display = 'none';
                    }
                    document.dispatchEvent(new Event('tickets-updated'));
                    draggingId = null;
                } finally {
                    moveInFlight = false;
                    window.__ticketDragInProgress = false;
                }
            });
        });

        const syncPlayPauseButtons = (ticketId, running, sourceTarget = '') => {
            board.querySelectorAll(`.ticket-card[data-ticket-id="${ticketId}"]`).forEach((card) => {
                if (sourceTarget) {
                    const col = card.closest('.kanban-column');
                    const target = col ? (col.dataset.target || '') : '';
                    if (target !== sourceTarget) return;
                }
                card.dataset.cycleRunning = running ? '1' : '0';
                card.classList.toggle('playing', !!running);
                const playBtn = card.querySelector('[data-ticket-play]');
                const pauseBtn = card.querySelector('[data-ticket-pause]');
                if (playBtn) playBtn.style.display = running ? 'none' : '';
                if (pauseBtn) pauseBtn.style.display = running ? '' : 'none';
                if (running) {
                    const parent = card.parentElement;
                    if (parent) parent.prepend(card);
                }
            });
        };

        board.addEventListener('click', async (event) => {
            const playBtn = event.target.closest('[data-ticket-play]');
            const pauseBtn = event.target.closest('[data-ticket-pause]');
            if (!playBtn && !pauseBtn) return;

            const card = event.target.closest('.ticket-card');
            const column = event.target.closest('.kanban-column');
            if (!card || !column) return;
            const sourceTarget = column.dataset.target || '';
            if (!sourceTarget.startsWith('user_')) {
                alert('Play/Pause só pode ser usado em coluna de atendente.');
                return;
            }

            const ticketId = card.dataset.ticketId || '';
            if (!ticketId) return;

            const action = playBtn ? 'play' : 'pause';
            let actionNote = '';
            let failureType = '';

            if (action === 'pause') {
                const currentSavedFailure = (card.dataset.failureType || '').trim().toLowerCase();
                const payload = await askClosePayload(currentSavedFailure, 'action');
                if (!payload.confirmed) return;
                actionNote = (payload.text || '').trim();
                failureType = (payload.failureType || '').trim();
            }

            const response = await fetch('{% url "chamados_timer" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: new URLSearchParams({
                    ticket_id: ticketId,
                    action,
                    source_target: sourceTarget,
                    action_note: actionNote,
                    failure_type: failureType,
                }),
            });
            const data = await response.json().catch(() => ({}));
            if (!response.ok) {
                if (data.error === 'action_required') {
                    alert('Informe a ação/correção ao pausar.');
                } else if (data.error === 'failure_required') {
                    alert('Informe o tipo de falha ao pausar.');
                } else if (data.error === 'not_running') {
                    alert('Este chamado não está em execução.');
                } else {
                    alert('Não foi possível processar Play/Pause.');
                }
                return;
            }

            if (action === 'pause' && data.failure_type) {
                card.dataset.failureType = data.failure_type;
            }
            if (action === 'pause' && actionNote) {
                board.querySelectorAll(`.ticket-card[data-ticket-id="${ticketId}"]`).forEach((node) => {
                    node.dataset.lastAction = actionNote;
                    const actionEl = node.querySelector('.ticket-last-action');
                    if (actionEl) {
                        actionEl.textContent = actionNote;
                        actionEl.title = actionNote;
                    }
                });
            }
            syncPlayPauseButtons(ticketId, !!data.running, sourceTarget);
        });
    })();
</script>

<script>
    (function () {
        const modal = document.querySelector('[data-modal]');
        const openBtn = document.querySelector('[data-open-modal]');
        const closeEls = document.querySelectorAll('[data-close-modal]');
        if (!modal || !openBtn) return;

        const open = () => {
            modal.hidden = false;
        };
        const close = () => {
            modal.hidden = true;
        };

        openBtn.addEventListener('click', open);
        closeEls.forEach((el) => el.addEventListener('click', close));
    })();
</script>

<script>
    (function () {
        const modal = document.querySelector('[data-whatsapp-modal]');
        const openBtn = document.querySelector('[data-open-whatsapp]');
        const closeEls = document.querySelectorAll('[data-close-whatsapp]');
        if (!modal || !openBtn) return;

        const open = () => {
            modal.hidden = false;
        };
        const close = () => {
            modal.hidden = true;
        };

        openBtn.addEventListener('click', open);
        closeEls.forEach((el) => el.addEventListener('click', close));
    })();
</script>

<script>
    (function () {
        const detailsModal = document.querySelector('[data-details-modal]');
        const closeButtons = document.querySelectorAll('[data-close-details]');
        const board = document.querySelector('[data-board]');
        const list = document.querySelector('[data-ticket-list]');
        const clickRoot = board || list;
        if (!detailsModal || !clickRoot) return;

        const getCookie = (name) => {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return '';
        };

        let currentTicketId = null;
        let dragging = false;

        if (board) {
            board.addEventListener('dragstart', () => {
                dragging = true;
            });
            board.addEventListener('dragend', () => {
                setTimeout(() => {
                    dragging = false;
                }, 0);
            });
        }

        const setText = (selector, value) => {
            const el = detailsModal.querySelector(selector);
            if (el) el.textContent = value || '-';
        };

        const renderMessages = (container, messages) => {
            if (!container) return;
            container.innerHTML = '';
            if (!messages.length) {
                const empty = document.createElement('div');
                empty.className = 'ticket-empty';
                empty.textContent = 'Sem mensagens.';
                container.appendChild(empty);
                return;
            }
            messages.forEach((msg) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'chat-message';

                const author = document.createElement('div');
                author.className = 'chat-author';
                author.textContent = msg.author;

                const text = document.createElement('div');
                text.className = 'chat-text';
                text.textContent = msg.message || '';

                wrapper.appendChild(author);
                if (msg.message) wrapper.appendChild(text);

                if (msg.attachment_url) {
                    const attach = document.createElement('div');
                    const link = document.createElement('a');
                    link.href = msg.attachment_url;
                    link.target = '_blank';
                    link.rel = 'noreferrer';
                    link.textContent = 'Anexo';
                    attach.appendChild(link);
                    wrapper.appendChild(attach);
                }

                const time = document.createElement('div');
                time.className = 'chat-time';
                time.textContent = msg.created_at;
                wrapper.appendChild(time);

                container.appendChild(wrapper);
            });
        };

        const renderTimeline = (container, timeline) => {
            if (!container) return;
            container.innerHTML = '';
            if (!timeline.length) {
                const empty = document.createElement('div');
                empty.className = 'ticket-empty';
                empty.textContent = 'Sem histórico registrado.';
                container.appendChild(empty);
                return;
            }
            timeline.forEach((row) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'chat-message';

                const header = document.createElement('div');
                header.className = 'chat-author';
                header.textContent = `${row.event_type} • ${row.actor || '-'}`;
                wrapper.appendChild(header);

                const transition = document.createElement('div');
                transition.className = 'chat-text';
                transition.textContent = `${row.from_status || '-'} -> ${row.to_status || '-'}`;
                wrapper.appendChild(transition);

                if (row.note) {
                    const note = document.createElement('div');
                    note.className = 'chat-text';
                    note.textContent = row.note;
                    wrapper.appendChild(note);
                }

                const time = document.createElement('div');
                time.className = 'chat-time';
                time.textContent = row.created_at;
                wrapper.appendChild(time);

                container.appendChild(wrapper);
            });
        };

        const loadDetails = async (ticketId) => {
            const response = await fetch(`/chamados/detalhe/${ticketId}/`);
            if (!response.ok) return;
            const data = await response.json();
            if (!data.ok) return;

            setText('[data-detail-id]', data.ticket.id);
            setText('[data-detail-title]', data.ticket.title);
            setText('[data-detail-description]', data.ticket.description);
            setText('[data-detail-type]', data.ticket.ticket_type);
            setText('[data-detail-urgency]', data.ticket.urgency);
            setText('[data-detail-status]', data.ticket.status);
            setText('[data-detail-created-by]', data.ticket.created_by);
            setText('[data-detail-assignees]', data.ticket.assignees);
            setText('[data-detail-resolution]', data.ticket.resolution);

            const attachLink = detailsModal.querySelector('[data-detail-attachment]');
            const noAttach = detailsModal.querySelector('[data-detail-no-attachment]');
            if (data.ticket.attachment_url) {
                attachLink.href = data.ticket.attachment_url;
                attachLink.style.display = 'inline';
                noAttach.style.display = 'none';
            } else {
                attachLink.style.display = 'none';
                noAttach.style.display = 'inline';
            }

            renderMessages(detailsModal.querySelector('[data-chat-public]'), data.messages.public || []);
            renderMessages(detailsModal.querySelector('[data-chat-internal]'), data.messages.internal || []);
            renderTimeline(detailsModal.querySelector('[data-ticket-timeline]'), data.timeline || []);

            const internalSection = detailsModal.querySelector('[data-chat-internal-section]');
            if (internalSection) {
                internalSection.style.display = data.internal_allowed ? 'block' : 'none';
            }

            const reclassForm = detailsModal.querySelector('[data-reclassify-form]');
            if (reclassForm) {
                const typeSelect = reclassForm.querySelector('select[name="ticket_type"]');
                const urgencySelect = reclassForm.querySelector('select[name="urgency"]');
                if (typeSelect) typeSelect.value = data.ticket.ticket_type_value || 'nao_classificado';
                if (urgencySelect) urgencySelect.value = data.ticket.urgency_value || 'nao_classificado';
            }

            const editForm = detailsModal.querySelector('[data-edit-form]');
            const editToggle = detailsModal.querySelector('[data-edit-toggle]');
            if (editForm && editToggle) {
                const canEdit = !!data.ticket.can_edit;
                editForm.hidden = true;
                editToggle.hidden = !canEdit;
                const titleInput = editForm.querySelector('input[name="title"]');
                const descInput = editForm.querySelector('textarea[name="description"]');
                if (titleInput) titleInput.value = data.ticket.title || '';
                if (descInput) descInput.value = data.ticket.description || '';
                editToggle.onclick = () => {
                    if (!canEdit) return;
                    editForm.hidden = !editForm.hidden;
                };
            }

            const detailReopen = detailsModal.querySelector('[data-detail-reopen]');
            if (detailReopen) {
                const canReopen = data.ticket.status_code === 'fechado';
                detailReopen.hidden = !canReopen;
                detailReopen.onclick = async () => {
                    if (!currentTicketId) return;
                    const response = await fetch('{% url "chamados_reabrir" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                        body: new URLSearchParams({ ticket_id: currentTicketId }),
                    });
                    if (response.ok) {
                        await loadDetails(currentTicketId);
                        window.location.reload();
                    }
                };
            }
        };

        const openDetails = async (ticketId) => {
            currentTicketId = ticketId;
            detailsModal.hidden = false;
            await loadDetails(ticketId);
        };

        const closeDetails = () => {
            detailsModal.hidden = true;
            currentTicketId = null;
        };

        clickRoot.addEventListener('click', (event) => {
            if (dragging) return;
            if (event.target.closest('[data-ticket-play]') || event.target.closest('[data-ticket-pause]')) return;
            const card = event.target.closest('.ticket-card');
            if (!card) return;
            openDetails(card.dataset.ticketId);
        });

        closeButtons.forEach((btn) => btn.addEventListener('click', closeDetails));


        const reopenButtons = document.querySelectorAll('[data-reopen-ticket]');
        reopenButtons.forEach((btn) => {
            btn.addEventListener('click', async (event) => {
                event.preventDefault();
                const ticketId = btn.dataset.ticketId;
                if (!ticketId) return;
                const response = await fetch('{% url "chamados_reabrir" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: new URLSearchParams({ ticket_id: ticketId }),
                });
                if (response.ok) {
                    window.location.reload();
                }
            });
        });

        detailsModal.querySelectorAll('[data-chat-form]').forEach((form) => {
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!currentTicketId) return;
                if (form.dataset.sending === '1') return;
                form.dataset.sending = '1';
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.disabled = true;
                const formData = new FormData(form);
                formData.append('ticket_id', currentTicketId);
                formData.append('internal', form.dataset.internal || '0');

                try {
                    const response = await fetch('{% url "chamados_mensagem" %}', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                        body: formData,
                    });

                    if (response.ok) {
                        form.reset();
                        await loadDetails(currentTicketId);
                    }
                } finally {
                    form.dataset.sending = '0';
                    if (submitBtn) submitBtn.disabled = false;
                }
            });
        });

        const reclassForm = detailsModal.querySelector('[data-reclassify-form]');
        if (reclassForm) {
            reclassForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!currentTicketId) return;
                const formData = new FormData(reclassForm);
                formData.append('ticket_id', currentTicketId);

                const response = await fetch('{% url "chamados_reclassificar" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: formData,
                });

                if (response.ok) {
                    await loadDetails(currentTicketId);
                    return;
                }
                let errorMsg = 'Não foi possível reclassificar.';
                try {
                    const data = await response.json();
                    if (data && data.error) {
                        errorMsg += ` (${data.error})`;
                    }
                } catch (err) {
                    // ignore parse errors
                }
                alert(errorMsg);
            });
        }

        const editForm = detailsModal.querySelector('[data-edit-form]');
        if (editForm) {
            editForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!currentTicketId) return;
                const formData = new FormData(editForm);
                formData.append('ticket_id', currentTicketId);
                const response = await fetch('{% url "chamados_atualizar" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: formData,
                });
                if (response.ok) {
                    const newTitle = (formData.get('title') || '').toString();
                    const newDesc = (formData.get('description') || '').toString();
                    setText('[data-detail-title]', newTitle);
                    setText('[data-detail-description]', newDesc);
                    document.querySelectorAll(`.ticket-card[data-ticket-id="${currentTicketId}"] .ticket-title`).forEach((el) => {
                        const prefix = `#${currentTicketId} - ${newTitle}`;
                        const textNodes = Array.from(el.childNodes).filter((node) => node.nodeType === Node.TEXT_NODE);
                        if (textNodes.length) {
                            textNodes[textNodes.length - 1].textContent = ` ${prefix}`;
                        } else {
                            el.appendChild(document.createTextNode(` ${prefix}`));
                        }
                    });
                    await loadDetails(currentTicketId);
                }
            });
        }
    })();
</script>
<script>
    (function () {
        const modal = document.querySelector('[data-email-modal]');
        const openBtn = document.querySelector('[data-open-email]');
        const closeEls = document.querySelectorAll('[data-close-email]');
        if (!modal || !openBtn) return;

        const open = () => {
            modal.hidden = false;
        };
        const close = () => {
            modal.hidden = true;
        };

        openBtn.addEventListener('click', open);
        closeEls.forEach((el) => el.addEventListener('click', close));
    })();
</script>
<script>
    (function () {
        const modal = document.querySelector('[data-planilha-modal]');
        const openBtn = document.querySelector('[data-open-planilha]');
        const closeEls = document.querySelectorAll('[data-close-planilha]');
        const attendantInput = document.querySelector('#id_planilha_atendente');
        const pathInput = document.querySelector('#id_planilha_caminho');
        const defaultPath = "{{ chamados_xlsx_default_path|default:''|escapejs }}";
        if (!modal || !openBtn) return;

        const syncPathByAttendant = () => {
            if (!pathInput || !attendantInput) return;
            const opt = attendantInput.options[attendantInput.selectedIndex];
            const attendantPath = (opt?.dataset?.lastPath || '').trim();
            pathInput.value = attendantPath || defaultPath;
        };

        const open = () => {
            modal.hidden = false;
            syncPathByAttendant();
        };
        const close = () => {
            modal.hidden = true;
        };

        openBtn.addEventListener('click', open);
        closeEls.forEach((el) => el.addEventListener('click', close));
        if (attendantInput) {
            attendantInput.addEventListener('change', syncPathByAttendant);
        }
    })();
</script>
<script>
    (function () {
        const lookupBtn = document.querySelector('[data-wa-group-lookup]');
        const nameInput = document.querySelector('#id_wa_group_name');
        const jidInput = document.querySelector('#id_wa_group_jid');
        const resultEl = document.querySelector('[data-wa-group-result]');
        if (!lookupBtn || !nameInput || !jidInput || !resultEl) return;

        const getCookie = (name) => {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return '';
        };

        lookupBtn.addEventListener('click', async () => {
            const groupName = (nameInput.value || '').trim();
            if (!groupName) {
                resultEl.textContent = 'Informe o nome do grupo para buscar.';
                return;
            }

            resultEl.textContent = 'Buscando grupo...';
            try {
                const response = await fetch('{% url "chamados_whatsapp_group_lookup" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: new URLSearchParams({ group_name: groupName }),
                });
                const data = await response.json();
                if (!response.ok || !data.ok) {
                    resultEl.textContent = `Falha ao buscar grupo: ${data.detail || data.error || 'erro desconhecido'}`;
                    return;
                }
                if (!data.found) {
                    resultEl.textContent = 'Nenhum grupo encontrado com esse nome.';
                    return;
                }
                jidInput.value = data.jid || '';
                const total = Array.isArray(data.matches) ? data.matches.length : 0;
                resultEl.textContent = `Grupo selecionado: ${data.name} (${data.jid})` + (total > 1 ? ` | ${total} correspondencias` : '');
            } catch (error) {
                resultEl.textContent = `Erro de rede ao buscar grupo: ${error}`;
            }
        });
    })();
</script>
<script>
    (function () {
        const board = document.querySelector('[data-board]');
        const list = document.querySelector('[data-ticket-list]');
        const root = board || list;
        if (!root) return;

        const parseOpenedAt = (card) => {
            const raw = (card.dataset.openedAt || '').trim();
            if (!raw) return null;
            const value = new Date(raw);
            return Number.isNaN(value.getTime()) ? null : value;
        };

        const formatElapsed = (openedAt) => {
            const now = new Date();
            const ms = Math.max(now.getTime() - openedAt.getTime(), 0);
            const totalMinutes = Math.floor(ms / 60000);
            const days = Math.floor(totalMinutes / 1440);
            const hours = Math.floor((totalMinutes % 1440) / 60);
            const minutes = totalMinutes % 60;
            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m`;
        };

        const ensureCounter = (card) => {
            const right = card.querySelector('.ticket-main-right');
            const left = card.querySelector('.ticket-main-left');
            let row = (right || left || card).querySelector('.ticket-timing-row');
            if (!row) {
                row = document.createElement('div');
                row.className = 'ticket-timing-row';
                if (right) {
                    right.appendChild(row);
                } else {
                    const controls = (left || card).querySelector('.ticket-timer-controls');
                    const title = (left || card).querySelector('.ticket-title');
                    if (!title) return null;
                    if (controls) {
                        controls.insertAdjacentElement('afterend', row);
                    } else {
                        title.insertAdjacentElement('afterend', row);
                    }
                }
            }
            let badge = row.querySelector('.ticket-open-counter');
            if (!badge) {
                badge = document.createElement('span');
                badge.className = 'ticket-open-counter';
                row.appendChild(badge);
            }
            return badge;
        };

        const isClosedCard = (card) => {
            const column = card.closest('.kanban-column');
            const target = column ? (column.dataset.target || '') : '';
            if (target === 'fechado') return true;
            return (card.dataset.ticketStatus || '') === 'fechado';
        };

        const sortOpenCardsInColumn = (column) => {
            if (!column) return;
            if ((column.dataset.target || '') === 'fechado') return;
            const body = column.querySelector('.kanban-body');
            if (!body) return;
            const cards = Array.from(body.querySelectorAll('.ticket-card'));
            cards.sort((a, b) => {
                const aRunning = (a.dataset.cycleRunning || '') === '1' || a.classList.contains('playing');
                const bRunning = (b.dataset.cycleRunning || '') === '1' || b.classList.contains('playing');
                if (aRunning !== bRunning) return aRunning ? -1 : 1;
                const ad = parseOpenedAt(a);
                const bd = parseOpenedAt(b);
                if (!ad && !bd) return 0;
                if (!ad) return 1;
                if (!bd) return -1;
                return ad.getTime() - bd.getTime();
            });
            cards.forEach((card) => body.appendChild(card));
        };

        const refreshCards = () => {
            root.querySelectorAll('.ticket-card').forEach((card) => {
                if (isClosedCard(card)) {
                    const existing = card.querySelector('.ticket-open-counter');
                    if (existing) existing.remove();
                    return;
                }
                const openedAt = parseOpenedAt(card);
                if (!openedAt) return;
                const badge = ensureCounter(card);
                if (!badge) return;
                badge.textContent = `aberto ${formatElapsed(openedAt)}`;
            });

            if (board) {
                board.querySelectorAll('.kanban-column').forEach((column) => {
                    sortOpenCardsInColumn(column);
                });
            }
        };

        refreshCards();
        setInterval(refreshCards, 30000);
        document.addEventListener('tickets-updated', refreshCards);
    })();
</script>
{% if is_ti_group %}
<script>
    (function () {
        const input = document.querySelector('[data-closed-search]');
        const column = document.querySelector('.kanban-column[data-target="fechado"]');
        if (!input || !column) return;

        const cards = () => Array.from(column.querySelectorAll('.kanban-body .ticket-card'));

        const normalized = (value) => (value || '').toString().trim().toLowerCase();
        const textForCard = (card) => {
            const title = card.querySelector('.ticket-title')?.textContent || '';
            const requester = card.querySelector('.ticket-requester')?.textContent || '';
            const extra = card.querySelector('.ticket-extra')?.textContent || '';
            const description = card.dataset.ticketDescription || '';
            return normalized(`${title} ${requester} ${extra} ${description}`);
        };

        const applyFilter = () => {
            const query = normalized(input.value);
            cards().forEach((card) => {
                const show = !query || textForCard(card).includes(query);
                card.style.display = show ? '' : 'none';
            });
        };

        input.addEventListener('input', applyFilter);
        document.addEventListener('tickets-updated', applyFilter);
    })();
</script>
{% endif %}
<script>
    (function () {
        const board = document.querySelector('[data-board]');
        const STORAGE_KEY = 'chamados_scroll_state_v1';

        const captureState = () => {
            const state = {
                pageX: window.scrollX || 0,
                pageY: window.scrollY || 0,
                columns: {},
            };
            if (board) {
                board.querySelectorAll('.kanban-column').forEach((column) => {
                    const target = (column.dataset.target || '').trim();
                    if (!target) return;
                    const body = column.querySelector('.kanban-body');
                    if (!body) return;
                    state.columns[target] = {
                        top: body.scrollTop || 0,
                        left: body.scrollLeft || 0,
                    };
                });
            }
            return state;
        };

        const saveState = () => {
            try {
                sessionStorage.setItem(STORAGE_KEY, JSON.stringify(captureState()));
            } catch (_) {
                // ignore storage failures
            }
        };

        const restoreState = () => {
            let raw = '';
            try {
                raw = sessionStorage.getItem(STORAGE_KEY) || '';
            } catch (_) {
                raw = '';
            }
            if (!raw) return;

            let state = null;
            try {
                state = JSON.parse(raw);
            } catch (_) {
                state = null;
            }
            if (!state) return;

            requestAnimationFrame(() => {
                if (board && state.columns) {
                    board.querySelectorAll('.kanban-column').forEach((column) => {
                        const target = (column.dataset.target || '').trim();
                        if (!target || !state.columns[target]) return;
                        const body = column.querySelector('.kanban-body');
                        if (!body) return;
                        body.scrollTop = Number(state.columns[target].top || 0);
                        body.scrollLeft = Number(state.columns[target].left || 0);
                    });
                }
                window.scrollTo(Number(state.pageX || 0), Number(state.pageY || 0));
            });
        };

        window.__saveChamadosScrollState = saveState;
        window.addEventListener('beforeunload', saveState);
        restoreState();
    })();
</script>
{% if is_ti_group %}
    <script>
        (function () {
            const DEFAULT_SECONDS = 10;
            const STORAGE_KEY = 'chamados_refresh_seconds';
            const refreshInput = document.querySelector('#id_refresh_seconds');

            const loadSeconds = () => {
                const raw = (localStorage.getItem(STORAGE_KEY) || '').trim();
                const parsed = parseInt(raw, 10);
                if (Number.isNaN(parsed)) return DEFAULT_SECONDS;
                return Math.min(300, Math.max(3, parsed));
            };

            const saveSeconds = (value) => {
                localStorage.setItem(STORAGE_KEY, String(value));
            };

            let refreshSeconds = loadSeconds();
            if (refreshInput) {
                refreshInput.value = String(refreshSeconds);
                refreshInput.addEventListener('change', () => {
                    const parsed = parseInt(refreshInput.value || '', 10);
                    refreshSeconds = Number.isNaN(parsed) ? DEFAULT_SECONDS : Math.min(300, Math.max(3, parsed));
                    refreshInput.value = String(refreshSeconds);
                    saveSeconds(refreshSeconds);
                    restartTimer();
                });
            }

            const isTyping = () => {
                const active = document.activeElement;
                if (!active) return false;
                const tag = (active.tagName || '').toLowerCase();
                return tag === 'input' || tag === 'textarea' || active.isContentEditable;
            };
            const hasOpenModal = () =>
                Array.from(document.querySelectorAll('.modal')).some((modal) => !modal.hidden);
            const isDraggingTicket = () =>
                !!window.__ticketDragInProgress || document.querySelector('.ticket-card.dragging');

            let timerId = null;
            const restartTimer = () => {
                if (timerId) {
                    clearInterval(timerId);
                }
                timerId = setInterval(() => {
                    if (document.hidden) return;
                    if (isTyping()) return;
                    if (hasOpenModal()) return;
                    if (isDraggingTicket()) return;
                    if (typeof window.__saveChamadosScrollState === 'function') {
                        window.__saveChamadosScrollState();
                    }
                    window.location.reload();
                }, refreshSeconds * 1000);
            };
            restartTimer();
        })();
    </script>
{% endif %}
{% endblock %}


