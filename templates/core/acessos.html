{% extends "base.html" %}

{% block title %}Acessos | ERP TI{% endblock %}

{% block content %}
<div class="card">
    <div class="topbar">
        <div>
            <h2>Acessos</h2>
            {% if is_ti_group %}
            <p class="muted">Pastas e grupos com acesso.</p>
            {% else %}
            <p class="muted">Seu usuário não está no departamento TI.</p>
            {% endif %}
        </div>
        <form method="post" action="{% url 'logout' %}" class="inline-form">
            {% csrf_token %}
            <button type="submit">Sair</button>
        </form>
    </div>

    {% if is_ti_group %}
        {% include "core/_tabs.html" %}

        <div class="topbar" style="margin-top: 16px;">
            <h3>Pastas</h3>
            <form method="post" class="inline-form">
                {% csrf_token %}
                <button type="submit">Atualizar</button>
            </form>
        </div>
        <div class="topbar" style="margin-bottom: 10px;">
            <form method="get" class="inline-form">
                <label class="muted" style="margin-right: 8px;">Usuário</label>
                <select name="user" style="min-width: 240px;">
                    <option value="">Selecione um usuário</option>
                    {% for user in access_users %}
                        <option value="{{ user.id }}" {% if selected_user_id|default:'' == user.id|stringformat:"s" %}selected{% endif %}>
                            {{ user.full_name }}{% if user.username %} ({{ user.username }}){% endif %}
                        </option>
                    {% endfor %}
                </select>
                <button type="submit">Ver acessos</button>
            </form>
        </div>
        <div class="topbar" style="margin-bottom: 10px;">
            <input
                type="text"
                class="table-search"
                placeholder="Pesquisar por pasta..."
                data-access-search
            />
        </div>

        <div class="form-row">
            <div style="flex: 1; min-width: 260px;">
                <div class="ticket-legend" style="max-height: 60vh; overflow: auto;">
                    <div class="muted" style="margin-bottom: 8px;">Pastas</div>
                    <ul style="list-style: none; padding-left: 0; margin: 0;" data-folder-list>
                        {% for folder in folders %}
                            <li style="margin-bottom: 6px;">
                                <button type="button" class="tab-button" data-folder-id="{{ folder.id }}">
                                    {{ folder.name }}
                                </button>
                            </li>
                        {% empty %}
                            <li class="muted">Nenhuma pasta encontrada.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div style="flex: 3; min-width: 320px;">
                <div class="ticket-legend" data-folder-details>
                    <div class="muted">Selecione uma pasta para ver os acessos.</div>
                </div>
            </div>
        </div>

        <div class="ticket-legend" style="margin-top: 16px;">
            <strong>Acessos do usuário selecionado</strong>
            <div style="margin-top: 8px;">
                <strong>Grupos no AD:</strong>
                {% if user_ad_groups %}
                    {{ user_ad_groups|join:", " }}
                {% else %}
                    <span class="muted">Nenhum grupo AD encontrado.</span>
                {% endif %}
            </div>
            <div style="margin-top: 8px;">
                <strong>Grupos do usuário:</strong>
                {% if user_groups %}
                    {{ user_groups|join:", " }}
                {% else %}
                    <span class="muted">Nenhum grupo encontrado no snapshot atual.</span>
                {% endif %}
            </div>
            <div style="margin-top: 8px; overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Pasta</th>
                            <th>Acesso</th>
                            <th>Grupos</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in user_access %}
                            <tr>
                                <td>{{ item.folder }}</td>
                                <td>{% if item.level == 'leitura_escrita' %}Leitura e escrita{% else %}Somente leitura{% endif %}</td>
                                <td>{{ item.groups }}</td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="3" class="muted">Selecione um usuário para listar os acessos.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% else %}
        <p>Solicite ao administrador a inclusão no departamento <strong>TI</strong>.</p>
    {% endif %}
</div>

{% if is_ti_group %}
<script>
    (function () {
        const data = {
            {% for folder in folders %}
            "{{ folder.id }}": {
                "name": "{{ folder.name|escapejs }}",
                "groups": [
                    {% for group in folder.groups.all %}
                    {
                        "name": "{{ group.name|escapejs }}",
                        "level": "{{ group.access_level|escapejs }}",
                        "members": [
                            {% for member in group.members.all %}
                            {
                                "name": "{{ member.name|escapejs }}",
                                "username": "{{ member.username|escapejs }}"
                            }{% if not forloop.last %},{% endif %}
                            {% endfor %}
                        ]
                    }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ]
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        };

        const list = document.querySelector('[data-folder-list]');
        const details = document.querySelector('[data-folder-details]');
        const search = document.querySelector('[data-access-search]');
        if (!list || !details) return;

        const render = (folder) => {
            if (!folder) {
                details.innerHTML = '<div class="muted">Selecione uma pasta para ver os acessos.</div>';
                return;
            }
            let html = `<strong>${folder.name}</strong>`;
            if (!folder.groups.length) {
                html += '<div class="muted" style="margin-top:6px;">Nenhum grupo encontrado.</div>';
                details.innerHTML = html;
                return;
            }
            folder.groups.forEach((group) => {
                const levelLabel = group.level === 'leitura_escrita' ? 'Leitura e escrita' : 'Somente leitura';
                html += `<div style="margin-top:12px;"><strong>${group.name}</strong> <span class="muted">(${levelLabel})</span></div>`;
                if (!group.members.length) {
                    html += '<div class="muted">Sem membros no grupo.</div>';
                    return;
                }
                html += '<ul style="margin:6px 0 0 16px;">';
                group.members.forEach((member) => {
                    const label = member.username ? `${member.name} (${member.username})` : member.name;
                    html += `<li>${label}</li>`;
                });
                html += '</ul>';
            });
            details.innerHTML = html;
        };

        list.addEventListener('click', (event) => {
            const btn = event.target.closest('[data-folder-id]');
            if (!btn) return;
            const id = btn.getAttribute('data-folder-id');
            render(data[id]);
        });

        if (search) {
            search.addEventListener('input', () => {
                const query = search.value.trim().toLowerCase();
                list.querySelectorAll('[data-folder-id]').forEach((btn) => {
                    const label = btn.textContent.toLowerCase();
                    btn.closest('li').style.display = label.includes(query) ? '' : 'none';
                });
            });
        }
    })();
</script>
{% endif %}
{% endblock %}
