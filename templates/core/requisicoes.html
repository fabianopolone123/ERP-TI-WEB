{% extends "base.html" %}
{% load core_extras %}

{% block title %}Requisições | ERP TI{% endblock %}

{% block content %}
<style>
    .budget-item {
        position: relative;
        border-radius: 12px;
        border: 1px solid #2a3b57;
        background: linear-gradient(180deg, rgba(13, 23, 42, 0.98) 0%, rgba(10, 18, 34, 0.98) 100%);
        box-shadow: 0 8px 20px rgba(2, 8, 23, 0.32);
        padding: 14px;
        overflow: hidden;
    }

    .budget-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: var(--budget-accent, #38bdf8);
    }

    .budget-item[data-budget-role="main"] {
        border-color: color-mix(in srgb, var(--budget-accent, #38bdf8) 38%, #2a3b57);
    }

    .budget-item[data-budget-role="sub"] {
        background: linear-gradient(180deg, rgba(10, 17, 31, 0.98) 0%, rgba(7, 12, 24, 0.98) 100%);
        border-style: dashed;
        border-color: #344765;
    }

    .budget-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(71, 85, 105, 0.45);
    }

    .budget-head-meta {
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 0;
    }

    .budget-kind {
        display: inline-flex;
        align-items: center;
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--budget-accent, #38bdf8) 60%, #1e293b);
        background: color-mix(in srgb, var(--budget-accent, #38bdf8) 20%, transparent);
        color: #e2e8f0;
        font-size: 0.72rem;
        letter-spacing: 0.02em;
        font-weight: 700;
        padding: 3px 8px;
        white-space: nowrap;
    }

    .budget-title {
        font-size: 0.93rem;
        font-weight: 700;
        color: #e5eefb;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 360px;
    }

    .budget-seq {
        color: #93c5fd;
        font-size: 0.8rem;
        font-weight: 700;
    }

    .budget-actions-row {
        align-self: flex-end;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .approve-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border: 1px solid #166534;
        border-radius: 999px;
        background: rgba(34, 197, 94, 0.18);
        font-weight: 700;
        min-height: 40px;
    }

    .req-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: stretch;
        min-width: 150px;
    }

    .req-actions .inline-form {
        margin: 0;
    }

    .req-actions button {
        width: 100%;
        min-height: 38px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
    }
</style>
<div class="card">
    <div class="topbar">
        <div>
            <h2>Requisições</h2>
            {% if is_ti_group %}
            <p class="muted">Cadastro de requisição com múltiplos orçamentos.</p>
            {% else %}
            <p class="muted">Seu usuário não está no departamento TI.</p>
            {% endif %}
        </div>
        <form method="post" action="{% url 'logout' %}" class="inline-form">
            {% csrf_token %}
            <button type="submit">Sair</button>
        </form>
    </div>

    {% if is_ti_group %}
        {% include "core/_tabs.html" %}

        <div class="topbar" style="margin-top: 16px;">
            <h3>Requisições</h3>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">

                <button type="button" data-open-requisition data-requisition-kind="physical">Requisição física</button>

                <button type="button" data-open-requisition data-requisition-kind="digital">Requisição de produtos digitais</button>

            </div>
        </div>

        <div class="form-row" style="margin-bottom: 10px;">
            <div>
                <label for="id_req_search">Busca</label>
                <input id="id_req_search" type="text" placeholder="Pesquisar por requisição, orçamento ou status..." data-req-search />
            </div>
            <div>
                <label for="id_req_status_filter">Status</label>
                <select id="id_req_status_filter" data-req-status-filter>
                    <option value="">Todos</option>
                    <option value="pending_approval">Pendente de aprovação</option>
                    <option value="approved">Aprovado</option>
                    <option value="rejected">Reprovado</option>
                    <option value="received">Recebido</option>
                </select>
            </div>
        </div>

        <div style="overflow-x: auto;">
            <table class="data-table" data-table-name="requisicoes">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Título</th>
                        <th>Requisição</th>
                        <th>Status</th>
                        <th>Orçamentos</th>
                        <th>Total</th>
                        <th>Timeline</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in requisitions %}
                        <tr data-req-row data-status="{{ item.status }}" data-requisition-id="{{ item.id }}" style="cursor: pointer;">
                            <td data-sort-value="{{ item.id }}">{{ item.code }}</td>
                            <td>{{ item.title }}</td>
                            <td>
                                <div>{{ item.request }}</div>
                                {% if item.main_quotes %}
                                    <div class="muted" style="margin-top: 4px;">
                                        {% for quote in item.main_quotes %}
                                            <div style="margin-bottom: 6px;">
                                                {{ quote.name }} (Qtd: {{ quote.quantity|default:1 }} | Unitário: R$ {{ quote.value|br_money }} | Total: R$ {{ quote.package_total|br_money }})
                                                {% if quote.is_display_selected %}
                                                    <span class="status-pill status-approved" style="margin-left: 6px;">Aprovado</span>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </td>
                            <td>
                                <span class="status-pill status-{{ item.status }}">{{ item.get_status_display }}</span>
                            </td>
                            <td data-sort-value="{{ item.main_quotes_count|default:0 }}">
                                {{ item.main_quotes_count|default:0 }}
                            </td>
                            <td data-sort-value="{% if item.quotes_total is not None %}{{ item.quotes_total|floatformat:2 }}{% else %}-1{% endif %}">
                                {% if item.quotes_total is not None %}
                                    R$ {{ item.quotes_total|br_money }}
                                {% else %}
                                    <span class="muted">Aguardando aprovação</span>
                                {% endif %}
                            </td>
                            <td data-sort-value="{% if item.requested_at %}{{ item.requested_at|date:'Ymd' }}{% else %}{{ item.created_at|date:'YmdHis' }}{% endif %}">
                                <div class="muted">Pedido: {% if item.requested_at %}{{ item.requested_at|date:'d/m/Y' }}{% else %}{{ item.created_at|date:'d/m/Y' }}{% endif %}</div>
                                <div class="muted">Aprovação: {% if item.approved_at %}{{ item.approved_at|date:'d/m/Y' }}{% else %}-{% endif %}</div>
                                <div class="muted">Entrega: {% if item.received_at %}{{ item.received_at|date:'d/m/Y' }}{% else %}-{% endif %}</div>
                            </td>
                            <td>
                                <div class="req-actions">
                                    {% if item.status != 'rejected' and item.status != 'received' %}
                                        <form method="post" class="inline-form" data-mark-rejected-form>
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="mark_rejected" />
                                            <input type="hidden" name="requisition_id" value="{{ item.id }}" />
                                            <button type="submit" data-mark-rejected-button>Marcar não aprovado</button>
                                        </form>
                                    {% endif %}
                                    {% if item.status == 'approved' %}
                                        <form method="post" class="inline-form" data-mark-received-form>
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="mark_received" />
                                            <input type="hidden" name="requisition_id" value="{{ item.id }}" />
                                            <button type="submit" data-mark-received-button>Marcar entrega</button>
                                        </form>
                                    {% endif %}
                                    <button type="button" data-duplicate-requisition data-requisition-id="{{ item.id }}">Duplicar</button>
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="8" class="muted">Nenhuma requisição cadastrada.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>Solicite ao administrador a inclusão no departamento <strong>TI</strong>.</p>
    {% endif %}
</div>

{% if is_ti_group %}
<div class="modal" data-requisition-modal hidden>
    <div class="modal-backdrop" data-close-requisition></div>
    <div class="modal-content">
        <div class="topbar" style="margin-bottom: 8px;">
            <div style="display:flex; align-items:center; gap:8px;"><h3 data-requisition-modal-title style="margin:0;">Nova requisição</h3><span class="status-pill" data-requisition-kind-badge>Física</span></div>
            <button type="button" data-close-requisition>Fechar</button>
        </div>
        <form method="post" enctype="multipart/form-data" data-requisition-form>
            {% csrf_token %}
            <input type="hidden" name="mode" value="create" data-requisition-mode />
            <input type="hidden" name="requisition_id" value="" data-requisition-id-input />
            <input type="hidden" name="requisition_kind" value="physical" data-requisition-kind-input />
            <div class="form-row">
                <div style="max-width: 520px;">
                    <label for="id_requisition_title">Título</label>
                    <input id="id_requisition_title" name="title" type="text" required placeholder="Ex.: Compra de monitores para TI" />
                </div>
            </div>
            <div class="form-row">
                <div style="flex: 1;">
                    <label for="id_request_text">Requisição</label>
                    <textarea id="id_request_text" name="request_text" rows="3" required placeholder="Descreva a necessidade da requisição..."></textarea>
                </div>
            </div>
            <div class="form-row">
                <div style="max-width: 320px;">
                    <label for="id_requisition_status">Status</label>
                    <select id="id_requisition_status" name="status">
                        <option value="pending_approval">Pendente de aprovação</option>
                        <option value="approved">Aprovado</option>
                        <option value="rejected">Reprovado</option>
                        <option value="received">Recebido</option>
                    </select>
                </div>
            </div>

            <div class="topbar" style="margin-top: 8px; margin-bottom: 8px;">
                <h4 style="margin: 0;">Orçamentos</h4>
                <div style="display: flex; gap: 8px;">
                    <button type="button" data-copy-budgets>Copiar E-mail</button>
                    <button type="button" data-copy-whatsapp>Copiar WhatsApp</button>
                    <button type="button" data-add-budget>Adicionar orçamento</button>
                </div>
            </div>

            <div data-budget-list style="display: grid; gap: 10px;"></div>

            <div class="modal" data-sub-budget-modal hidden>
                <div class="modal-backdrop" data-close-sub-budget></div>
                <div class="modal-content" style="width: min(980px, 96vw);">
                    <div class="topbar" style="margin-bottom: 8px;">
                        <h3 data-sub-budget-title>Suborçamentos</h3>
                        <div style="display: flex; gap: 8px;">
                            <button type="button" data-sub-budget-add>Adicionar sub orçamento</button>
                            <button type="button" data-close-sub-budget>Fechar</button>
                        </div>
                    </div>
                    <div class="muted" style="margin-bottom: 8px;">Edite os suborçamentos deste orçamento-mãe.</div>
                    <div data-sub-budget-empty class="muted">Nenhum suborçamento cadastrado.</div>
                    <div data-sub-budget-list style="display: grid; gap: 10px;"></div>
                </div>
            </div>

            <div style="margin-top: 14px;">
                <button type="submit">Salvar requisição</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" data-capture-modal hidden>
    <div class="modal-backdrop" data-capture-cancel></div>
    <div class="modal-content" style="width: min(1100px, 96vw);">
        <div class="topbar" style="margin-bottom: 8px;">
            <h3>Capturar orçamento (selecione uma área)</h3>
            <div style="display: flex; gap: 8px;">
                <button type="button" data-capture-confirm>Usar captura</button>
                <button type="button" data-capture-cancel>Cancelar</button>
            </div>
        </div>
        <div class="muted" style="margin-bottom: 8px;">
            Clique e arraste para selecionar a área desejada da imagem capturada.
        </div>
        <div style="position: relative; border: 1px solid #1f2a44; border-radius: 10px; overflow: auto; max-height: 70vh;">
            <canvas data-capture-canvas style="display: block; max-width: 100%; height: auto;"></canvas>
        </div>
    </div>
</div>

<div class="modal" data-image-viewer-modal hidden>
    <div class="modal-backdrop" data-close-image-viewer></div>
    <div class="modal-content" style="width: min(1200px, 96vw);">
        <div class="topbar" style="margin-bottom: 8px;">
            <h3>Foto do orçamento</h3>
            <button type="button" data-close-image-viewer>Fechar</button>
        </div>
        <div style="display: flex; justify-content: center; align-items: center; min-height: 220px;">
            <img data-image-viewer-src alt="Foto do orçamento" style="max-width: 100%; max-height: 78vh; border: 1px solid #1f2a44; border-radius: 10px;" />
        </div>
    </div>
</div>

<template id="budget-item-template">
    <div class="ticket-legend budget-item" data-budget-item>
        <input type="hidden" name="budget_index" data-budget-index />
        <input type="hidden" data-field="quote-id" />
        <input type="hidden" data-field="source-quote-id" />
        <input type="hidden" data-field="parent-idx" />
        <input type="hidden" data-field="parent-quote-id" />
        <div class="budget-head">
            <div class="budget-head-meta">
                <span class="budget-kind" data-budget-kind>Principal</span>
                <span class="budget-title" data-budget-title>Orçamento</span>
            </div>
            <span class="budget-seq" data-budget-seq>#01</span>
        </div>
        <div class="muted" data-parent-label style="margin-bottom: 6px; display: none;"></div>
        <div class="form-row">
            <div style="flex: 2;">
                <label>Nome do orçamento</label>
                <input type="text" data-field="name" required />
            </div>
            <div>
                <label>Qtd</label>
                <input type="number" min="1" step="1" data-field="quantity" value="1" />
            </div>
            <div>
                <label>Valor</label>
                <input type="text" data-field="value" placeholder="Ex.: 18.652,22" required />
            </div>
            <div>
                <label>Frete</label>
                <input type="text" data-field="freight" placeholder="Ex.: 120,00" />
            </div>
            <div class="budget-actions-row">
                <label class="approve-pill" data-approve-single-wrap>
                    <input type="radio" data-field="approved" />
                    Aprovar
                </label>
                <label class="approve-pill" data-approve-multi-wrap style="display: none;">
                    <input type="checkbox" data-field="approved-multi" />
                    Aprovar
                </label>
                <button type="button" data-add-sub-budget>Suborçamentos (0)</button>
                <button type="button" data-copy-sub-budget style="display: none;">Copiar para...</button>
                <button type="button" data-remove-budget>Remover</button>
            </div>
        </div>
        <div class="form-row">
            <div style="flex: 2;">
                <label>Link</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="url" data-field="link" placeholder="https://..." />
                    <button type="button" data-open-budget-link>Abrir link</button>
                </div>
            </div>
            <div style="flex: 2;" data-photo-block>
                <label>Foto</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="file" accept="image/*" data-field="photo" />
                    <button type="button" data-capture-budget>Capturar</button>
                </div>
                <div style="margin-top: 8px;">
                    <img data-photo-preview alt="Preview" style="max-height: 90px; display: none; border: 1px solid #1f2a44; border-radius: 6px;" />
                </div>
            </div>
            <div style="flex: 2; display: none;" data-files-block>
                <label>Anexos (propostas)</label>
                <input type="file" data-field="proposal-files" multiple />
                <div class="muted" style="margin-top: 6px; font-size: 0.82rem;">Arquivos anexados neste orçamento:</div>
                <div data-proposal-files-list style="margin-top: 4px; display: grid; gap: 4px;"></div>
            </div>
        </div>
        <div class="muted" data-budget-created-at style="margin-top: 6px; font-size: 0.82rem;">
            Cadastrado em: novo (data/hora atual ao salvar)
        </div>
        <div class="muted" data-budget-package-total style="margin-top: 4px; font-size: 0.82rem; font-weight: 700;">
            Total deste orçamento: R$ 0,00
        </div>
    </div>
</template>

<script>
    (function () {
        const requisitionData = {
            {% for item in requisitions %}
            "{{ item.id }}": {
                id: {{ item.id }},
                code: "{{ item.code|escapejs }}",
                title: "{{ item.title|escapejs }}",
                request: "{{ item.request|escapejs }}",
                status: "{{ item.status|escapejs }}",
                kind: "{{ item.kind|default:'physical'|escapejs }}",
                quotes: [
                    {% for quote in item.quotes.all %}
                    {
                        id: {{ quote.id }},
                        parent_id: {% if quote.parent_id %}{{ quote.parent_id }}{% else %}null{% endif %},
                        parent_name: "{% if quote.parent %}{{ quote.parent.name|escapejs }}{% endif %}",
                        name: "{{ quote.name|escapejs }}",
                        quantity: "{{ quote.quantity|default:1|escapejs }}",
                        value: "{{ quote.value|floatformat:2|escapejs }}",
                        freight: "{{ quote.freight|floatformat:2|escapejs }}",
                        is_selected: {% if quote.is_selected %}true{% else %}false{% endif %},
                        link: "{{ quote.link|escapejs }}",
                        created_at: "{{ quote.created_at|date:'d/m/Y H:i'|escapejs }}",
                        photo_url: "{% if quote.photo %}{{ quote.photo.url|escapejs }}{% endif %}",
                        attachments: [
                            {% for attachment in quote.attachments.all %}
                            { url: "{{ attachment.file.url|escapejs }}", name: "{{ attachment.file.name|escapejs }}" }{% if not forloop.last %},{% endif %}
                            {% endfor %}
                        ],
                    }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        };

        const modal = document.querySelector('[data-requisition-modal]');
        const openBtns = Array.from(document.querySelectorAll('[data-open-requisition]'));
        const closeEls = document.querySelectorAll('[data-close-requisition]');
        const modalTitle = document.querySelector('[data-requisition-modal-title]');
        const modeInput = document.querySelector('[data-requisition-mode]');
        const requisitionIdInput = document.querySelector('[data-requisition-id-input]');
        const requisitionKindInput = document.querySelector('[data-requisition-kind-input]');
        const requisitionKindBadge = document.querySelector('[data-requisition-kind-badge]');
        const requisitionStatus = document.querySelector('#id_requisition_status');
        const requisitionTitle = document.querySelector('#id_requisition_title');
        const addBtn = document.querySelector('[data-add-budget]');
        const copyBtn = document.querySelector('[data-copy-budgets]');
        const copyWhatsAppBtn = document.querySelector('[data-copy-whatsapp]');
        const budgetList = document.querySelector('[data-budget-list]');
        const subBudgetModal = document.querySelector('[data-sub-budget-modal]');
        const subBudgetTitle = document.querySelector('[data-sub-budget-title]');
        const subBudgetList = document.querySelector('[data-sub-budget-list]');
        const subBudgetEmpty = document.querySelector('[data-sub-budget-empty]');
        const subBudgetAddBtn = document.querySelector('[data-sub-budget-add]');
        const closeSubBudgetEls = document.querySelectorAll('[data-close-sub-budget]');
        const form = document.querySelector('[data-requisition-form]');
        const requestInput = document.querySelector('#id_request_text');
        const template = document.querySelector('#budget-item-template');

        const captureModal = document.querySelector('[data-capture-modal]');
        const captureCanvas = document.querySelector('[data-capture-canvas]');
        const captureConfirmBtn = document.querySelector('[data-capture-confirm]');
        const captureCancelEls = document.querySelectorAll('[data-capture-cancel]');
        const imageViewerModal = document.querySelector('[data-image-viewer-modal]');
        const imageViewer = document.querySelector('[data-image-viewer-src]');
        const closeImageViewerEls = document.querySelectorAll('[data-close-image-viewer]');

        if (!modal || !openBtns.length || !budgetList || !template || !form || !modeInput || !requisitionIdInput || !requisitionKindInput || !requisitionStatus || !requisitionTitle || !subBudgetModal || !subBudgetTitle || !subBudgetList || !subBudgetEmpty || !subBudgetAddBtn) return;

        let budgetIndex = 0;
        let captureTargetInput = null;
        let captureTargetPreview = null;
        let captureImage = null;
        let selection = null;
        let dragging = false;
        let startX = 0;
        let startY = 0;
        let activeSubBudgetParent = null;
        let currentRequisitionKind = 'physical';

        const normalizeRequisitionKind = (value) => String(value || '').trim().toLowerCase() === 'digital' ? 'digital' : 'physical';
        const isDigitalRequisition = () => normalizeRequisitionKind(currentRequisitionKind) === 'digital';
        const kindLabel = (kind) => normalizeRequisitionKind(kind) === 'digital' ? 'Produtos digitais' : 'Física';
        const setRequisitionKind = (kind) => {
            currentRequisitionKind = normalizeRequisitionKind(kind);
            if (requisitionKindInput) requisitionKindInput.value = currentRequisitionKind;
            if (requisitionKindBadge) {
                requisitionKindBadge.textContent = kindLabel(currentRequisitionKind);
                requisitionKindBadge.classList.toggle('status-approved', currentRequisitionKind === 'digital');
            }
        };
        const renderProposalAttachmentList = (listEl, attachments = []) => {
            if (!listEl) return;
            const rows = Array.isArray(attachments) ? attachments.filter(Boolean) : [];
            if (!rows.length) {
                listEl.innerHTML = '<div class="muted">Nenhum anexo salvo.</div>';
                return;
            }
            listEl.innerHTML = rows.map((att) => {
                const rawName = String(att.name || '').split('/').pop() || 'Arquivo';
                const safeName = escapeHtml(rawName);
                const safeUrl = escapeHtml(att.url || '#');
                return `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${safeName}</a>`;
            }).join('');
        };
        const applyBudgetItemMode = (item) => {
            if (!item) return;
            const isDigital = isDigitalRequisition();
            const photoBlock = item.querySelector('[data-photo-block]');
            const filesBlock = item.querySelector('[data-files-block]');
            const photoInput = item.querySelector('[data-field="photo"]');
            const captureBtn = item.querySelector('[data-capture-budget]');
            const singleWrap = item.querySelector('[data-approve-single-wrap]');
            const multiWrap = item.querySelector('[data-approve-multi-wrap]');
            const singleInput = item.querySelector('[data-field="approved"]');
            const multiInput = item.querySelector('[data-field="approved-multi"]');
            const isSub = !!itemParentIdx(item);

            if (photoBlock) photoBlock.style.display = isDigital ? 'none' : '';
            if (filesBlock) filesBlock.style.display = isDigital ? '' : 'none';
            if (photoInput) photoInput.disabled = isDigital;
            if (captureBtn) captureBtn.style.display = isDigital ? 'none' : '';
            if (singleWrap) singleWrap.style.display = isDigital ? 'none' : '';
            if (multiWrap) multiWrap.style.display = isDigital ? '' : 'none';
            if (singleInput) {
                singleInput.disabled = isSub || isDigital;
                if (isDigital) singleInput.checked = false;
            }
            if (multiInput) {
                multiInput.disabled = isSub || !isDigital;
                if (!isDigital) multiInput.checked = false;
            }
        };
        const applyRequisitionKindMode = () => {
            allBudgetItems().forEach((item) => applyBudgetItemMode(item));
        };

        const openImageViewer = (src) => {
            if (!imageViewerModal || !imageViewer || !src) return;
            imageViewer.src = src;
            imageViewerModal.hidden = false;
        };

        const closeImageViewer = () => {
            if (!imageViewerModal || !imageViewer) return;
            imageViewerModal.hidden = true;
            imageViewer.removeAttribute('src');
        };

        closeImageViewerEls.forEach((el) => el.addEventListener('click', closeImageViewer));
        closeSubBudgetEls.forEach((el) => el.addEventListener('click', () => closeSubBudgetModal()));

        subBudgetAddBtn.addEventListener('click', () => {
            if (!activeSubBudgetParent) return;
            const parentIdx = itemIdx(activeSubBudgetParent);
            const parentQuoteId = (activeSubBudgetParent.querySelector('[data-field="quote-id"]')?.value || '').trim();
            const parentName = (activeSubBudgetParent.querySelector('[data-field="name"]')?.value || '').trim() || `Orcamento ${parentIdx}`;
            const created = addBudgetItem(null, {
                idx: parentIdx,
                quoteId: parentQuoteId,
                name: parentName,
            });
            if (created?.item) {
                created.item.style.display = '';
                subBudgetList.appendChild(created.item);
                updateSubBudgetEmptyState();
                recalculateBudgetPackages();
            }
        });

        const getDisplayStream = async () => {
            const constraints = { video: true, audio: false };
            if (navigator.mediaDevices && typeof navigator.mediaDevices.getDisplayMedia === 'function') {
                return navigator.mediaDevices.getDisplayMedia(constraints);
            }
            if (typeof navigator.getDisplayMedia === 'function') {
                return navigator.getDisplayMedia(constraints);
            }
            throw new Error('API de captura indisponível neste navegador/contexto.');
        };

        const clearBudgetItems = () => {
            closeSubBudgetModal();
            budgetList.innerHTML = '';
            subBudgetList.innerHTML = '';
            updateSubBudgetEmptyState();
        };

        const toBrValue = (value) => {
            const raw = (value || '').toString();
            if (!raw.trim()) return '';
            const n = Number(raw);
            if (Number.isNaN(n)) return raw;
            return n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        const formatMoneyInputPtBr = (value) => {
            const digits = (value || '').toString().replace(/\D/g, '');
            if (!digits) return '';
            const cents = digits.padStart(3, '0');
            const integerPartRaw = cents.slice(0, -2).replace(/^0+(?=\d)/, '');
            const integerPart = (integerPartRaw || '0').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            const decimalPart = cents.slice(-2);
            return `${integerPart},${decimalPart}`;
        };

        const parseBrNumber = (value) => {
            const raw = (value || '').toString().trim().replace(/\s/g, '');
            if (!raw) return 0;
            let normalized = raw;
            if (normalized.includes(',') && normalized.includes('.')) {
                if (normalized.lastIndexOf(',') > normalized.lastIndexOf('.')) {
                    normalized = normalized.replace(/\./g, '').replace(',', '.');
                } else {
                    normalized = normalized.replace(/,/g, '');
                }
            } else if (normalized.includes(',')) {
                normalized = normalized.replace(/\./g, '').replace(',', '.');
            }
            const n = Number(normalized);
            return Number.isFinite(n) ? n : 0;
        };
        const parsePositiveInt = (value) => {
            const n = Number.parseInt((value || '').toString().trim(), 10);
            return Number.isFinite(n) && n > 0 ? n : 1;
        };

        const toBrMoney = (value) => value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const formatMoneyForCopy = (value) => toBrMoney(parseBrNumber(value));
        const normalizeExternalLink = (value) => {
            const raw = (value || '').trim();
            if (!raw) return '';
            if (/^https?:\/\//i.test(raw)) return raw;
            return `https://${raw}`;
        };
        const escapeHtml = (value) => (value || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
        const escapeHtmlWithBreaks = (value) => {
            const normalized = (value || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            return escapeHtml(normalized).replace(/\n/g, '<br>');
        };
        const shortLinkLabel = (value) => {
            const normalized = normalizeExternalLink(value);
            if (!normalized) return '';
            try {
                const u = new URL(normalized);
                const host = u.hostname.replace(/^www\./i, '');
                return host.length > 28 ? `${host.slice(0, 28)}...` : host;
            } catch (_) {
                return normalized.slice(0, 28);
            }
        };
        const ensureAbsoluteMediaUrl = (value) => {
            const raw = (value || '').trim();
            if (!raw) return '';
            if (/^https?:\/\//i.test(raw)) return raw;
            if (raw.startsWith('/')) return `${window.location.origin}${raw}`;
            return '';
        };
        const blobToDataUrl = (blob) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(String(reader.result || ''));
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });
        const resolveClipboardImage = async (rawValue) => {
            const raw = (rawValue || '').trim();
            if (!raw) return { htmlSrc: '', fallbackLink: '' };
            if (raw.startsWith('data:image/')) {
                return { htmlSrc: raw, fallbackLink: '' };
            }
            const absolute = ensureAbsoluteMediaUrl(raw) || raw;
            if (!/^https?:\/\//i.test(absolute) && !absolute.startsWith('blob:')) {
                return { htmlSrc: '', fallbackLink: '' };
            }
            try {
                const response = await fetch(absolute, { credentials: 'include' });
                if (!response.ok) {
                    return { htmlSrc: '', fallbackLink: ensureAbsoluteMediaUrl(absolute) };
                }
                const blob = await response.blob();
                if (!blob.type.startsWith('image/')) {
                    return { htmlSrc: '', fallbackLink: ensureAbsoluteMediaUrl(absolute) };
                }
                const dataUrl = await blobToDataUrl(blob);
                return {
                    htmlSrc: dataUrl,
                    fallbackLink: ensureAbsoluteMediaUrl(absolute),
                };
            } catch (_) {
                return {
                    htmlSrc: '',
                    fallbackLink: ensureAbsoluteMediaUrl(absolute),
                };
            }
        };
        const budgetAccentPalette = ['#38bdf8', '#22c55e', '#f59e0b', '#a78bfa', '#f97316', '#14b8a6'];

        const allBudgetItems = () => Array.from(form.querySelectorAll('[data-budget-item]'));
        const itemIdx = (item) => (item.querySelector('[data-budget-index]')?.value || '').trim();
        const itemParentIdx = (item) => (item.querySelector('[data-field="parent-idx"]')?.value || '').trim();
        const budgetCardAccent = (index) => budgetAccentPalette[index % budgetAccentPalette.length];

        const refreshBudgetCardStyles = () => {
            const items = allBudgetItems();
            const mainItems = items.filter((item) => !itemParentIdx(item));
            const mainAccentByIdx = new Map();

            mainItems.forEach((item, position) => {
                const idx = itemIdx(item);
                const accent = budgetCardAccent(position);
                const kindEl = item.querySelector('[data-budget-kind]');
                const titleEl = item.querySelector('[data-budget-title]');
                const seqEl = item.querySelector('[data-budget-seq]');
                item.dataset.budgetRole = 'main';
                item.style.setProperty('--budget-accent', accent);
                if (idx) mainAccentByIdx.set(idx, accent);
                if (kindEl) kindEl.textContent = 'Orçamento principal';
                if (titleEl) titleEl.textContent = (item.querySelector('[data-field="name"]')?.value || '').trim() || 'Orçamento principal';
                if (seqEl) seqEl.textContent = `#${String(position + 1).padStart(2, '0')}`;
            });

            items.filter((item) => itemParentIdx(item)).forEach((item, subPosition) => {
                const parentIdx = itemParentIdx(item);
                const accent = mainAccentByIdx.get(parentIdx) || '#64748b';
                const kindEl = item.querySelector('[data-budget-kind]');
                const titleEl = item.querySelector('[data-budget-title]');
                const seqEl = item.querySelector('[data-budget-seq]');
                item.dataset.budgetRole = 'sub';
                item.style.setProperty('--budget-accent', accent);
                if (kindEl) kindEl.textContent = 'Suborçamento';
                if (titleEl) titleEl.textContent = (item.querySelector('[data-field="name"]')?.value || '').trim() || 'Suborçamento';
                if (seqEl) seqEl.textContent = `SUB-${String(subPosition + 1).padStart(2, '0')}`;
            });
        };

        const recalculateBudgetPackages = () => {
            const items = allBudgetItems();
            const subsByParent = new Map();
            items.forEach((item) => {
                const p = itemParentIdx(item);
                if (!p) return;
                if (!subsByParent.has(p)) subsByParent.set(p, []);
                subsByParent.get(p).push(item);
            });

            items.forEach((mainItem) => {
                const mainIdx = itemIdx(mainItem);
                if (!mainIdx || itemParentIdx(mainItem)) return;
                const packageEl = mainItem.querySelector('[data-budget-package-total]');
                if (!packageEl) return;

                let total = 0;
                const mainQty = parsePositiveInt(mainItem.querySelector('[data-field="quantity"]')?.value || '1');
                const mainValue = parseBrNumber(mainItem.querySelector('[data-field="value"]')?.value || '');
                const mainFreight = parseBrNumber(mainItem.querySelector('[data-field="freight"]')?.value || '');
                total += (mainQty * mainValue) + mainFreight;

                const subItems = subsByParent.get(mainIdx) || [];
                subItems.forEach((subItem) => {
                    const subQty = parsePositiveInt(subItem.querySelector('[data-field="quantity"]')?.value || '1');
                    total += subQty * parseBrNumber(subItem.querySelector('[data-field="value"]')?.value || '');
                    total += parseBrNumber(subItem.querySelector('[data-field="freight"]')?.value || '');
                });
                packageEl.textContent = `Total deste orçamento: R$ ${toBrMoney(total)}`;
            });
        };

        const updateSubBudgetEmptyState = () => {
            subBudgetEmpty.style.display = subBudgetList.querySelector('[data-budget-item]') ? 'none' : '';
        };

        const moveSubItemsBackToMainList = () => {
            const moved = Array.from(subBudgetList.querySelectorAll('[data-budget-item]'));
            if (!moved.length) return;
            if (activeSubBudgetParent && activeSubBudgetParent.isConnected) {
                let anchor = activeSubBudgetParent;
                moved.forEach((item) => {
                    anchor.insertAdjacentElement('afterend', item);
                    anchor = item;
                });
            } else {
                moved.forEach((item) => budgetList.appendChild(item));
            }
        };

        const closeSubBudgetModal = () => {
            moveSubItemsBackToMainList();
            subBudgetModal.hidden = true;
            activeSubBudgetParent = null;
            updateSubBudgetEmptyState();
            applySubBudgetVisibility();
        };

        const openSubBudgetModal = (parentItem) => {
            moveSubItemsBackToMainList();
            activeSubBudgetParent = parentItem;
            const parentName = (parentItem.querySelector('[data-field="name"]')?.value || '').trim() || 'Orçamento';
            const parentIdx = itemIdx(parentItem);
            subBudgetTitle.textContent = `Suborçamentos - ${parentName}`;
            subBudgetModal.hidden = false;

            const subItems = allBudgetItems().filter((item) => itemParentIdx(item) === parentIdx);
            subItems.forEach((item) => {
                item.style.display = '';
                subBudgetList.appendChild(item);
            });
            updateSubBudgetEmptyState();
            recalculateBudgetPackages();
        };

        const applySubBudgetVisibility = () => {
            const items = allBudgetItems();
            const subsByParent = new Map();
            items.forEach((item) => {
                const p = itemParentIdx(item);
                if (!p) return;
                if (!subsByParent.has(p)) subsByParent.set(p, []);
                subsByParent.get(p).push(item);
            });

            items.forEach((mainItem) => {
                const mainIdx = itemIdx(mainItem);
                if (!mainIdx || itemParentIdx(mainItem)) return;
                const subBtn = mainItem.querySelector('[data-add-sub-budget]');
                if (!subBtn) return;
                const subItems = subsByParent.get(mainIdx) || [];
                subBtn.textContent = `Suborçamentos (${subItems.length})`;
                subItems.forEach((subItem) => {
                    const inOpenModal = !subBudgetModal.hidden && activeSubBudgetParent && itemIdx(activeSubBudgetParent) === mainIdx && subBudgetList.contains(subItem);
                    subItem.style.display = inOpenModal ? '' : 'none';
                });
            });

            refreshBudgetCardStyles();
            recalculateBudgetPackages();
        };

        const getMainBudgetTargets = (excludeMainIdx = '') => {
            const exclude = String(excludeMainIdx || '').trim();
            return allBudgetItems()
                .filter((item) => !itemParentIdx(item))
                .filter((item) => itemIdx(item) !== exclude);
        };

        const askTargetMainBudget = (targets) => {
            if (!targets.length) return { item: null, cancelled: false, invalid: true };
            const lines = targets.map((item) => {
                const name = (item.querySelector('[data-field="name"]')?.value || '').trim() || 'Orçamento sem nome';
                const idx = itemIdx(item);
                const quoteId = (item.querySelector('[data-field="quote-id"]')?.value || '').trim();
                const persisted = quoteId ? ` | ID salvo: ${quoteId}` : '';
                return `ID: ${idx}${persisted} | ${name}`;
            });
            const answer = window.prompt(
                `Copiar suborçamento para qual orçamento principal?\nDigite o ID exibido na lista.\n\n${lines.join('\n')}`,
                targets[0] ? itemIdx(targets[0]) : ''
            );
            if (answer === null) return { item: null, cancelled: true, invalid: false };
            const typed = String(answer || '').trim();
            if (!typed) return { item: null, cancelled: false, invalid: true };
            const normalized = typed.toLowerCase();

            const matched = targets.find((item) => {
                const idx = itemIdx(item);
                const quoteId = (item.querySelector('[data-field="quote-id"]')?.value || '').trim();
                return normalized === String(idx).toLowerCase() || (quoteId && normalized === String(quoteId).toLowerCase());
            }) || null;

            return { item: matched, cancelled: false, invalid: !matched };
        };

        const cloneSubBudgetToMain = (sourceItem, targetMainItem) => {
            const targetMainIdx = itemIdx(targetMainItem);
            const targetMainQuoteId = (targetMainItem.querySelector('[data-field="quote-id"]')?.value || '').trim();
            const targetMainName = (targetMainItem.querySelector('[data-field="name"]')?.value || '').trim() || `Orçamento ${targetMainIdx}`;
            const created = addBudgetItem(null, {
                idx: targetMainIdx,
                quoteId: targetMainQuoteId,
                name: targetMainName,
            });
            if (!created?.item) return null;

            const srcName = sourceItem.querySelector('[data-field="name"]');
            const srcQuantity = sourceItem.querySelector('[data-field="quantity"]');
            const srcValue = sourceItem.querySelector('[data-field="value"]');
            const srcFreight = sourceItem.querySelector('[data-field="freight"]');
            const srcLink = sourceItem.querySelector('[data-field="link"]');
            const srcPreview = sourceItem.querySelector('[data-photo-preview]');
            const srcPhoto = sourceItem.querySelector('[data-field="photo"]');

            const dstName = created.item.querySelector('[data-field="name"]');
            const dstQuantity = created.item.querySelector('[data-field="quantity"]');
            const dstValue = created.item.querySelector('[data-field="value"]');
            const dstFreight = created.item.querySelector('[data-field="freight"]');
            const dstLink = created.item.querySelector('[data-field="link"]');
            const dstPreview = created.item.querySelector('[data-photo-preview]');
            const dstPhoto = created.item.querySelector('[data-field="photo"]');

            if (dstName && srcName) dstName.value = srcName.value || '';
            if (dstQuantity && srcQuantity) dstQuantity.value = srcQuantity.value || '1';
            if (dstValue && srcValue) dstValue.value = srcValue.value || '';
            if (dstFreight && srcFreight) dstFreight.value = srcFreight.value || '';
            if (dstLink && srcLink) dstLink.value = srcLink.value || '';

            // Best-effort clone for local files (unsaved captures/uploads).
            const srcFile = srcPhoto?.files?.[0];
            if (srcFile && dstPhoto) {
                const dt = new DataTransfer();
                dt.items.add(srcFile);
                dstPhoto.files = dt.files;
            } else if (srcPreview && dstPreview) {
                const src = (srcPreview.getAttribute('src') || '').trim();
                if (src) {
                    dstPreview.setAttribute('src', src);
                    dstPreview.style.display = srcPreview.style.display || 'block';
                }
            }

            return created.item;
        };

        const collectBudgetData = () => {
            const allItems = Array.from(form.querySelectorAll('[data-budget-item]'));
            const parsed = allItems.map((item) => {
                const idx = itemIdx(item);
                const parentIdx = itemParentIdx(item);
                const name = (item.querySelector('[data-field="name"]')?.value || '').trim();
                const quantity = parsePositiveInt(item.querySelector('[data-field="quantity"]')?.value || '1');
                const value = (item.querySelector('[data-field="value"]')?.value || '').trim();
                const freight = (item.querySelector('[data-field="freight"]')?.value || '').trim();
                const linkRaw = (item.querySelector('[data-field="link"]')?.value || '').trim();
                const link = normalizeExternalLink(linkRaw);
                const linkLabel = shortLinkLabel(linkRaw);
                const createdAt = (item.querySelector('[data-budget-created-at]')?.textContent || '').trim();
                const previewSrc = (item.querySelector('[data-photo-preview]')?.getAttribute('src') || '').trim();
                if (!name && !value && !freight && !link) return null;
                return {
                    idx,
                    parentIdx,
                    name,
                    quantity,
                    value: value || '0,00',
                    freight: freight || '0,00',
                    link,
                    linkLabel,
                    createdAt,
                    previewSrc,
                };
            }).filter(Boolean);

            const byParent = new Map();
            parsed.forEach((entry) => {
                if (!entry.parentIdx) return;
                if (!byParent.has(entry.parentIdx)) byParent.set(entry.parentIdx, []);
                byParent.get(entry.parentIdx).push(entry);
            });

            const mainItems = parsed.filter((entry) => !entry.parentIdx);
            return { mainItems, byParent };
        };

        const setBudgetFieldNames = (item, idx) => {
            item.querySelector('[data-budget-index]').value = String(idx);
            item.querySelector('[data-field="quote-id"]').name = `budget_quote_id_${idx}`;
            item.querySelector('[data-field="source-quote-id"]').name = `budget_source_quote_id_${idx}`;
            item.querySelector('[data-field="parent-idx"]').name = `budget_parent_idx_${idx}`;
            item.querySelector('[data-field="parent-quote-id"]').name = `budget_parent_quote_id_${idx}`;
            item.querySelector('[data-field="name"]').name = `budget_name_${idx}`;
            item.querySelector('[data-field="quantity"]').name = `budget_quantity_${idx}`;
            item.querySelector('[data-field="value"]').name = `budget_value_${idx}`;
            item.querySelector('[data-field="freight"]').name = `budget_freight_${idx}`;
            item.querySelector('[data-field="link"]').name = `budget_link_${idx}`;
            item.querySelector('[data-field="photo"]').name = `budget_photo_${idx}`;
            item.querySelector('[data-field="proposal-files"]').name = `budget_files_${idx}`;
            item.querySelector('[data-field="approved"]').name = 'approved_budget_idx';
            item.querySelector('[data-field="approved"]').value = String(idx);
            item.querySelector('[data-field="approved-multi"]').name = 'approved_budget_idx_list';
            item.querySelector('[data-field="approved-multi"]').value = String(idx);
        };

        const addBudgetItem = (initialData = null, parentMeta = null) => {
            const fragment = template.content.cloneNode(true);
            const item = fragment.querySelector('[data-budget-item]');
            const idx = ++budgetIndex;
            setBudgetFieldNames(item, idx);

            const quoteIdInput = item.querySelector('[data-field="quote-id"]');
            const sourceQuoteIdInput = item.querySelector('[data-field="source-quote-id"]');
            const parentIdxInput = item.querySelector('[data-field="parent-idx"]');
            const parentQuoteIdInput = item.querySelector('[data-field="parent-quote-id"]');
            const parentLabel = item.querySelector('[data-parent-label]');
            const nameInput = item.querySelector('[data-field="name"]');
            const quantityInput = item.querySelector('[data-field="quantity"]');
            const valueInput = item.querySelector('[data-field="value"]');
            const freightInput = item.querySelector('[data-field="freight"]');
            const linkInput = item.querySelector('[data-field="link"]');
            const createdAtEl = item.querySelector('[data-budget-created-at]');
            const packageTotalEl = item.querySelector('[data-budget-package-total]');
            const removeBtn = item.querySelector('[data-remove-budget]');
            const addSubBtn = item.querySelector('[data-add-sub-budget]');
            const copySubBtn = item.querySelector('[data-copy-sub-budget]');
            const approvedInput = item.querySelector('[data-field="approved"]');
            const approvedMultiInput = item.querySelector('[data-field="approved-multi"]');
            const proposalFilesInput = item.querySelector('[data-field="proposal-files"]');
            const proposalFilesList = item.querySelector('[data-proposal-files-list]');
            const openLinkBtn = item.querySelector('[data-open-budget-link]');
            const captureBtn = item.querySelector('[data-capture-budget]');
            const photoInput = item.querySelector('[data-field="photo"]');
            const preview = item.querySelector('[data-photo-preview]');

            const clearAsParent = (removedIdx) => {
                const pending = [String(removedIdx)];
                while (pending.length) {
                    const parent = pending.shift();
                    const all = Array.from(form.querySelectorAll('[data-budget-item]'));
                    all.forEach((other) => {
                        const otherParentIdx = (other.querySelector('[data-field="parent-idx"]')?.value || '').trim();
                        if (!otherParentIdx || otherParentIdx !== parent) return;
                        const childIdx = (other.querySelector('[data-budget-index]')?.value || '').trim();
                        if (childIdx) pending.push(childIdx);
                        other.remove();
                    });
                }
            };

            preview.style.cursor = 'zoom-in';
            preview.addEventListener('click', () => {
                const src = preview.getAttribute('src') || '';
                if (!src || preview.style.display === 'none') return;
                openImageViewer(src);
            });

            removeBtn.addEventListener('click', () => {
                if (budgetList.querySelectorAll('[data-budget-item]').length <= 1) return;
                clearAsParent(idx);
                item.remove();
                applySubBudgetVisibility();
            });

            addSubBtn.addEventListener('click', () => {
                if (parentMeta) {
                    return;
                }
                openSubBudgetModal(item);
            });

            if (copySubBtn) {
                copySubBtn.addEventListener('click', () => {
                    const currentParentIdx = itemParentIdx(item);
                    if (!currentParentIdx) return;
                    const targets = getMainBudgetTargets(currentParentIdx);
                    if (!targets.length) {
                        alert('Não há outro orçamento principal para copiar.');
                        return;
                    }
                    const pick = askTargetMainBudget(targets);
                    if (pick.cancelled) return;
                    if (pick.invalid || !pick.item) {
                        alert('ID de orçamento inválido. Use o ID mostrado na lista do prompt.');
                        return;
                    }
                    const copied = cloneSubBudgetToMain(item, pick.item);
                    if (!copied) {
                        alert('Não foi possível copiar o suborçamento.');
                        return;
                    }
                    applySubBudgetVisibility();
                    const targetName = (pick.item.querySelector('[data-field="name"]')?.value || '').trim() || 'destino';
                    alert(`Suborçamento copiado com sucesso para: ${targetName}.`);
                });
            }

            if (openLinkBtn) {
                openLinkBtn.addEventListener('click', () => {
                    const candidate = normalizeExternalLink(linkInput.value);
                    if (!candidate) {
                        alert('Informe um link para abrir.');
                        return;
                    }
                    try {
                        const url = new URL(candidate);
                        window.open(url.toString(), '_blank', 'noopener,noreferrer');
                    } catch (err) {
                        alert(`Link inválido: ${err}`);
                    }
                });
            }

            if (parentMeta) {
                parentIdxInput.value = String(parentMeta.idx || '');
                parentQuoteIdInput.value = parentMeta.quoteId || '';
                if (parentLabel) {
                    parentLabel.textContent = `Suborcamento de: ${parentMeta.name || 'Orcamento principal'}`;
                    parentLabel.style.display = '';
                }
                item.style.marginLeft = '28px';
                item.style.borderLeft = '3px solid #334155';
                if (approvedInput) {
                    approvedInput.checked = false;
                    approvedInput.disabled = true;
                }
                if (approvedMultiInput) {
                    approvedMultiInput.checked = false;
                    approvedMultiInput.disabled = true;
                }
                if (addSubBtn) {
                    addSubBtn.style.display = 'none';
                }
                if (copySubBtn) {
                    copySubBtn.style.display = '';
                }
                if (packageTotalEl) {
                    packageTotalEl.style.display = 'none';
                }
            } else {
                parentIdxInput.value = '';
                parentQuoteIdInput.value = '';
                if (approvedInput) {
                    approvedInput.disabled = false;
                }
                if (approvedMultiInput) {
                    approvedMultiInput.disabled = false;
                }
                if (packageTotalEl) {
                    packageTotalEl.style.display = '';
                }
                if (addSubBtn) {
                    addSubBtn.style.display = '';
                }
                if (copySubBtn) {
                    copySubBtn.style.display = 'none';
                }
            }

            if (initialData) {
                quoteIdInput.value = initialData.id && !initialData._noPersistId ? String(initialData.id) : '';
                sourceQuoteIdInput.value = initialData.source_quote_id ? String(initialData.source_quote_id) : '';
                nameInput.value = initialData.name || '';
                quantityInput.value = String(parsePositiveInt(initialData.quantity || '1'));
                valueInput.value = toBrValue(initialData.value || '');
                freightInput.value = toBrValue(initialData.freight || '');
                linkInput.value = initialData.link || '';
                if (approvedInput) {
                    approvedInput.checked = !!initialData.is_selected && !initialData.parent_id;
                }
                if (approvedMultiInput) {
                    approvedMultiInput.checked = !!initialData.is_selected && !initialData.parent_id;
                }
                renderProposalAttachmentList(proposalFilesList, initialData.attachments || []);
                if (createdAtEl) {
                    createdAtEl.textContent = `Cadastrado em: ${initialData.created_at || 'data indisponível'}`;
                }
                if (initialData.photo_url) {
                    preview.src = initialData.photo_url;
                    preview.style.display = 'block';
                }
            }

            if (!initialData) {
                renderProposalAttachmentList(proposalFilesList, []);
            }

            photoInput.addEventListener('change', () => {
                const file = photoInput.files && photoInput.files[0];
                if (!file) {
                    if (!initialData || !initialData.photo_url) {
                        preview.style.display = 'none';
                        preview.removeAttribute('src');
                    }
                    return;
                }
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
            });

            if (quantityInput) {
                quantityInput.addEventListener('input', recalculateBudgetPackages);
                quantityInput.addEventListener('change', recalculateBudgetPackages);
            }
            [valueInput, freightInput].forEach((moneyInput) => {
                if (!moneyInput) return;
                moneyInput.addEventListener('input', () => {
                    const formatted = formatMoneyInputPtBr(moneyInput.value);
                    if (moneyInput.value !== formatted) {
                        moneyInput.value = formatted;
                    }
                    recalculateBudgetPackages();
                });
                moneyInput.addEventListener('change', () => {
                    moneyInput.value = formatMoneyInputPtBr(moneyInput.value);
                    recalculateBudgetPackages();
                });
            });
            if (nameInput) {
                nameInput.addEventListener('input', refreshBudgetCardStyles);
                nameInput.addEventListener('change', refreshBudgetCardStyles);
            }

            if (proposalFilesInput) {
                proposalFilesInput.addEventListener('change', () => {
                    const files = Array.from(proposalFilesInput.files || []).map((f) => ({ name: f.name, url: '' }));
                    renderProposalAttachmentList(proposalFilesList, files);
                });
            }

            captureBtn.addEventListener('click', async () => {
                if (isDigitalRequisition()) return;
                try {
                    const stream = await getDisplayStream();
                    const video = document.createElement('video');
                    video.srcObject = stream;
                    await video.play();

                    const w = video.videoWidth || 1280;
                    const h = video.videoHeight || 720;
                    const tmpCanvas = document.createElement('canvas');
                    tmpCanvas.width = w;
                    tmpCanvas.height = h;
                    const tmpCtx = tmpCanvas.getContext('2d');
                    tmpCtx.drawImage(video, 0, 0, w, h);

                    stream.getTracks().forEach((t) => t.stop());
                    video.srcObject = null;

                    captureImage = new Image();
                    captureImage.onload = () => {
                        captureCanvas.width = captureImage.width;
                        captureCanvas.height = captureImage.height;
                        const ctx = captureCanvas.getContext('2d');
                        ctx.drawImage(captureImage, 0, 0);
                        selection = null;
                        captureTargetInput = photoInput;
                        captureTargetPreview = preview;
                        captureModal.hidden = false;
                    };
                    captureImage.src = tmpCanvas.toDataURL('image/png');
                } catch (err) {
                    const secureHint = window.isSecureContext
                        ? ''
                        : ' Abra por https:// ou http://localhost para permitir captura.';
                    alert(`Não foi possível capturar a tela: ${err}.${secureHint} Vou abrir seleção de arquivo como alternativa.`);
                    photoInput.click();
                }
            });

            applyBudgetItemMode(item);
            budgetList.appendChild(item);
            applySubBudgetVisibility();
            return { idx, item };
        };

        const drawCapture = () => {
            if (!captureImage) return;
            const ctx = captureCanvas.getContext('2d');
            ctx.clearRect(0, 0, captureCanvas.width, captureCanvas.height);
            ctx.drawImage(captureImage, 0, 0);

            if (selection && selection.w > 0 && selection.h > 0) {
                ctx.save();
                ctx.strokeStyle = '#22c55e';
                ctx.lineWidth = 2;
                ctx.setLineDash([8, 4]);
                ctx.strokeRect(selection.x, selection.y, selection.w, selection.h);
                ctx.fillStyle = 'rgba(34, 197, 94, 0.15)';
                ctx.fillRect(selection.x, selection.y, selection.w, selection.h);
                ctx.restore();
            }
        };

        const toCanvasCoordinates = (event) => {
            const rect = captureCanvas.getBoundingClientRect();
            const scaleX = captureCanvas.width / rect.width;
            const scaleY = captureCanvas.height / rect.height;
            return {
                x: Math.max(0, Math.min(captureCanvas.width, (event.clientX - rect.left) * scaleX)),
                y: Math.max(0, Math.min(captureCanvas.height, (event.clientY - rect.top) * scaleY)),
            };
        };

        captureCanvas.addEventListener('mousedown', (event) => {
            if (!captureImage) return;
            dragging = true;
            const p = toCanvasCoordinates(event);
            startX = p.x;
            startY = p.y;
            selection = { x: p.x, y: p.y, w: 0, h: 0 };
            drawCapture();
        });

        captureCanvas.addEventListener('mousemove', (event) => {
            if (!dragging || !captureImage) return;
            const p = toCanvasCoordinates(event);
            const x = Math.min(startX, p.x);
            const y = Math.min(startY, p.y);
            const w = Math.abs(p.x - startX);
            const h = Math.abs(p.y - startY);
            selection = { x, y, w, h };
            drawCapture();
        });

        window.addEventListener('mouseup', () => {
            dragging = false;
        });

        const closeCapture = () => {
            captureModal.hidden = true;
            captureImage = null;
            selection = null;
            captureTargetInput = null;
            captureTargetPreview = null;
        };

        captureCancelEls.forEach((el) => el.addEventListener('click', closeCapture));

        captureConfirmBtn.addEventListener('click', () => {
            if (!captureImage || !captureTargetInput) return;
            let crop = selection;
            if (!crop || crop.w < 4 || crop.h < 4) {
                crop = { x: 0, y: 0, w: captureCanvas.width, h: captureCanvas.height };
            }
            const out = document.createElement('canvas');
            out.width = Math.floor(crop.w);
            out.height = Math.floor(crop.h);
            const outCtx = out.getContext('2d');
            outCtx.drawImage(
                captureCanvas,
                crop.x,
                crop.y,
                crop.w,
                crop.h,
                0,
                0,
                out.width,
                out.height
            );
            out.toBlob((blob) => {
                if (!blob) return;
                const file = new File([blob], `captura-${Date.now()}.png`, { type: 'image/png' });
                const dt = new DataTransfer();
                dt.items.add(file);
                captureTargetInput.files = dt.files;
                captureTargetPreview.src = URL.createObjectURL(file);
                captureTargetPreview.style.display = 'block';
                closeCapture();
            }, 'image/png');
        });

        const openCreate = (kind = 'physical') => {
            closeSubBudgetModal();
            const normalizedKind = normalizeRequisitionKind(kind);
            setRequisitionKind(normalizedKind);
            modeInput.value = 'create';
            requisitionIdInput.value = '';
            modalTitle.textContent = normalizedKind === 'digital' ? 'Nova requisição de produtos digitais' : 'Nova requisição física';
            requisitionTitle.value = '';
            requestInput.value = '';
            requisitionStatus.value = 'pending_approval';
            clearBudgetItems();
            budgetIndex = 0;
            addBudgetItem();
            applyRequisitionKindMode();
            modal.hidden = false;
        };

        const openEdit = (id) => {
            closeSubBudgetModal();
            const data = requisitionData[String(id)];
            if (!data) return;
            modeInput.value = 'update';
            requisitionIdInput.value = String(data.id);
            setRequisitionKind(data.kind || 'physical');
            modalTitle.textContent = `Editar requisição ${data.code || ('TI - ' + String(data.id).padStart(4, '0'))}`;
            requisitionTitle.value = data.title || '';
            requestInput.value = data.request || '';
            requisitionStatus.value = data.status || 'pending_approval';
            clearBudgetItems();
            budgetIndex = 0;
            if (Array.isArray(data.quotes) && data.quotes.length) {
                const byId = {};
                const byQuoteIdToIdx = {};
                const pending = [...data.quotes];
                let guard = 0;
                while (pending.length && guard < 500) {
                    guard += 1;
                    let progressed = false;
                    for (let i = pending.length - 1; i >= 0; i -= 1) {
                        const q = pending[i];
                        const parentId = q.parent_id;
                        if (!parentId || byQuoteIdToIdx[parentId]) {
                            const parentMeta = parentId
                                ? byQuoteIdToIdx[parentId]
                                : null;
                            const created = addBudgetItem(q, parentMeta);
                            byId[q.id] = created;
                            byQuoteIdToIdx[q.id] = {
                                idx: created.idx,
                                quoteId: String(q.id),
                                name: q.name || `Orcamento ${created.idx}`,
                            };
                            pending.splice(i, 1);
                            progressed = true;
                        }
                    }
                    if (!progressed) {
                        const q = pending.shift();
                        const created = addBudgetItem(q, null);
                        byId[q.id] = created;
                        byQuoteIdToIdx[q.id] = {
                            idx: created.idx,
                            quoteId: String(q.id),
                            name: q.name || `Orcamento ${created.idx}`,
                        };
                    }
                }
            } else {
                addBudgetItem();
            }
            applyRequisitionKindMode();
            modal.hidden = false;
        };

        const openDuplicate = (id) => {
            closeSubBudgetModal();
            const data = requisitionData[String(id)];
            if (!data) return;
            modeInput.value = 'create';
            requisitionIdInput.value = '';
            setRequisitionKind(data.kind || 'physical');
            modalTitle.textContent = `Duplicar requisição ${data.code || ('TI - ' + String(data.id).padStart(4, '0'))}`;
            requisitionTitle.value = data.title || '';
            requestInput.value = data.request || '';
            requisitionStatus.value = 'pending_approval';
            clearBudgetItems();
            budgetIndex = 0;
            if (Array.isArray(data.quotes) && data.quotes.length) {
                const byId = {};
                const byQuoteIdToIdx = {};
                const pending = data.quotes.map((q) => ({
                    ...q,
                    id: q.id,
                    source_quote_id: q.id,
                    parent_id: q.parent_id,
                    is_selected: false,
                    _noPersistId: true,
                }));
                let guard = 0;
                while (pending.length && guard < 500) {
                    guard += 1;
                    let progressed = false;
                    for (let i = pending.length - 1; i >= 0; i -= 1) {
                        const q = pending[i];
                        const parentId = q.parent_id;
                        if (!parentId || byQuoteIdToIdx[parentId]) {
                            const parentMeta = parentId
                                ? byQuoteIdToIdx[parentId]
                                : null;
                            const created = addBudgetItem(q, parentMeta);
                            byId[q.id] = created;
                            byQuoteIdToIdx[q.id] = {
                                idx: created.idx,
                                quoteId: '',
                                name: q.name || `Orcamento ${created.idx}`,
                            };
                            pending.splice(i, 1);
                            progressed = true;
                        }
                    }
                    if (!progressed) {
                        const q = pending.shift();
                        const created = addBudgetItem(q, null);
                        byId[q.id] = created;
                        byQuoteIdToIdx[q.id] = {
                            idx: created.idx,
                            quoteId: '',
                            name: q.name || `Orcamento ${created.idx}`,
                        };
                    }
                }
            } else {
                addBudgetItem();
            }
            applyRequisitionKindMode();
            modal.hidden = false;
        };

        const close = () => {
            closeSubBudgetModal();
            modal.hidden = true;
        };

        openBtns.forEach((btn) => {
            btn.addEventListener('click', () => openCreate(btn.getAttribute('data-requisition-kind') || 'physical'));
        });
        closeEls.forEach((el) => el.addEventListener('click', close));
        addBtn.addEventListener('click', addBudgetItem);

        document.querySelectorAll('[data-req-row]').forEach((row) => {
            row.addEventListener('click', () => {
                const id = row.getAttribute('data-requisition-id');
                if (!id) return;
                openEdit(id);
            });
        });
        document.querySelectorAll('[data-duplicate-requisition]').forEach((btn) => {
            btn.addEventListener('click', (event) => {
                event.preventDefault();
                event.stopPropagation();
                const id = btn.getAttribute('data-requisition-id');
                if (!id) return;
                openDuplicate(id);
            });
        });
        document.querySelectorAll('[data-mark-received-form], [data-mark-received-button]').forEach((el) => {
            el.addEventListener('click', (event) => {
                event.stopPropagation();
            });
        });
        document.querySelectorAll('[data-mark-rejected-form], [data-mark-rejected-button]').forEach((el) => {
            el.addEventListener('click', (event) => {
                event.stopPropagation();
            });
        });

        copyBtn.addEventListener('click', async () => {
            const reqText = (requestInput.value || '').trim();
            const reqTitle = (requisitionTitle.value || '').trim();
            const reqCode = modeInput.value === 'update'
                ? `TI - ${String(requisitionIdInput.value || '0').padStart(4, '0')}`
                : '(a definir após salvar)';
            const { mainItems, byParent } = collectBudgetData();
            const reqLines = (reqText || '(sem texto)').replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');

            const lines = [
                `Título: ${reqCode} - ${reqTitle || '(sem título)'}`,
                'Requisição:',
                ...reqLines,
                '',
                'Orçamentos:',
                '============================================================',
            ];

            const htmlParts = [
                `<div style="font-family:Segoe UI,Arial,sans-serif;color:#0f172a;line-height:1.4;">`,
                `<p><strong>Título:</strong> ${escapeHtml(reqCode)} - ${escapeHtml(reqTitle || '(sem título)')}<br><strong>Requisição:</strong><br>${escapeHtmlWithBreaks(reqText || '(sem texto)')}</p>`,
                `<p><strong>Orçamentos:</strong></p>`,
                `<ol style="margin:0;padding-left:20px;">`,
            ];

            for (let i = 0; i < mainItems.length; i += 1) {
                const main = mainItems[i];
                const subs = byParent.get(main.idx) || [];
                const mainQty = parsePositiveInt(main.quantity || '1');
                let total = (mainQty * parseBrNumber(main.value)) + parseBrNumber(main.freight);
                for (const sub of subs) {
                    const subQty = parsePositiveInt(sub.quantity || '1');
                    total += (subQty * parseBrNumber(sub.value)) + parseBrNumber(sub.freight);
                }
                const mainValueFormatted = formatMoneyForCopy(main.value);
                const mainFreightFormatted = formatMoneyForCopy(main.freight);

                lines.push(`[ORÇAMENTO ${i + 1}] ${main.name || '(sem nome)'}`);
                lines.push(`   Qtd: ${mainQty} | Valor unit.: R$ ${mainValueFormatted} | Frete: R$ ${mainFreightFormatted} | Total pacote: R$ ${toBrMoney(total)}`);
                if (main.link) lines.push(`   Link (${main.linkLabel || 'site'}): ${main.link}`);
                let mainImageText = '';
                const mainImg = await resolveClipboardImage(main.previewSrc);
                if (mainImg.htmlSrc) {
                    mainImageText = '   Imagem: incorporada no conteúdo copiado.';
                } else if (mainImg.fallbackLink) {
                    mainImageText = `   Imagem: ${mainImg.fallbackLink}`;
                }
                if (mainImageText) lines.push(mainImageText);

                htmlParts.push(`<li style="margin-bottom:12px;padding:10px;border:1px solid #cbd5e1;border-radius:8px;background:#f8fafc;">`);
                htmlParts.push(`<div><strong>${escapeHtml(main.name || '(sem nome)')}</strong></div>`);
                htmlParts.push(`<div>Qtd: <strong>${escapeHtml(String(mainQty))}</strong> | Valor unit.: <strong>R$ ${escapeHtml(mainValueFormatted)}</strong> | Frete: <strong>R$ ${escapeHtml(mainFreightFormatted)}</strong> | Total pacote: <strong>R$ ${escapeHtml(toBrMoney(total))}</strong></div>`);
                if (main.link) htmlParts.push(`<div>Link: <a href="${escapeHtml(main.link)}" target="_blank" rel="noopener noreferrer">${escapeHtml(main.linkLabel || 'Abrir orçamento')}</a></div>`);
                if (mainImg.htmlSrc) {
                    htmlParts.push(`<div style="margin-top:6px;"><img src="${escapeHtml(mainImg.htmlSrc)}" alt="Orçamento" style="margin-top:4px;max-width:360px;max-height:180px;border:1px solid #cbd5e1;border-radius:6px;"></div>`);
                } else if (mainImg.fallbackLink) {
                    htmlParts.push(`<div style="margin-top:6px;"><a href="${escapeHtml(mainImg.fallbackLink)}" target="_blank" rel="noopener noreferrer">Imagem do orçamento</a></div>`);
                }

                if (subs.length) {
                    lines.push(`   Itens adicionais do pacote (suborçamentos): necessários à parte para compor este orçamento.`);
                    htmlParts.push(`<div style="margin-top:6px;color:#334155;"><em>Itens adicionais do pacote (suborçamentos): necessários à parte para compor este orçamento.</em></div>`);
                    htmlParts.push(`<ul style="margin-top:8px;padding-left:18px;">`);
                    for (const sub of subs) {
                        const subQty = parsePositiveInt(sub.quantity || '1');
                        const subValueFormatted = formatMoneyForCopy(sub.value);
                        const subFreightFormatted = formatMoneyForCopy(sub.freight);
                        lines.push(`   - ${sub.name || '(sem nome)'} | Qtd: ${subQty} | Valor unit.: R$ ${subValueFormatted} | Frete: R$ ${subFreightFormatted}`);
                        if (sub.link) lines.push(`     Link (${sub.linkLabel || 'site'}): ${sub.link}`);

                        htmlParts.push(`<li style="margin-bottom:8px;"><strong>${escapeHtml(sub.name || '(sem nome)')}</strong> - Qtd: ${escapeHtml(String(subQty))} | Valor unit.: R$ ${escapeHtml(subValueFormatted)} | Frete: R$ ${escapeHtml(subFreightFormatted)}`);
                        if (sub.link) htmlParts.push(`<br>Link: <a href="${escapeHtml(sub.link)}" target="_blank" rel="noopener noreferrer">${escapeHtml(sub.linkLabel || 'Abrir')}</a>`);
                        htmlParts.push(`</li>`);
                    }
                    htmlParts.push(`</ul>`);
                }

                htmlParts.push(`</li>`);
                if (i < mainItems.length - 1) {
                    lines.push('------------------------------------------------------------');
                }
            }

            htmlParts.push(`</ol></div>`);
            const payloadText = lines.join('\n').trim();
            const payloadHtml = htmlParts.join('');
            if (!payloadText) return;
            try {
                if (window.ClipboardItem && navigator.clipboard?.write) {
                    const clipItem = new ClipboardItem({
                        'text/plain': new Blob([payloadText], { type: 'text/plain' }),
                        'text/html': new Blob([payloadHtml], { type: 'text/html' }),
                    });
                    await navigator.clipboard.write([clipItem]);
                    alert('Orçamentos copiados com formatação para e-mail (HTML + texto).');
                } else {
                    await navigator.clipboard.writeText(payloadText);
                    alert('Orçamentos copiados em texto (seu navegador não suporta HTML no clipboard).');
                }
            } catch (err) {
                alert(`Falha ao copiar: ${err}`);
            }
        });

        copyWhatsAppBtn.addEventListener('click', () => {
            const reqText = (requestInput.value || '').trim();
            const reqTitle = (requisitionTitle.value || '').trim();
            const reqCode = modeInput.value === 'update'
                ? `TI - ${String(requisitionIdInput.value || '0').padStart(4, '0')}`
                : '(a definir após salvar)';
            const { mainItems, byParent } = collectBudgetData();

            const lines = [
                `*Requisição ${reqCode}*`,
                `${reqTitle || '(sem título)'}`,
                '',
                `*Necessidade:*`,
                `${reqText || '(sem texto)'}`,
                '',
                `*Orçamentos:*`,
            ];

            for (let i = 0; i < mainItems.length; i += 1) {
                const main = mainItems[i];
                const subs = byParent.get(main.idx) || [];
                const mainQty = parsePositiveInt(main.quantity || '1');
                let total = (mainQty * parseBrNumber(main.value)) + parseBrNumber(main.freight);
                for (const sub of subs) {
                    const subQty = parsePositiveInt(sub.quantity || '1');
                    total += (subQty * parseBrNumber(sub.value)) + parseBrNumber(sub.freight);
                }
                const mainValueFormatted = formatMoneyForCopy(main.value);
                const mainFreightFormatted = formatMoneyForCopy(main.freight);

                lines.push(`${i + 1}) *${main.name || '(sem nome)'}*`);
                lines.push(`   Qtd: ${mainQty} | Valor unit.: R$ ${mainValueFormatted} | Frete: R$ ${mainFreightFormatted}`);
                lines.push(`   Total do pacote: *R$ ${toBrMoney(total)}*`);
                if (main.link) lines.push(`   Link: ${main.linkLabel || 'site'} - ${main.link}`);

                if (subs.length) {
                    lines.push(`   Itens adicionais do pacote:`);
                    for (const sub of subs) {
                        const subQty = parsePositiveInt(sub.quantity || '1');
                        const subValueFormatted = formatMoneyForCopy(sub.value);
                        const subFreightFormatted = formatMoneyForCopy(sub.freight);
                        lines.push(`   - ${sub.name || '(sem nome)'} | Qtd: ${subQty} | R$ ${subValueFormatted} + frete R$ ${subFreightFormatted}`);
                        if (sub.link) lines.push(`     Link: ${sub.linkLabel || 'site'} - ${sub.link}`);
                    }
                }

                if (i < mainItems.length - 1) {
                    lines.push('');
                    lines.push('--------------------');
                }
            }

            const payload = lines.join('\n').trim();
            if (!payload) return;
            navigator.clipboard.writeText(payload)
                .then(() => alert('Texto para WhatsApp copiado.'))
                .catch((err) => alert(`Falha ao copiar: ${err}`));
        });

        form.addEventListener('submit', () => {
            if (!budgetList.querySelector('[data-budget-item]')) addBudgetItem();
        });
    })();
</script>

<script>
    (function () {
        const searchInput = document.querySelector('[data-req-search]');
        const statusSelect = document.querySelector('[data-req-status-filter]');
        const rows = Array.from(document.querySelectorAll('[data-req-row]'));
        if (!searchInput || !statusSelect || !rows.length) return;

        const normalize = (value) => (value || '').toString().trim().toLowerCase();

        const applyFilters = () => {
            const query = normalize(searchInput.value);
            const status = normalize(statusSelect.value);
            rows.forEach((row) => {
                const text = normalize(row.textContent);
                const rowStatus = normalize(row.dataset.status);
                const show = (!query || text.includes(query)) && (!status || rowStatus === status);
                row.style.display = show ? '' : 'none';
            });
        };

        searchInput.addEventListener('input', applyFilters);
        statusSelect.addEventListener('change', applyFilters);
    })();
</script>
{% endif %}
{% endblock %}


