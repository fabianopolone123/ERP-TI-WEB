{% extends "base.html" %}
{% load core_extras %}

{% block title %}Requisições | ERP TI{% endblock %}

{% block content %}
<div class="card">
    <div class="topbar">
        <div>
            <h2>Requisições</h2>
            {% if is_ti_group %}
            <p class="muted">Cadastro de requisição com múltiplos orçamentos.</p>
            {% else %}
            <p class="muted">Seu usuário não está no departamento TI.</p>
            {% endif %}
        </div>
        <form method="post" action="{% url 'logout' %}" class="inline-form">
            {% csrf_token %}
            <button type="submit">Sair</button>
        </form>
    </div>

    {% if is_ti_group %}
        {% include "core/_tabs.html" %}

        <div class="topbar" style="margin-top: 16px;">
            <h3>Requisições</h3>
            <button type="button" data-open-requisition>Nova requisição</button>
        </div>

        <div class="form-row" style="margin-bottom: 10px;">
            <div>
                <label for="id_req_search">Busca</label>
                <input id="id_req_search" type="text" placeholder="Pesquisar por requisição, orçamento ou status..." data-req-search />
            </div>
            <div>
                <label for="id_req_status_filter">Status</label>
                <select id="id_req_status_filter" data-req-status-filter>
                    <option value="">Todos</option>
                    <option value="pending_approval">Pendente de aprovação</option>
                    <option value="approved">Aprovado</option>
                    <option value="rejected">Reprovado</option>
                    <option value="received">Recebido</option>
                </select>
            </div>
        </div>

        <div style="overflow-x: auto;">
            <table class="data-table" data-table-name="requisicoes">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Título</th>
                        <th>Requisição</th>
                        <th>Status</th>
                        <th>Orçamentos</th>
                        <th>Total</th>
                        <th>Criado em</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in requisitions %}
                        <tr data-req-row data-status="{{ item.status }}" data-requisition-id="{{ item.id }}" style="cursor: pointer;">
                            <td data-sort-value="{{ item.id }}">{{ item.code }}</td>
                            <td>{{ item.title }}</td>
                            <td>
                                <div>{{ item.request }}</div>
                                {% if item.main_quotes %}
                                    <div class="muted" style="margin-top: 4px;">
                                        {% for quote in item.main_quotes %}
                                            <div style="margin-bottom: 6px;">
                                                {{ quote.name }} (R$ {{ quote.value|br_money }}{% if quote.freight %} + frete R$ {{ quote.freight|br_money }}{% endif %})
                                                {% if item.approved_quote_id == quote.id %}
                                                    <span class="status-pill status-approved" style="margin-left: 6px;">Aprovado</span>
                                                {% endif %}
                                                {% if quote.sub_items_count %}
                                                    <details style="margin-top: 4px;">
                                                        <summary>Suborçamentos ({{ quote.sub_items_count }})</summary>
                                                        <div style="margin-top: 4px; padding-left: 8px;">
                                                            {% for sub in quote.sub_items %}
                                                                <div>{{ sub.name }} (R$ {{ sub.value|br_money }}{% if sub.freight %} + frete R$ {{ sub.freight|br_money }}{% endif %})</div>
                                                            {% endfor %}
                                                        </div>
                                                    </details>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </td>
                            <td>
                                <span class="status-pill status-{{ item.status }}">{{ item.get_status_display }}</span>
                            </td>
                            <td data-sort-value="{{ item.main_quotes_count|default:0 }}">
                                {{ item.main_quotes_count|default:0 }}
                                {% if item.sub_quotes_count %}
                                    <div class="muted" style="font-size: 0.78rem;">{{ item.sub_quotes_count }} sub</div>
                                {% endif %}
                            </td>
                            <td data-sort-value="{% if item.quotes_total is not None %}{{ item.quotes_total|floatformat:2 }}{% else %}-1{% endif %}">
                                {% if item.quotes_total is not None %}
                                    R$ {{ item.quotes_total|br_money }}
                                {% else %}
                                    <span class="muted">Aguardando aprovação</span>
                                {% endif %}
                            </td>
                            <td data-sort-value="{{ item.created_at|date:'YmdHis' }}">{{ item.created_at|date:'d/m/Y H:i' }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="7" class="muted">Nenhuma requisição cadastrada.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>Solicite ao administrador a inclusão no departamento <strong>TI</strong>.</p>
    {% endif %}
</div>

{% if is_ti_group %}
<div class="modal" data-requisition-modal hidden>
    <div class="modal-backdrop" data-close-requisition></div>
    <div class="modal-content">
        <div class="topbar" style="margin-bottom: 8px;">
            <h3 data-requisition-modal-title>Nova requisição</h3>
            <button type="button" data-close-requisition>Fechar</button>
        </div>
        <form method="post" enctype="multipart/form-data" data-requisition-form>
            {% csrf_token %}
            <input type="hidden" name="mode" value="create" data-requisition-mode />
            <input type="hidden" name="requisition_id" value="" data-requisition-id-input />
            <div class="form-row">
                <div style="max-width: 520px;">
                    <label for="id_requisition_title">Título</label>
                    <input id="id_requisition_title" name="title" type="text" required placeholder="Ex.: Compra de monitores para TI" />
                </div>
            </div>
            <div class="form-row">
                <div style="flex: 1;">
                    <label for="id_request_text">Requisição</label>
                    <textarea id="id_request_text" name="request_text" rows="3" required placeholder="Descreva a necessidade da requisição..."></textarea>
                </div>
            </div>
            <div class="form-row">
                <div style="max-width: 320px;">
                    <label for="id_requisition_status">Status</label>
                    <select id="id_requisition_status" name="status">
                        <option value="pending_approval">Pendente de aprovação</option>
                        <option value="approved">Aprovado</option>
                        <option value="rejected">Reprovado</option>
                        <option value="received">Recebido</option>
                    </select>
                </div>
            </div>

            <div class="topbar" style="margin-top: 8px; margin-bottom: 8px;">
                <h4 style="margin: 0;">Orçamentos</h4>
                <div style="display: flex; gap: 8px;">
                    <button type="button" data-copy-budgets>Copiar orçamentos</button>
                    <button type="button" data-add-budget>Adicionar orçamento</button>
                </div>
            </div>

            <div data-budget-list style="display: grid; gap: 10px;"></div>

            <div class="modal" data-sub-budget-modal hidden>
                <div class="modal-backdrop" data-close-sub-budget></div>
                <div class="modal-content" style="width: min(980px, 96vw);">
                    <div class="topbar" style="margin-bottom: 8px;">
                        <h3 data-sub-budget-title>Suborçamentos</h3>
                        <div style="display: flex; gap: 8px;">
                            <button type="button" data-sub-budget-add>Adicionar sub orçamento</button>
                            <button type="button" data-close-sub-budget>Fechar</button>
                        </div>
                    </div>
                    <div class="muted" style="margin-bottom: 8px;">Edite os suborçamentos deste orçamento-mãe.</div>
                    <div data-sub-budget-empty class="muted">Nenhum suborçamento cadastrado.</div>
                    <div data-sub-budget-list style="display: grid; gap: 10px;"></div>
                </div>
            </div>

            <div style="margin-top: 14px;">
                <button type="submit">Salvar requisição</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" data-capture-modal hidden>
    <div class="modal-backdrop" data-capture-cancel></div>
    <div class="modal-content" style="width: min(1100px, 96vw);">
        <div class="topbar" style="margin-bottom: 8px;">
            <h3>Capturar orçamento (selecione uma área)</h3>
            <div style="display: flex; gap: 8px;">
                <button type="button" data-capture-confirm>Usar captura</button>
                <button type="button" data-capture-cancel>Cancelar</button>
            </div>
        </div>
        <div class="muted" style="margin-bottom: 8px;">
            Clique e arraste para selecionar a área desejada da imagem capturada.
        </div>
        <div style="position: relative; border: 1px solid #1f2a44; border-radius: 10px; overflow: auto; max-height: 70vh;">
            <canvas data-capture-canvas style="display: block; max-width: 100%; height: auto;"></canvas>
        </div>
    </div>
</div>

<div class="modal" data-image-viewer-modal hidden>
    <div class="modal-backdrop" data-close-image-viewer></div>
    <div class="modal-content" style="width: min(1200px, 96vw);">
        <div class="topbar" style="margin-bottom: 8px;">
            <h3>Foto do orçamento</h3>
            <button type="button" data-close-image-viewer>Fechar</button>
        </div>
        <div style="display: flex; justify-content: center; align-items: center; min-height: 220px;">
            <img data-image-viewer-src alt="Foto do orçamento" style="max-width: 100%; max-height: 78vh; border: 1px solid #1f2a44; border-radius: 10px;" />
        </div>
    </div>
</div>

<template id="budget-item-template">
    <div class="ticket-legend" data-budget-item>
        <input type="hidden" name="budget_index" data-budget-index />
        <input type="hidden" data-field="quote-id" />
        <input type="hidden" data-field="parent-idx" />
        <input type="hidden" data-field="parent-quote-id" />
        <div class="muted" data-parent-label style="margin-bottom: 6px; display: none;"></div>
        <div class="form-row">
            <div style="flex: 2;">
                <label>Nome do orçamento</label>
                <input type="text" data-field="name" required />
            </div>
            <div>
                <label>Valor</label>
                <input type="text" data-field="value" placeholder="Ex.: 18.652,22" required />
            </div>
            <div>
                <label>Frete</label>
                <input type="text" data-field="freight" placeholder="Ex.: 120,00" />
            </div>
            <div style="align-self: flex-end; display: flex; gap: 8px; flex-wrap: wrap;">
                <label style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border: 1px solid #166534; border-radius: 999px; background: rgba(34, 197, 94, 0.18); font-weight: 700; min-height: 40px;">
                    <input type="radio" data-field="approved" />
                    Aprovar
                </label>
                <button type="button" data-add-sub-budget>Suborçamentos (0)</button>
                <button type="button" data-remove-budget>Remover</button>
            </div>
        </div>
        <div class="form-row">
            <div style="flex: 2;">
                <label>Link</label>
                <input type="url" data-field="link" placeholder="https://..." />
            </div>
            <div style="flex: 2;">
                <label>Foto</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="file" accept="image/*" data-field="photo" />
                    <button type="button" data-capture-budget>Capturar</button>
                </div>
                <div style="margin-top: 8px;">
                    <img data-photo-preview alt="Preview" style="max-height: 90px; display: none; border: 1px solid #1f2a44; border-radius: 6px;" />
                </div>
            </div>
        </div>
        <div class="muted" data-budget-created-at style="margin-top: 6px; font-size: 0.82rem;">
            Cadastrado em: novo (data/hora atual ao salvar)
        </div>
        <div class="muted" data-budget-package-total style="margin-top: 4px; font-size: 0.82rem; font-weight: 700;">
            Total deste orçamento: R$ 0,00
        </div>
    </div>
</template>

<script>
    (function () {
        const requisitionData = {
            {% for item in requisitions %}
            "{{ item.id }}": {
                id: {{ item.id }},
                code: "{{ item.code|escapejs }}",
                title: "{{ item.title|escapejs }}",
                request: "{{ item.request|escapejs }}",
                status: "{{ item.status|escapejs }}",
                quotes: [
                    {% for quote in item.quotes.all %}
                    {
                        id: {{ quote.id }},
                        parent_id: {% if quote.parent_id %}{{ quote.parent_id }}{% else %}null{% endif %},
                        parent_name: "{% if quote.parent %}{{ quote.parent.name|escapejs }}{% endif %}",
                        name: "{{ quote.name|escapejs }}",
                        value: "{{ quote.value|floatformat:2|escapejs }}",
                        freight: "{{ quote.freight|floatformat:2|escapejs }}",
                        is_selected: {% if quote.is_selected %}true{% else %}false{% endif %},
                        link: "{{ quote.link|escapejs }}",
                        created_at: "{{ quote.created_at|date:'d/m/Y H:i'|escapejs }}",
                        photo_url: "{% if quote.photo %}{{ quote.photo.url|escapejs }}{% endif %}",
                    }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        };

        const modal = document.querySelector('[data-requisition-modal]');
        const openBtn = document.querySelector('[data-open-requisition]');
        const closeEls = document.querySelectorAll('[data-close-requisition]');
        const modalTitle = document.querySelector('[data-requisition-modal-title]');
        const modeInput = document.querySelector('[data-requisition-mode]');
        const requisitionIdInput = document.querySelector('[data-requisition-id-input]');
        const requisitionStatus = document.querySelector('#id_requisition_status');
        const requisitionTitle = document.querySelector('#id_requisition_title');
        const addBtn = document.querySelector('[data-add-budget]');
        const copyBtn = document.querySelector('[data-copy-budgets]');
        const budgetList = document.querySelector('[data-budget-list]');
        const subBudgetModal = document.querySelector('[data-sub-budget-modal]');
        const subBudgetTitle = document.querySelector('[data-sub-budget-title]');
        const subBudgetList = document.querySelector('[data-sub-budget-list]');
        const subBudgetEmpty = document.querySelector('[data-sub-budget-empty]');
        const subBudgetAddBtn = document.querySelector('[data-sub-budget-add]');
        const closeSubBudgetEls = document.querySelectorAll('[data-close-sub-budget]');
        const form = document.querySelector('[data-requisition-form]');
        const requestInput = document.querySelector('#id_request_text');
        const template = document.querySelector('#budget-item-template');

        const captureModal = document.querySelector('[data-capture-modal]');
        const captureCanvas = document.querySelector('[data-capture-canvas]');
        const captureConfirmBtn = document.querySelector('[data-capture-confirm]');
        const captureCancelEls = document.querySelectorAll('[data-capture-cancel]');
        const imageViewerModal = document.querySelector('[data-image-viewer-modal]');
        const imageViewer = document.querySelector('[data-image-viewer-src]');
        const closeImageViewerEls = document.querySelectorAll('[data-close-image-viewer]');

        if (!modal || !openBtn || !budgetList || !template || !form || !modeInput || !requisitionIdInput || !requisitionStatus || !requisitionTitle || !subBudgetModal || !subBudgetTitle || !subBudgetList || !subBudgetEmpty || !subBudgetAddBtn) return;

        let budgetIndex = 0;
        let captureTargetInput = null;
        let captureTargetPreview = null;
        let captureImage = null;
        let selection = null;
        let dragging = false;
        let startX = 0;
        let startY = 0;
        let activeSubBudgetParent = null;

        const openImageViewer = (src) => {
            if (!imageViewerModal || !imageViewer || !src) return;
            imageViewer.src = src;
            imageViewerModal.hidden = false;
        };

        const closeImageViewer = () => {
            if (!imageViewerModal || !imageViewer) return;
            imageViewerModal.hidden = true;
            imageViewer.removeAttribute('src');
        };

        closeImageViewerEls.forEach((el) => el.addEventListener('click', closeImageViewer));
        closeSubBudgetEls.forEach((el) => el.addEventListener('click', () => closeSubBudgetModal()));

        subBudgetAddBtn.addEventListener('click', () => {
            if (!activeSubBudgetParent) return;
            const parentIdx = itemIdx(activeSubBudgetParent);
            const parentQuoteId = (activeSubBudgetParent.querySelector('[data-field="quote-id"]')?.value || '').trim();
            const parentName = (activeSubBudgetParent.querySelector('[data-field="name"]')?.value || '').trim() || `Orcamento ${parentIdx}`;
            const created = addBudgetItem(null, {
                idx: parentIdx,
                quoteId: parentQuoteId,
                name: parentName,
            });
            if (created?.item) {
                created.item.style.display = '';
                subBudgetList.appendChild(created.item);
                updateSubBudgetEmptyState();
                recalculateBudgetPackages();
            }
        });

        const getDisplayStream = async () => {
            const constraints = { video: true, audio: false };
            if (navigator.mediaDevices && typeof navigator.mediaDevices.getDisplayMedia === 'function') {
                return navigator.mediaDevices.getDisplayMedia(constraints);
            }
            if (typeof navigator.getDisplayMedia === 'function') {
                return navigator.getDisplayMedia(constraints);
            }
            throw new Error('API de captura indisponível neste navegador/contexto.');
        };

        const clearBudgetItems = () => {
            closeSubBudgetModal();
            budgetList.innerHTML = '';
            subBudgetList.innerHTML = '';
            updateSubBudgetEmptyState();
        };

        const toBrValue = (value) => {
            const raw = (value || '').toString();
            const n = Number(raw);
            if (Number.isNaN(n)) return raw;
            return n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        const parseBrNumber = (value) => {
            const raw = (value || '').toString().trim().replace(/\s/g, '');
            if (!raw) return 0;
            let normalized = raw;
            if (normalized.includes(',') && normalized.includes('.')) {
                if (normalized.lastIndexOf(',') > normalized.lastIndexOf('.')) {
                    normalized = normalized.replace(/\./g, '').replace(',', '.');
                } else {
                    normalized = normalized.replace(/,/g, '');
                }
            } else if (normalized.includes(',')) {
                normalized = normalized.replace(/\./g, '').replace(',', '.');
            }
            const n = Number(normalized);
            return Number.isFinite(n) ? n : 0;
        };

        const toBrMoney = (value) => value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        const allBudgetItems = () => Array.from(form.querySelectorAll('[data-budget-item]'));
        const itemIdx = (item) => (item.querySelector('[data-budget-index]')?.value || '').trim();
        const itemParentIdx = (item) => (item.querySelector('[data-field="parent-idx"]')?.value || '').trim();

        const recalculateBudgetPackages = () => {
            const items = allBudgetItems();
            const subsByParent = new Map();
            items.forEach((item) => {
                const p = itemParentIdx(item);
                if (!p) return;
                if (!subsByParent.has(p)) subsByParent.set(p, []);
                subsByParent.get(p).push(item);
            });

            items.forEach((mainItem) => {
                const mainIdx = itemIdx(mainItem);
                if (!mainIdx || itemParentIdx(mainItem)) return;
                const packageEl = mainItem.querySelector('[data-budget-package-total]');
                if (!packageEl) return;

                let total = 0;
                const mainValue = parseBrNumber(mainItem.querySelector('[data-field="value"]')?.value || '');
                const mainFreight = parseBrNumber(mainItem.querySelector('[data-field="freight"]')?.value || '');
                total += mainValue + mainFreight;

                const subItems = subsByParent.get(mainIdx) || [];
                subItems.forEach((subItem) => {
                    total += parseBrNumber(subItem.querySelector('[data-field="value"]')?.value || '');
                    total += parseBrNumber(subItem.querySelector('[data-field="freight"]')?.value || '');
                });
                packageEl.textContent = `Total deste orçamento: R$ ${toBrMoney(total)}`;
            });
        };

        const updateSubBudgetEmptyState = () => {
            subBudgetEmpty.style.display = subBudgetList.querySelector('[data-budget-item]') ? 'none' : '';
        };

        const moveSubItemsBackToMainList = () => {
            const moved = Array.from(subBudgetList.querySelectorAll('[data-budget-item]'));
            if (!moved.length) return;
            if (activeSubBudgetParent && activeSubBudgetParent.isConnected) {
                let anchor = activeSubBudgetParent;
                moved.forEach((item) => {
                    anchor.insertAdjacentElement('afterend', item);
                    anchor = item;
                });
            } else {
                moved.forEach((item) => budgetList.appendChild(item));
            }
        };

        const closeSubBudgetModal = () => {
            moveSubItemsBackToMainList();
            subBudgetModal.hidden = true;
            activeSubBudgetParent = null;
            updateSubBudgetEmptyState();
            applySubBudgetVisibility();
        };

        const openSubBudgetModal = (parentItem) => {
            moveSubItemsBackToMainList();
            activeSubBudgetParent = parentItem;
            const parentName = (parentItem.querySelector('[data-field="name"]')?.value || '').trim() || 'Orçamento';
            const parentIdx = itemIdx(parentItem);
            subBudgetTitle.textContent = `Suborçamentos - ${parentName}`;
            subBudgetModal.hidden = false;

            const subItems = allBudgetItems().filter((item) => itemParentIdx(item) === parentIdx);
            subItems.forEach((item) => {
                item.style.display = '';
                subBudgetList.appendChild(item);
            });
            updateSubBudgetEmptyState();
            recalculateBudgetPackages();
        };

        const applySubBudgetVisibility = () => {
            const items = allBudgetItems();
            const subsByParent = new Map();
            items.forEach((item) => {
                const p = itemParentIdx(item);
                if (!p) return;
                if (!subsByParent.has(p)) subsByParent.set(p, []);
                subsByParent.get(p).push(item);
            });

            items.forEach((mainItem) => {
                const mainIdx = itemIdx(mainItem);
                if (!mainIdx || itemParentIdx(mainItem)) return;
                const subBtn = mainItem.querySelector('[data-add-sub-budget]');
                if (!subBtn) return;
                const subItems = subsByParent.get(mainIdx) || [];
                subBtn.textContent = `Suborçamentos (${subItems.length})`;
                subItems.forEach((subItem) => {
                    const inOpenModal = !subBudgetModal.hidden && activeSubBudgetParent && itemIdx(activeSubBudgetParent) === mainIdx && subBudgetList.contains(subItem);
                    subItem.style.display = inOpenModal ? '' : 'none';
                });
            });

            recalculateBudgetPackages();
        };

        const setBudgetFieldNames = (item, idx) => {
            item.querySelector('[data-budget-index]').value = String(idx);
            item.querySelector('[data-field="quote-id"]').name = `budget_quote_id_${idx}`;
            item.querySelector('[data-field="parent-idx"]').name = `budget_parent_idx_${idx}`;
            item.querySelector('[data-field="parent-quote-id"]').name = `budget_parent_quote_id_${idx}`;
            item.querySelector('[data-field="name"]').name = `budget_name_${idx}`;
            item.querySelector('[data-field="value"]').name = `budget_value_${idx}`;
            item.querySelector('[data-field="freight"]').name = `budget_freight_${idx}`;
            item.querySelector('[data-field="link"]').name = `budget_link_${idx}`;
            item.querySelector('[data-field="photo"]').name = `budget_photo_${idx}`;
            item.querySelector('[data-field="approved"]').name = 'approved_budget_idx';
            item.querySelector('[data-field="approved"]').value = String(idx);
        };

        const addBudgetItem = (initialData = null, parentMeta = null) => {
            const fragment = template.content.cloneNode(true);
            const item = fragment.querySelector('[data-budget-item]');
            const idx = ++budgetIndex;
            setBudgetFieldNames(item, idx);

            const quoteIdInput = item.querySelector('[data-field="quote-id"]');
            const parentIdxInput = item.querySelector('[data-field="parent-idx"]');
            const parentQuoteIdInput = item.querySelector('[data-field="parent-quote-id"]');
            const parentLabel = item.querySelector('[data-parent-label]');
            const nameInput = item.querySelector('[data-field="name"]');
            const valueInput = item.querySelector('[data-field="value"]');
            const freightInput = item.querySelector('[data-field="freight"]');
            const linkInput = item.querySelector('[data-field="link"]');
            const createdAtEl = item.querySelector('[data-budget-created-at]');
            const packageTotalEl = item.querySelector('[data-budget-package-total]');
            const removeBtn = item.querySelector('[data-remove-budget]');
            const addSubBtn = item.querySelector('[data-add-sub-budget]');
            const approvedInput = item.querySelector('[data-field="approved"]');
            const captureBtn = item.querySelector('[data-capture-budget]');
            const photoInput = item.querySelector('[data-field="photo"]');
            const preview = item.querySelector('[data-photo-preview]');

            const clearAsParent = (removedIdx) => {
                budgetList.querySelectorAll('[data-budget-item]').forEach((other) => {
                    const otherParentIdx = other.querySelector('[data-field="parent-idx"]');
                    const otherParentQuoteId = other.querySelector('[data-field="parent-quote-id"]');
                    const otherLabel = other.querySelector('[data-parent-label]');
                    const otherApproved = other.querySelector('[data-field="approved"]');
                    const otherPackageTotal = other.querySelector('[data-budget-package-total]');
                    if (!otherParentIdx || !otherParentQuoteId || !otherLabel) return;
                    if (otherParentIdx.value === String(removedIdx)) {
                        otherParentIdx.value = '';
                        otherParentQuoteId.value = '';
                        otherLabel.style.display = 'none';
                        otherLabel.textContent = '';
                        other.style.marginLeft = '';
                        other.style.borderLeft = '';
                        other.style.display = '';
                        if (otherApproved) {
                            otherApproved.disabled = false;
                        }
                        if (otherPackageTotal) {
                            otherPackageTotal.style.display = '';
                        }
                    }
                });
            };

            preview.style.cursor = 'zoom-in';
            preview.addEventListener('click', () => {
                const src = preview.getAttribute('src') || '';
                if (!src || preview.style.display === 'none') return;
                openImageViewer(src);
            });

            removeBtn.addEventListener('click', () => {
                if (budgetList.querySelectorAll('[data-budget-item]').length <= 1) return;
                clearAsParent(idx);
                item.remove();
                applySubBudgetVisibility();
            });

            addSubBtn.addEventListener('click', () => {
                if (parentMeta) {
                    return;
                }
                openSubBudgetModal(item);
            });

            if (parentMeta) {
                parentIdxInput.value = String(parentMeta.idx || '');
                parentQuoteIdInput.value = parentMeta.quoteId || '';
                if (parentLabel) {
                    parentLabel.textContent = `Suborcamento de: ${parentMeta.name || 'Orcamento principal'}`;
                    parentLabel.style.display = '';
                }
                item.style.marginLeft = '28px';
                item.style.borderLeft = '3px solid #334155';
                if (approvedInput) {
                    approvedInput.checked = false;
                    approvedInput.disabled = true;
                }
                if (addSubBtn) {
                    addSubBtn.style.display = 'none';
                }
                if (packageTotalEl) {
                    packageTotalEl.style.display = 'none';
                }
            } else {
                parentIdxInput.value = '';
                parentQuoteIdInput.value = '';
                if (approvedInput) {
                    approvedInput.disabled = false;
                }
                if (packageTotalEl) {
                    packageTotalEl.style.display = '';
                }
                if (addSubBtn) {
                    addSubBtn.style.display = '';
                }
            }

            if (initialData) {
                quoteIdInput.value = initialData.id ? String(initialData.id) : '';
                nameInput.value = initialData.name || '';
                valueInput.value = toBrValue(initialData.value || '');
                freightInput.value = toBrValue(initialData.freight || '');
                linkInput.value = initialData.link || '';
                if (approvedInput) {
                    approvedInput.checked = !!initialData.is_selected && !initialData.parent_id;
                }
                if (createdAtEl) {
                    createdAtEl.textContent = `Cadastrado em: ${initialData.created_at || 'data indisponível'}`;
                }
                if (initialData.photo_url) {
                    preview.src = initialData.photo_url;
                    preview.style.display = 'block';
                }
            }

            photoInput.addEventListener('change', () => {
                const file = photoInput.files && photoInput.files[0];
                if (!file) {
                    if (!initialData || !initialData.photo_url) {
                        preview.style.display = 'none';
                        preview.removeAttribute('src');
                    }
                    return;
                }
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
            });

            [valueInput, freightInput].forEach((el) => {
                if (!el) return;
                el.addEventListener('input', recalculateBudgetPackages);
                el.addEventListener('change', recalculateBudgetPackages);
            });

            captureBtn.addEventListener('click', async () => {
                try {
                    const stream = await getDisplayStream();
                    const video = document.createElement('video');
                    video.srcObject = stream;
                    await video.play();

                    const w = video.videoWidth || 1280;
                    const h = video.videoHeight || 720;
                    const tmpCanvas = document.createElement('canvas');
                    tmpCanvas.width = w;
                    tmpCanvas.height = h;
                    const tmpCtx = tmpCanvas.getContext('2d');
                    tmpCtx.drawImage(video, 0, 0, w, h);

                    stream.getTracks().forEach((t) => t.stop());
                    video.srcObject = null;

                    captureImage = new Image();
                    captureImage.onload = () => {
                        captureCanvas.width = captureImage.width;
                        captureCanvas.height = captureImage.height;
                        const ctx = captureCanvas.getContext('2d');
                        ctx.drawImage(captureImage, 0, 0);
                        selection = null;
                        captureTargetInput = photoInput;
                        captureTargetPreview = preview;
                        captureModal.hidden = false;
                    };
                    captureImage.src = tmpCanvas.toDataURL('image/png');
                } catch (err) {
                    const secureHint = window.isSecureContext
                        ? ''
                        : ' Abra por https:// ou http://localhost para permitir captura.';
                    alert(`Não foi possível capturar a tela: ${err}.${secureHint} Vou abrir seleção de arquivo como alternativa.`);
                    photoInput.click();
                }
            });

            budgetList.appendChild(item);
            applySubBudgetVisibility();
            return { idx, item };
        };

        const drawCapture = () => {
            if (!captureImage) return;
            const ctx = captureCanvas.getContext('2d');
            ctx.clearRect(0, 0, captureCanvas.width, captureCanvas.height);
            ctx.drawImage(captureImage, 0, 0);

            if (selection && selection.w > 0 && selection.h > 0) {
                ctx.save();
                ctx.strokeStyle = '#22c55e';
                ctx.lineWidth = 2;
                ctx.setLineDash([8, 4]);
                ctx.strokeRect(selection.x, selection.y, selection.w, selection.h);
                ctx.fillStyle = 'rgba(34, 197, 94, 0.15)';
                ctx.fillRect(selection.x, selection.y, selection.w, selection.h);
                ctx.restore();
            }
        };

        const toCanvasCoordinates = (event) => {
            const rect = captureCanvas.getBoundingClientRect();
            const scaleX = captureCanvas.width / rect.width;
            const scaleY = captureCanvas.height / rect.height;
            return {
                x: Math.max(0, Math.min(captureCanvas.width, (event.clientX - rect.left) * scaleX)),
                y: Math.max(0, Math.min(captureCanvas.height, (event.clientY - rect.top) * scaleY)),
            };
        };

        captureCanvas.addEventListener('mousedown', (event) => {
            if (!captureImage) return;
            dragging = true;
            const p = toCanvasCoordinates(event);
            startX = p.x;
            startY = p.y;
            selection = { x: p.x, y: p.y, w: 0, h: 0 };
            drawCapture();
        });

        captureCanvas.addEventListener('mousemove', (event) => {
            if (!dragging || !captureImage) return;
            const p = toCanvasCoordinates(event);
            const x = Math.min(startX, p.x);
            const y = Math.min(startY, p.y);
            const w = Math.abs(p.x - startX);
            const h = Math.abs(p.y - startY);
            selection = { x, y, w, h };
            drawCapture();
        });

        window.addEventListener('mouseup', () => {
            dragging = false;
        });

        const closeCapture = () => {
            captureModal.hidden = true;
            captureImage = null;
            selection = null;
            captureTargetInput = null;
            captureTargetPreview = null;
        };

        captureCancelEls.forEach((el) => el.addEventListener('click', closeCapture));

        captureConfirmBtn.addEventListener('click', () => {
            if (!captureImage || !captureTargetInput) return;
            let crop = selection;
            if (!crop || crop.w < 4 || crop.h < 4) {
                crop = { x: 0, y: 0, w: captureCanvas.width, h: captureCanvas.height };
            }
            const out = document.createElement('canvas');
            out.width = Math.floor(crop.w);
            out.height = Math.floor(crop.h);
            const outCtx = out.getContext('2d');
            outCtx.drawImage(
                captureCanvas,
                crop.x,
                crop.y,
                crop.w,
                crop.h,
                0,
                0,
                out.width,
                out.height
            );
            out.toBlob((blob) => {
                if (!blob) return;
                const file = new File([blob], `captura-${Date.now()}.png`, { type: 'image/png' });
                const dt = new DataTransfer();
                dt.items.add(file);
                captureTargetInput.files = dt.files;
                captureTargetPreview.src = URL.createObjectURL(file);
                captureTargetPreview.style.display = 'block';
                closeCapture();
            }, 'image/png');
        });

        const openCreate = () => {
            closeSubBudgetModal();
            modeInput.value = 'create';
            requisitionIdInput.value = '';
            modalTitle.textContent = 'Nova requisição';
            requisitionTitle.value = '';
            requestInput.value = '';
            requisitionStatus.value = 'pending_approval';
            clearBudgetItems();
            budgetIndex = 0;
            addBudgetItem();
            modal.hidden = false;
        };

        const openEdit = (id) => {
            closeSubBudgetModal();
            const data = requisitionData[String(id)];
            if (!data) return;
            modeInput.value = 'update';
            requisitionIdInput.value = String(data.id);
            modalTitle.textContent = `Editar requisição ${data.code || ('TI - ' + String(data.id).padStart(4, '0'))}`;
            requisitionTitle.value = data.title || '';
            requestInput.value = data.request || '';
            requisitionStatus.value = data.status || 'pending_approval';
            clearBudgetItems();
            budgetIndex = 0;
            if (Array.isArray(data.quotes) && data.quotes.length) {
                const byId = {};
                const byQuoteIdToIdx = {};
                const pending = [...data.quotes];
                let guard = 0;
                while (pending.length && guard < 500) {
                    guard += 1;
                    let progressed = false;
                    for (let i = pending.length - 1; i >= 0; i -= 1) {
                        const q = pending[i];
                        const parentId = q.parent_id;
                        if (!parentId || byQuoteIdToIdx[parentId]) {
                            const parentMeta = parentId
                                ? byQuoteIdToIdx[parentId]
                                : null;
                            const created = addBudgetItem(q, parentMeta);
                            byId[q.id] = created;
                            byQuoteIdToIdx[q.id] = {
                                idx: created.idx,
                                quoteId: String(q.id),
                                name: q.name || `Orcamento ${created.idx}`,
                            };
                            pending.splice(i, 1);
                            progressed = true;
                        }
                    }
                    if (!progressed) {
                        const q = pending.shift();
                        const created = addBudgetItem(q, null);
                        byId[q.id] = created;
                        byQuoteIdToIdx[q.id] = {
                            idx: created.idx,
                            quoteId: String(q.id),
                            name: q.name || `Orcamento ${created.idx}`,
                        };
                    }
                }
            } else {
                addBudgetItem();
            }
            modal.hidden = false;
        };

        const close = () => {
            closeSubBudgetModal();
            modal.hidden = true;
        };

        openBtn.addEventListener('click', openCreate);
        closeEls.forEach((el) => el.addEventListener('click', close));
        addBtn.addEventListener('click', addBudgetItem);

        document.querySelectorAll('[data-req-row]').forEach((row) => {
            row.addEventListener('click', () => {
                const id = row.getAttribute('data-requisition-id');
                if (!id) return;
                openEdit(id);
            });
        });

        copyBtn.addEventListener('click', async () => {
            const reqText = (requestInput.value || '').trim();
            const reqTitle = (requisitionTitle.value || '').trim();
            const reqCode = modeInput.value === 'update'
                ? `TI - ${String(requisitionIdInput.value || '0').padStart(4, '0')}`
                : '(a definir após salvar)';
            const lines = [];
            lines.push(`Código: ${reqCode}`);
            lines.push(`Título: ${reqTitle || '(sem título)'}`);
            lines.push(`Requisição: ${reqText || '(sem texto)'}`);
            lines.push('');
            lines.push('Orçamentos:');
            const items = Array.from(budgetList.querySelectorAll('[data-budget-item]'));
            items.forEach((item, i) => {
                const name = (item.querySelector('[data-field="name"]').value || '').trim();
                const value = (item.querySelector('[data-field="value"]').value || '').trim();
                const freight = (item.querySelector('[data-field="freight"]').value || '').trim();
                const link = (item.querySelector('[data-field="link"]').value || '').trim();
                const parentIdx = (item.querySelector('[data-field="parent-idx"]')?.value || '').trim();
                const createdAt = (item.querySelector('[data-budget-created-at]')?.textContent || '').trim();
                if (!name && !value && !freight && !link) return;
                const prefix = parentIdx ? 'SUB' : String(i + 1);
                lines.push(`${prefix}. ${name || '(sem nome)'} - R$ ${value || '0,00'} | Frete: R$ ${freight || '0,00'}`);
                if (createdAt) lines.push(`   ${createdAt}`);
                if (link) lines.push(`   Link: ${link}`);
            });
            const payload = lines.join('\n').trim();
            if (!payload) return;
            try {
                await navigator.clipboard.writeText(payload);
                alert('Orçamentos copiados para a área de transferência.');
            } catch (err) {
                alert(`Falha ao copiar: ${err}`);
            }
        });

        form.addEventListener('submit', () => {
            if (!budgetList.querySelector('[data-budget-item]')) addBudgetItem();
        });
    })();
</script>

<script>
    (function () {
        const searchInput = document.querySelector('[data-req-search]');
        const statusSelect = document.querySelector('[data-req-status-filter]');
        const rows = Array.from(document.querySelectorAll('[data-req-row]'));
        if (!searchInput || !statusSelect || !rows.length) return;

        const normalize = (value) => (value || '').toString().trim().toLowerCase();

        const applyFilters = () => {
            const query = normalize(searchInput.value);
            const status = normalize(statusSelect.value);
            rows.forEach((row) => {
                const text = normalize(row.textContent);
                const rowStatus = normalize(row.dataset.status);
                const show = (!query || text.includes(query)) && (!status || rowStatus === status);
                row.style.display = show ? '' : 'none';
            });
        };

        searchInput.addEventListener('input', applyFilters);
        statusSelect.addEventListener('change', applyFilters);
    })();
</script>
{% endif %}
{% endblock %}

