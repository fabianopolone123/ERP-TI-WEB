{% extends "base.html" %}

{% block title %}Requisições | ERP TI{% endblock %}

{% block content %}
<div class="card">
    <div class="topbar">
        <div>
            <h2>Requisições</h2>
            {% if is_ti_group %}
            <p class="muted">Controle de solicitações, aprovações e recebimentos.</p>
            {% else %}
            <p class="muted">Seu usuário não está no departamento TI.</p>
            {% endif %}
        </div>
        <form method="post" action="{% url 'logout' %}" class="inline-form">
            {% csrf_token %}
            <button type="submit">Sair</button>
        </form>
    </div>

    {% if is_ti_group %}
        {% include "core/_tabs.html" %}

        <div class="topbar" style="margin-top: 16px;">
            <h3>Lista de requisições</h3>
            <button type="button" data-open-requisition>Novo registro</button>
        </div>

        <div class="form-row" style="margin-bottom: 10px;">
            <div>
                <label for="id_req_search">Busca</label>
                <input id="id_req_search" type="text" placeholder="Pesquisar por solicitação, NF, tipo, local..." data-req-search />
            </div>
            <div>
                <label for="id_req_type_filter">Tipo</label>
                <select id="id_req_type_filter" data-req-type-filter>
                    <option value="">Todos</option>
                    {% for item_type in types %}
                        <option value="{{ item_type }}">{{ item_type }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="id_req_location_filter">Local</label>
                <select id="id_req_location_filter" data-req-location-filter>
                    <option value="">Todos</option>
                    {% for item_location in locations %}
                        <option value="{{ item_location }}">{{ item_location }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="id_req_status_filter">Status</label>
                <select id="id_req_status_filter" data-req-status-filter>
                    <option value="">Todos</option>
                    <option value="aberto">Aberto</option>
                    <option value="requisitado">Requisitado</option>
                    <option value="aprovado">Aprovado</option>
                    <option value="recebido">Recebido</option>
                </select>
            </div>
        </div>

        <div style="overflow-x: auto;">
            <table class="data-table" data-table-name="requisicoes">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Solicitação</th>
                        <th>Qtd</th>
                        <th>Valor</th>
                        <th>Total</th>
                        <th>Requisitado</th>
                        <th>Aprovado</th>
                        <th>Recebido</th>
                        <th>NF</th>
                        <th>Aprovado2</th>
                        <th>Tipo</th>
                        <th>Local</th>
                        <th>Link</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in requisitions %}
                        <tr
                            data-req-row
                            data-type="{{ item.req_type|lower }}"
                            data-location="{{ item.location|lower }}"
                            data-status="{% if item.received_at %}recebido{% elif item.approved_at %}aprovado{% elif item.requested_at %}requisitado{% else %}aberto{% endif %}"
                        >
                            <td data-sort-value="{{ item.id }}">{{ item.id }}</td>
                            <td>{{ item.request }}</td>
                            <td data-sort-value="{{ item.quantity }}">{{ item.quantity }}</td>
                            <td data-sort-value="{{ item.unit_value|floatformat:2 }}">R$ {{ item.unit_value|floatformat:2 }}</td>
                            <td data-sort-value="{{ item.total_value|floatformat:2 }}">R$ {{ item.total_value|floatformat:2 }}</td>
                            <td data-sort-value="{{ item.requested_at|date:'Ymd' }}">{{ item.requested_at|date:'d/m/Y' }}</td>
                            <td data-sort-value="{{ item.approved_at|date:'Ymd' }}">{{ item.approved_at|date:'d/m/Y' }}</td>
                            <td data-sort-value="{{ item.received_at|date:'Ymd' }}">{{ item.received_at|date:'d/m/Y' }}</td>
                            <td>{{ item.invoice }}</td>
                            <td>{{ item.approved_by_2 }}</td>
                            <td>{{ item.req_type }}</td>
                            <td>{{ item.location }}</td>
                            <td>
                                {% if item.link %}
                                    <a href="{{ item.link }}" target="_blank" rel="noreferrer">Abrir</a>
                                {% else %}
                                    <span class="muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="13" class="muted">Nenhuma requisição cadastrada.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>Solicite ao administrador a inclusão no departamento <strong>TI</strong>.</p>
    {% endif %}
</div>

{% if is_ti_group %}
    <div class="modal" data-requisition-modal hidden>
        <div class="modal-backdrop" data-close-requisition></div>
        <div class="modal-content">
            <div class="topbar" style="margin-bottom: 8px;">
                <h3>Nova requisição</h3>
                <button type="button" data-close-requisition>Fechar</button>
            </div>
            <form method="post">
                {% csrf_token %}
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_request">Solicitação</label>
                        <input id="id_request" name="request" type="text" required />
                    </div>
                    <div>
                        <label for="id_quantity">Qtd</label>
                        <input id="id_quantity" name="quantity" type="number" min="1" step="1" value="1" required />
                    </div>
                    <div>
                        <label for="id_unit_value">Valor</label>
                        <input id="id_unit_value" name="unit_value" type="number" min="0" step="0.01" value="0.00" required />
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="id_requested_at">Requisitado</label>
                        <input id="id_requested_at" name="requested_at" type="date" />
                    </div>
                    <div>
                        <label for="id_approved_at">Aprovado</label>
                        <input id="id_approved_at" name="approved_at" type="date" />
                    </div>
                    <div>
                        <label for="id_received_at">Recebido</label>
                        <input id="id_received_at" name="received_at" type="date" />
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="id_invoice">NF</label>
                        <input id="id_invoice" name="invoice" type="text" />
                    </div>
                    <div>
                        <label for="id_approved_by_2">Aprovado2</label>
                        <input id="id_approved_by_2" name="approved_by_2" type="text" />
                    </div>
                    <div>
                        <label for="id_req_type">Tipo</label>
                        <input id="id_req_type" name="req_type" type="text" />
                    </div>
                    <div>
                        <label for="id_location">Local</label>
                        <input id="id_location" name="location" type="text" />
                    </div>
                </div>
                <div class="form-row">
                    <div style="flex: 2;">
                        <label for="id_link">Link</label>
                        <input id="id_link" name="link" type="url" placeholder="https://..." />
                    </div>
                </div>
                <button type="submit">Salvar</button>
            </form>
        </div>
    </div>

    <script>
        (function () {
            const modal = document.querySelector('[data-requisition-modal]');
            const openBtn = document.querySelector('[data-open-requisition]');
            const closeEls = document.querySelectorAll('[data-close-requisition]');
            if (!modal || !openBtn) return;

            openBtn.addEventListener('click', () => { modal.hidden = false; });
            closeEls.forEach((el) => el.addEventListener('click', () => { modal.hidden = true; }));
        })();
    </script>

    <script>
        (function () {
            const searchInput = document.querySelector('[data-req-search]');
            const typeSelect = document.querySelector('[data-req-type-filter]');
            const locationSelect = document.querySelector('[data-req-location-filter]');
            const statusSelect = document.querySelector('[data-req-status-filter]');
            const rows = Array.from(document.querySelectorAll('[data-req-row]'));
            if (!rows.length || !searchInput || !typeSelect || !locationSelect || !statusSelect) return;

            const normalize = (value) => (value || '').toString().trim().toLowerCase();

            const applyFilters = () => {
                const q = normalize(searchInput.value);
                const type = normalize(typeSelect.value);
                const location = normalize(locationSelect.value);
                const status = normalize(statusSelect.value);

                rows.forEach((row) => {
                    const text = normalize(row.textContent);
                    const rowType = normalize(row.dataset.type);
                    const rowLocation = normalize(row.dataset.location);
                    const rowStatus = normalize(row.dataset.status);
                    const show =
                        (!q || text.includes(q)) &&
                        (!type || rowType === type) &&
                        (!location || rowLocation === location) &&
                        (!status || rowStatus === status);
                    row.style.display = show ? '' : 'none';
                });
            };

            searchInput.addEventListener('input', applyFilters);
            typeSelect.addEventListener('change', applyFilters);
            locationSelect.addEventListener('change', applyFilters);
            statusSelect.addEventListener('change', applyFilters);
        })();
    </script>
{% endif %}
{% endblock %}
